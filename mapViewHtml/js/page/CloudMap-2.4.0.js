

/*
CloudMap-2.4.0 code for exsun

Copyright©2015-2018 武汉依迅北斗空间技术有限公司 All Rights Reserved.

http://www.exsun.cn
*/

!function(t,o,e,i){ES.CloudMap={version:"1.0.1"},ES.CloudMap.Page=ES.Page.extend({initialize:function(t,o){ES.Page.prototype.initialize.call(this,t,o),this.cFlag="Grid"},setFlag:function(t){this.cFlag=t},getFlag:function(){return this.cFlag},getPosByLatLng:function(t){return this._oMap&&t?this._oMap.latLngToLayerPoint(t):null}}),e.extend(e.Edit.PolyVerticesEdit,{_createMarker:function(t,o){var i=!0;t.alt&&(i=!1);var a=new e.Marker.Touch(t,{draggable:i,icon:this.options.icon});return a._origLatLng=t,a._index=o,i&&a.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._fireEdit,this),this._markerGroup.addLayer(a),a}}),ES.CloudMap.LayoutContent=ES.Evented.extend({cHTML:'<div class="ex-layout-content"></div>',oOption:{cPContainer:".ex-layout-main"},initialize:function(t,o){ES.setOptions(this,o),this._oParent=t,this.initUI(),this.initOn()},initOn:function(){this._oParent.on("MapView:LayoutContent.resize",this.resize,this)},resize:function(t){t.nWidth&&this.$_oContainer.css({width:t.nWidth}),t.nHeight&&this.$_oContainer.css({height:t.nHeight})},reflesh:function(t,o){this.$_oContainer.css({width:t,height:o})},initUI:function(){this.$_oContainer=i(this.cHTML),i(this.oOption.cPContainer).append(this.$_oContainer),this.$_oContainer.css({width:this.oOption.nWidth,height:this.oOption.nHeight})}}),ES.CloudMap.BaseTool=ES.Evented.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" ><i class="ec-icon-dot-circle-o"></i></button><p>删除</p></li>',initialize:function(t,o){ES.setOptions(this,o),this._oParent=t,this._oPage=t._oParent,this._oMap=this._oPage.getMap(),this.initUI(),this.initOn()},initUI:function(){this.$_oLi=i(this.cHtml),this.setParentEvent()},setParentEvent:function(){e.DomEvent.addListener(this.$_oLi.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oLi.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oLi.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oLi.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oLi.get(0),"touchmove",e.DomEvent.stopPropagation)},removeActive:function(){this.$_oLi.find("button").removeClass("ec-active")},addActive:function(){this.$_oLi.find("button").addClass("ec-active")},getActive:function(){return!!this.$_oLi.find("button").hasClass("ec-active")},initOn:function(){this._oParent.on("CloudMap:BaseTool.removeActive",this.removeActive,this),this._oParent.on("CloudMap:BaseTool.setActive",this.addActive,this)},bandClick:function(){var t=this;this.$_oLi.find("button").bind("click",function(){t._oParent.fire("CloudMap:BaseTool.removeActive"),t.addActive()})}}),ES.CloudMap.CalEditTool=ES.CloudMap.BaseTool.extend({cHtml:'<li>   <button class="ec-btn ec-btn-secondary ec-radius" >       <i class="ec-icon-dot-circle-o"></i>   </button>   <p>取消</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o)},initUI:function(){this.$_oLi=i(this.cHtml)},bandClick:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t._oParent.fire("CloudMap:BaseTool.removeActive"),t._oParent.fire("CloudMap:EditTool.calEdit"),t._oParent.addDrawToUI(),t._oParent.clearLayers()})}}),ES.CloudMap.EditTool=ES.CloudMap.BaseTool.extend({cHtml:'<li>   <button class="ec-btn ec-btn-secondary ec-radius" >       <i class="ec-icon-dot-circle-o"></i>   </button>   <p>编辑</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this._oDrawLayer=t.getDrawLayer(),this.oPen=null,this.initPen()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oParent.addSaveACalToUI()})},initPen:function(){this.oPen={enabled:this.oPenStyle,handler:new e.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1},poly:{allowIntersection:!1}}),title:""}},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this),this._oParent.on("CloudMap:EditTool.calEdit",this.calEdit,this),this._oParent.on("CloudMap:EditTool.edit",this.edit,this),this._oParent.on("CloudMap:EditTool.SaveEdit",this.saveEdit,this);var t=this;this._oMap.on("draw:edited",function(o){if(t._oParent.getActive()){var e=this;o.layers.eachLayer(function(o){var i=o.getLatLng(),a={aoLatLng:[{lat:i.lat,lng:i.lng}],oOption:{}};t._oDrawLayer.addLayer(o);var n=e.latLngToLayerPoint(i);t._oParent.fire("CloudMap:PopWnd.editShow",{oInfo:a,oPos:n,oBusData:o.oBusData})})}})},saveEdit:function(){this.oPen.handler.save(),this.oPen.handler.disable()},calEdit:function(){this.oPen.handler.revertLayers(),this.oPen.handler.disable()},edit:function(t){if(this._oParent.clearLayers(),t&&t.oNode){var o=e.marker(t.oNode.data,{});o.edited=!0,this._oMap.flyTo(t.oNode.data);var i={oLatLng:t.oNode.data,cId:t.oNode.id,cName:t.oNode.text,cParentId:t.oNode.parent,cParentText:t.oNode.parentText};o.cId=t.oNode.id,o.oBusData=i,o.addTo(this._oDrawLayer),this._oParent.addEditToUI()}}}),ES.CloudMap.SaveTool=ES.CloudMap.BaseTool.extend({cHtml:'<li>   <button class="ec-btn ec-btn-secondary ec-radius" >       <i class="ec-icon-dot-circle-o"></i>   </button>   <p>确定</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o)},bandClick:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t._oParent.fire("CloudMap:EditTool.SaveEdit")})}}),ES.CloudMap.MenuTool=ES.Evented.extend({cHtml:'<div class="ex-maptool-box ex-maptool-box-white">   <ul class="ex-map-tab ec-text-center ex-maptool-tab ex-cloud-map-menu">   </ul></div><div class="ex-maptool-box  ex-maptool-tab-draw">    <ul class="ex-map-tab ec-text-center ex-maptool-tab ex-cloud-map-tool">   </ul></div>',oOption:{acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-left"]},initialize:function(t,o){ES.setOptions(this,o),this.$_oContainer=i(this.cHtml),this.$_oPContainer=i("."+this.oOption.acParentDivClass.join(".")),this.$_oPContainer.eq(0).append(this.$_oContainer),this.aoCtrl=[],this.setParentEvent()},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"touchmove",e.DomEvent.stopPropagation)},appendMenu:function(t){var o=t.getMenu();o&&(t.setPContainer(this),this.$_oContainer.find("ul.ex-cloud-map-menu").append(o),this.aoCtrl.push(t))},clearTool:function(){this.$_oContainer.find("ul.ex-cloud-map-tool").empty()},showTool:function(){this.$_oPContainer.find(".ex-maptool-tab-draw").fadeIn()},appendTool:function(t){this.$_oContainer.find("ul.ex-cloud-map-tool").append(t.$_oLi)}}),ES.CloudMap.BaseWnd=ES.Evented.extend({}),ES.CloudMap.BaseMenu=ES.Evented.extend({oOption:{nTreePanelHeight:300,nTreePanelWidth:280,oTreePanelUrl:{},oTreePopUrl:{}},cHtml:'<li>   <button class="ec-btn ec-btn-secondary ec-circle" data-flag="Grid"  data-tab-index="1">       <i class="ec-icon-th-large"></i>   </button>   <p>邮路</p></li>',initialize:function(t,o){this._oParent=t,ES.setOptions(this,o),this._oMap=t.getMap(),this._oDrawLayer=e.featureGroup(),this._oDrawLayer.addTo(this._oMap),this.aoDrawTool=[],this.aoEditTool=[],this.aoSaveACalTool=[],this.aoPopWnd=[],this.oEditTool=null,this.oDelTool=null,this.$_oLi=null,this.initOn(),this.initUI()},getDrawLayer:function(){return this._oDrawLayer},getLayer:function(){return this._oDrawLayer.getLayers()},initOn:function(){this._oParent.on("CloudMap:BaseMenu.addActive",this.addActive,this),this._oParent.on("CloudMap:BaseMenu.removeActive",this.removeActive,this),this._oParent.on("CloudMap:BaseMenu.hidePenal",this.hidePenal,this),this._oParent.on("CloudMap:BaseMenu.endMenu",this.endMenu,this)},initUI:function(){this.$_oLi=i(this.cHtml);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPenal&&(t._oParent.fire("CloudMap:BaseMenu.hidePenal"),t.oPenal.show(),t._oParent.fire("CloudMap:BaseMenu.removeActive"),t.addActive(),t.oPContainer.showTool(),t.addDrawToUI(),t._oParent.fire("CloudMap:BaseMenu.endMenu"))})},defaultClick:function(){this.$_oLi.find("button").click()},hidePenal:function(){},clearLayers:function(){this._oDrawLayer.clearLayers()},addLayer:function(t){t.addTo(this._oDrawLayer)},getMenu:function(){return this.$_oLi},addActive:function(){this.$_oLi.find("button").addClass("ec-active")},removeActive:function(){this.$_oLi.find("button").removeClass("ec-active")},getActive:function(){return!!this.$_oLi.find("button").hasClass("ec-active")},setPContainer:function(t){this.oPContainer=t},endMenu:function(){}}),ES.CloudMap.BaseTreePanel=ES.Evented.extend({oOption:{cUrl:"",cDivContainer:".tree-layout-map",cCheckUrl:"",cTreeContainerSel:".ex-layout-struckbox-content",cSearchInputSel:".ex-tree-search-ipt",cSearchBtnSel:".ex-tree-search-btn",cEventName:"cPermission",cTitle:"组织架构",nHeight:350,nWidth:280},oTreeOption:{},initialize:function(t,o,e){this._oParent=t,this.oTOption={},ES.setOptions(this,o),ES.extend(this.oTOption,this.oTreeOption,e),"object"==typeof this.oOption.cDivContainer?this.$_oPContainer=this.oOption.cDivContainer:this.$_oPContainer=i(this.oOption.cDivContainer),this.initOn(),this.$_oContainer=null,this.oPopTree=null,this.oTreeContainer=null,this.oSearchInput=null,this.oSearvhBtn=null,this._oSelData=null},initContain:function(t){t.content=ES.template(t.content,t)},initOn:function(){this._oParent.on("PostPosTreeView.reflesh",this.reflesh,this)},reflesh:function(){this.oPopTree&&this.oPopTree.$_oTree.refresh()},initButton:function(){var t=this,o=[{value:ES.Lang.Boss[1],callback:function(){return t.ok(),!1},autofocus:!0}];this.oOption.button=o},initUI:function(){var t=i(ES.template(this.cHtml,{cTitle:this.oOption.cTitle})).addClass(this.oOption.cFlag);this.$_oPContainer.append(t),t.find("div.ex-layout-sider").width(this.oOption.nWidth),this.$_oContainer=t,this.oTreeContainer=this.$_oContainer.find(this.oOption.cTreeContainerSel),this.oTreeContainer.css({"margin-bottom":10,height:this.oOption.nHeight}),this.oSearchInput=this.$_oContainer.find(this.oOption.cSearchInputSel),this.oSearvhBtn=this.$_oContainer.find(this.oOption.cSearchBtnSel),this.initSearchEvent(),this.initTree(),this.setParentEvent()},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"touchmove",e.DomEvent.stopPropagation)},show:function(t){this.$_oContainer?this.$_oContainer.show():(this.initUI(),this.$_oContainer.show())},hide:function(t){this.$_oContainer&&this.$_oContainer.hide()},clearTree:function(){this.oPopTree.uncheckAll(),this.oTOption.cCheckUrl&&ES.getData({nRoleId:this.oBusData.RoleId},this.oTOption.cCheckUrl,this.initCheck,this)},initCheck:function(t){!t||t.length<=0||(this.oPopTree.uncheckAll(),this.oPopTree.setCheckNode(t))}}),ES.CloudMap.BaseTreePanel.include({cHtml:'<div class="ex-maptool-box ex-maptool-box-white ex-maptool-property ec-padding-0">   <div class="ex-layout-sider ex-theme-tree ec-fl"  >       <h3 class="ex-theme-sider-title">           <i class="ec-icon-sitemap"></i>&nbsp;{cTitle}       </h3>       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field ex-tree-search-ipt" placeholder="请输入关键字"> </input>               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs ex-tree-search-btn" type="button"><span class="ec-icon-search"></span></button>               </span>           </div>       </div>       <div class="ex-layout-struckbox-content" ></div>   </div></div>',initSearchEvent:function(){var t=this;this.oSearvhBtn.bind("click",function(){if(t.oPopTree){var o=t.oSearchInput.val();t.oPopTree.oTree.jstree(!0).search(o)}});var o=!1;this.oSearchInput.keyup(function(){o&&clearTimeout(o),o=setTimeout(function(){var o=t.oSearchInput.val();t.oPopTree.oTree.jstree(!0).search(o,!1,!0)},250)})},initTree:function(){var t=this;this.oPopTree||(this.oPopTree=new ES.Common.JsTree(this._oParent,{cPContainer:this.oTreeContainer},this.oTOption),this.oPopTree.readyCallBack=function(){},this.oPopTree.refreshCallBack=function(){},this.oPopTree.selectCallBack=function(o,e){t.selectDeal(e)})},selectDeal:function(t){if(t&&t.node){if("0"===t.node.id||0===t.node.id.indexOf("d_"))return void ES.Util.reqData({data:{deptId:t.node.id},url:"/Line/GetLineInfo"},function(t){this._oParent.fire("MapView:ShowLayer.DrawLayers",{aoData:t.rtnData})},this);var o=this.oPopTree.$_oTree.get_node(t.node.parent);t.node.parentText=o.text,this._oParent.fire("CloudMap:EditTool.edit",{oNode:t.node})}},getChildNode:function(t){if(t){var o=[];if(t.children_d&&!(t.children_d.length<=0)){for(var e=0;e<t.children_d.length;e++){var i=this.oPopTree.$_oTree.get_node(t.children_d[e]);i.data&&o.push(i.data)}return o}}}}),ES.CloudMap.LineMenu=ES.CloudMap.BaseMenu.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-circle" data-flag="Grid"  data-tab-index="1"><i class="ec-icon-th-large"></i></button><p> 线 路 </p></li>',initialize:function(t,o){ES.CloudMap.BaseMenu.prototype.initialize.call(this,t,o),this.initPenal(),this.initEditTool(),this.initDrawTool(),this.initPopWnd(),this.initSaveACalTool(),this.oLineLayer=new ES.CloudMap.LineLayer(this,{}),this.oCtrlLayer=new ES.CloudMap.MarkerLayer(this,{}),this.oCityCtrlLayer=new ES.CloudMap.MarkerLayer(this,{onEventDrawLayers:"ES:CloudMap.DrawCityCtrlLayer",onEventClearLayers:"ES:CloudMap.ClearCityCtrlLayer",onEventRemoveLayers:"ES:CloudMap.RemoveCityCtrlLayer",cIcon:"/Asset/img/ex_default/i_cityop_big_icon.png"})},initOn:function(){ES.CloudMap.BaseMenu.prototype.initOn.call(this);var t=this;this._oMap.on("moveend",function(o){if(t.getActive()){var e=t._oDrawLayer.getLayers();if(e&&!(e.length<=0)){var i=this.latLngToLayerPoint(e[0].getLatLngs()[0]);t.fire("CloudMap:PopWnd.setPos",{oPos:i})}}})},endMenu:function(){this.oEditTool&&this.oEditTool.calEdit(),this.oDrawTool&&this.oDrawTool.calDraw(),this.clearLayers()}}),ES.CloudMap.LineMenu.include({initPenal:function(){this.oPenal=new ES.CloudMap.LineTreePanel(this,{},{core:{animation:0,check_callback:!0,state:{opened:!0},data:function(t,o){var e=this,a={type:"POST",url:m_Url+"/base/tree",headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"},dataType:"json",data:'{"tree":"cloudMapRegionTree"}',success:function(t){t.detail[0].state={opened:!0},o.call(e,t.detail)},error:function(){o.call(e,null)}};i.ajax(a)}},plugins:["types","search","unique"]})},hidePenal:function(){this.oPenal.hide()}}),ES.CloudMap.LineMenu.include({initEditTool:function(){this.oEditTool=new ES.CloudMap.EditLineTool(this,{oDrawLayer:this._oDrawLayer}),this.oDelTool=new ES.CloudMap.DeleteTool(this,{}),this.aoEditTool.push(this.oEditTool),this.aoEditTool.push(this.oDelTool)},addEditToUI:function(){if(this.oPContainer&&!(this.aoEditTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoEditTool.length;t++)this.oPContainer.appendTool(this.aoEditTool[t]),this.aoEditTool[t].bandClick()}}}),ES.CloudMap.LineMenu.include({initDrawTool:function(){this.oDrawTool=new ES.CloudMap.DrawLineTool(this,{}),this.aoDrawTool.push(this.oDrawTool)},addDrawToUI:function(){if(this.oPContainer&&!(this.aoDrawTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoDrawTool.length;t++)this.oPContainer.appendTool(this.aoDrawTool[t]),this.aoDrawTool[t].bandClick()}}}),ES.CloudMap.LineMenu.include({initSaveACalTool:function(){this.oSaveTool=new ES.CloudMap.SaveTool(this,{oDrawLayer:this._oDrawLayer}),this.oCalTool=new ES.CloudMap.CalEditTool(this,{}),this.aoSaveACalTool.push(this.oSaveTool),this.aoSaveACalTool.push(this.oCalTool)},addSaveACalToUI:function(){this.oPContainer.clearTool();for(var t=0;t<this.aoSaveACalTool.length;t++)this.oPContainer.appendTool(this.aoSaveACalTool[t]),this.aoSaveACalTool[t].bandClick()}}),ES.CloudMap.LineMenu.include({initPopWnd:function(){this.oEditWnd=new ES.CloudMap.LineWnd(this,{oOffset:{nW:10,nH:80},cContainerSel:this._oParent.getMap()._mapPane}),this.oDelWnd=new ES.CloudMap.DelWnd(this,{cUrl:"/CloudMap/Delete"},{title:"删除操作-线路",cancelValue:"取消",content:"是否要删除数据！"}),this.aoPopWnd.push(this.oEditWnd),this.aoPopWnd.push(this.oDelWnd)}}),ES.CloudMap.PopWnd=ES.Evented.extend({}),ES.CloudMap.LineWnd=ES.CloudMap.PopWnd.extend({oOption:{cContainerSel:"#MapView",cFlag:"Grid",oText:{},oOffset:{nW:0,nH:30}},initialize:function(t,o){this._oParent=t,ES.setOptions(this,o),this.cFlag="PostPos",this.oPopLatLng=null,this.initUI(),this.initOn(),this.setParentEvent()},initUI:function(){this.$_oContainer=i(this.cContent),i(this.oOption.cContainerSel).append(this.$_oContainer),this.$_oContainer.hide(),this.afterOpen()},afterOpen:function(){var t=this;this.$_oContainer.find(".ec-icon-save").parent().bind("click",function(){t.save()}),this.$_oContainer.find('a[type="button"]').bind("click",function(){t.$_oContainer.hide(),t._oParent.clearLayers()}),this.oSelectTree||(this.oSelectTree=new ES.Common.SelectTreeNode(this,{cBandSel:i("#DeptName")},{core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:"/Department/DistrictTree"}},plugins:["types","search","unique"]})),this.oSelectTree.on("selectVal",this.setVal,this)},setVal:function(t){2==t.data.type&&(i("#DeptName").val(t.text),this.cParentId=t.id,i(".ex-cover-tree-select").hide().siblings("div").hide())},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation)},check:function(){return!!i("#GridName").val()||(ES.aWarn("请录入名称！"),!1)},save:function(){if(this.check()){ES.loadAn(this.$_oContainer),this.oBusData.oInfo.nType=4;var t=0;this.oBusData.Id&&(t=-this.oBusData.Id);for(var o=this.oBusData.oInfo.aoLatLng,e=[],a=[],n=0;n<o.length;n++)e.push(o[n].lng.toFixed(6)),a.push(o[n].lat.toFixed(6));for(var s=[],n=0;n<e.length;n++)s.push(e[n]+","+a[n]);var l=this;ES.getData({xy:s},"/Common/ToGpsLngLatGaoDe",function(o){if(i(".ex-layout-loading").remove(),o.mapx){var e={Id:t,CloudName:i("#GridName").val(),DeptId:l.cParentId,CloudType:7,Map:l.oBusData.oInfo,Source:1,MapType:4,MapX:o.mapx,MapY:o.mapy,GpsX:o.gpsx,GpsY:o.gpsy,Address:o.poi};ES.getData(e,"/CloudMap/Edit",l.saveHandler,l,{nId:e.Id,Map:e.Map,CloudName:e.CloudName})}else ES.aErr("位置信息获取失败")})}},saveHandler:function(t){ES.removeAn(this.$_oContainer);var o=t.oData,e=!1;t.nId||(e=!0),o&&o.IsSuccess?(ES.aSucess(e?ES.Common.Lang[10]:ES.Common.Lang[20]),this._oParent.fire("CloudMap:EditTool.clearLayer"),this._oParent.fire("PostPosTreeView.reflesh"),this._oParent.fire("CloudMap:LineLayer.reflesh",{Id:t.nId,Json:JSON.stringify(t.Map),CloudName:t.CloudName}),this.$_oContainer.hide()):(ES.aErr(ES.template(e?"添加数据失败,原因:{Msg}":"修改数据失败,原因:{Msg}",o)),this._oParent.fire("Edit:saveFail"))},initOn:function(){this._oParent.on("CloudMap:PopWnd.show",this.showModal,this),this._oParent.on("CloudMap:PopWnd.editShow",this.editShow,this),this._oParent.on("CloudMap:PopWnd.setPos",this.setPos,this)},setPos:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width();if(t){var i=t.oPos;this.$_oContainer.css({top:i.y-o-this.oOption.oOffset.nH+"px",left:i.x-e/2-this.oOption.oOffset.nW+"px"})}},editShow:function(t){if(t&&t.oInfo){var o=t.oPos,e=this.$_oContainer.height(),a=this.$_oContainer.width();this.$_oContainer.css({top:o.y-e-this.oOption.oOffset.nH+"px",left:o.x-a/2-this.oOption.oOffset.nW+"px"}),i("#GridName").val(t.oBusData.cName),i("#DeptName").val(t.oBusData.cParentText),this.oBusData={},this.oBusData.Id=-parseInt(t.oBusData.cId),this.oBusData.oInfo=t.oInfo,this.cParentId=t.oBusData.cParentId,this.$_oContainer.show()}},showModal:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width(),a=t.oPos;this.$_oContainer.css({top:a.y-o-this.oOption.oOffset.nH+"px",left:a.x-e/2-this.oOption.oOffset.nW+"px"}),i("#GridName").val(""),i("#DeptName").val(""),this.oBusData=t,this.oBusData.Id=t.cId,this.$_oContainer.show()}}),ES.CloudMap.LineWnd.include({cContent:'<div class="ex-mapgrid-tip-box  GridWnd"  style="top:150px; left:450px;"><ul class="ec-avg-sm-1">    <li class="ec-form-group">        <label for="form-sitename" class="ec-u-sm-4 ec-form-label">线路名称：</label>       <div class="ec-u-sm-8"><input type="text" id="GridName" name="form-sitename" autocomplete="off" placeholder="请输入线路名称" class="ec-form-field ec-radius ec-input-sm"></div>    </li>    <li class="ec-form-group">    <label for="form-selectDate" class="ec-u-sm-4 ec-form-label"> 区域：</label>       <div class="ec-u-sm-8"><input type="text" id="DeptName" name="form-sitename" autocomplete="off" placeholder="请输入区域" class="ec-form-field ec-radius ec-input-sm">    </div>    </li>    <li class="ec-form-group">       <div class="ec-u-sm-12 ex-final-button">           <button type="button" class="ec-btn ec-btn-sm ec-btn-primary"><i class="ec-icon-save"></i> 保存 </button>           <a href="#" type="button" class="ec-btn ec-btn-sm ec-btn-warning" style="color:#fff;">               <i class="ec-icon-link"></i> 关闭            </a>       </div>   </li></ul></div>'}),ES.MapControl.Layout=ES.Class.extend({oOption:{cPContainer:".ex-layout-content",cDidId:"MapView"},initialize:function(t,o){ES.setOptions(this,o),this._oParent=t,this.$_oPContainer=o.cPContainer,"object"!=typeof o.cContainerSel&&(this.$_oPContainer=i(this.oOption.cPContainer)),this.initUI(),this.initOn()},initUI:function(){this.$_oContainer=i(this.cHTML),this.$_oContainer.attr({id:this.oOption.cDidId}),this.$_oPContainer.append(this.$_oContainer)},initOn:function(){this._oParent&&this._oParent.on("MapControl:Layout.addToolItem",this.addToolItem,this)},addToolItem:function(t){this._addToolItem(t.cHTML)},_addToolItem:function(t){var o=i(t);this.$_oContainer.append(o)}}),ES.MapControl.Layout.include({cHTML:'<div  class="ex-layout-map-content">    <div class="ex-layout-type-wbox ex-map-bottom ex-map-right"></div>    <div class="ex-layout-maptool ex-theme-maptool ex-map-top ex-map-left  ec-padding-0">   </div>    <div class="ex-layout-maptool ex-theme-maptool ex-map-top ex-map-right"></div>    <div class="ex-layout-monitor-wbox">  </div> </div>'}),ES.MapControl.ESMapToolBox=ES.Evented.extend({oOption:{cParentDiv:"MapView",acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-left"],cClassName:"",title:"图层切换"},oUIConfig:{div:{class:"ex-maptool-box ex-control-dropmenu ",i:{class:"ec-icon-briefcase"},html:"&nbsp;&nbsp;",span:{html:"工具"},i11:{class:"ec-icon-angle-down"},ul:{class:"ec-avg-sm-1 ec-dropdown-content",li:[{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-china"},html:"&nbsp;全国"}},{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-range"},html:"&nbsp;测距"}},{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-area"},html:"&nbsp;测面"}},{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-scale-big"},html:"&nbsp;拉框放大"}},{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-scale-small"},html:"&nbsp;拉框缩小"}},{a:{href:"javascript:void(0);",i:{class:"ex-icon-maptool ex-maptool-location"},html:"&nbsp;坐标查询"}}]}}},initialize:function(t,o){o.oUIConfig&&(ES.extend(this.oUIConfig,o.oUIConfig),delete o.oUIConfig),ES.setOptions(this,o),this._oMapBase=t,this._oMap=t._oMap,this.$_oContainer=i("."+this.oOption.acParentDivClass.join(".")),this.initUI(),this.setParentEvent(),this.initMapTool(),this.oActHandler=null},initMapTool:function(){this.oScaleBig=new e.Map.ScaleBig(this._oMap),this.oScaleSmall=new e.Map.ScaleSmall(this._oMap),this.oDistantHandler=e.MapLib.Measure.distMgr(this._oMap),this.oAreaHandler=e.MapLib.Measure.areaMgr(this._oMap,{}),this.oMapToolLocal=new e.MapLib.LocaltionSearch.Search(this._oMap)},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"touchmove",e.DomEvent.stopPropagation)},initUI:function(){ES.initTag(this.$_oContainer.eq(0),this.oUIConfig),this.initToolEvent()},initToolEvent:function(){var t=this;this.$_oContainer.find("div.map-tool-box>ul>li>a").bind("click",this,function(o){var e=i(this).get(0).innerText.trim();t.$_oContainer.find("div.map-tool-box>span").html(e)}),i(".ex-maptool-scale-big").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t.oActHandler=t.oScaleBig,t.oActHandler.enable()}),i(".ex-maptool-scale-small").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t.oActHandler=t.oScaleSmall,t.oActHandler.enable()}),i(".ex-maptool-china").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t._oMap.setView(new e.LatLng(35,103.5),4)}),i(".ex-maptool-reset").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable()}),i(".ex-maptool-location").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t.oActHandler=t.oMapToolLocal,t.oActHandler.enable()}),i(".ex-maptool-range").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t.oActHandler=t.oDistantHandler,t.oActHandler.enable()}),i(".ex-maptool-area").parent().bind("click",function(){t.oActHandler&&t.oActHandler.disable(),t.oActHandler=t.oAreaHandler,t.oActHandler.enable()})}}),ES.MapControl.ESMapTile=ES.Evented.extend({oOption:{cParentDiv:"MapView",acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-left"],cClassName:"",title:"图层切换"},oUIConfig:{div:{class:"ex-maptool-box ex-control-dropmenu  map-tile",i:{class:"ec-icon-clone"},html:"&nbsp;&nbsp;",span:{html:"高德地图"},i11:{class:"ec-icon-angle-down"},ul:{class:"ec-avg-sm-1 ec-dropdown-content",li:[{a:{href:"javascript:void(0);",html:"高德地图"}},{a:{href:"javascript:void(0);",html:"高德卫星图"}},{a:{href:"javascript:void(0);",html:"谷歌地图"}},{a:{href:"javascript:void(0);",html:"谷歌卫星图"}},{a:{href:"javascript:void(0);",html:"谷歌地形图"}},{a:{href:"javascript:void(0);",html:"灰度图"}}]}}},initialize:function(t,o){o.oUIConfig&&(ES.extend(this.oUIConfig,o.oUIConfig),delete o.oUIConfig),ES.setOptions(this,o),this._oMapBase=t,this._oMap=t._oMap,this._layers={},this._lastZIndex=0,this.$_oPContainer=i("."+this.oOption.acParentDivClass.join("."));var e=this._oMapBase.getBaseLayers();for(var a in e)this._addLayer(e[a],a);this.setParentEvent(),this.initUI()},_addLayer:function(t,o,i){var a=e.stamp(t);this._layers[a]={layer:t,name:o,overlay:i},this.oOption.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex))},setParentEvent:function(){e.DomEvent.addListener(this.$_oPContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oPContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oPContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oPContainer.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oPContainer.get(0),"touchmove",e.DomEvent.stopPropagation)},initUI:function(){ES.initTag(this.$_oPContainer.eq(0),this.oUIConfig),this.initToolEvent()},initToolEvent:function(){var t=this;this.$_oPContainer.find("div.map-tile>ul>li>a").bind("click",this,function(){var o=i(this).get(0).innerText.trim();t.selectLayer(o),t.$_oPContainer.find("div.map-tile>span").html(o)}),this.$_oPContainer.find("div.map-tile>ul>li>a").mouseover(function(){t._oMap.doubleClickZoom.disable()}),this.$_oPContainer.find("div.map-tile>ul>li>a").mouseout(function(){t._oMap.doubleClickZoom.enable()})},selectLayer:function(t){"灰度图"===t&&this._oMap.getZoom()>16&&this._oMap.setZoom(16);for(var o in this._layers){var e=this._layers[o];e.name!==t||this._oMap.hasLayer(e.layer)?this._oMap.hasLayer(e.layer)&&e.name!==t&&this._oMap.removeLayer(e.layer):this._oMap.addLayer(e.layer)}}}),ES.MapControl.ESMapSearch=ES.Evented.extend({oOption:{cParentDiv:"MapView",acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-left"],className:"",title:"图层切换",cUrl:"/MapView/PoiSearch",oParam:{key:"",keywords:"",types:"050301",location:"113.22,30.333",city:"",citylimit:"",datatype:"poi",output:"JSON"}},cHtml:'<div class="ex-maptool-box"><div class="ec-input-group ex-maptool-search-box">    <input type="text" name="name" placeholder="搜索" class="ec-form-field"/>    <span class="ec-input-group-btn">        <button class="ec-btn ec-btn-primary ec-btn-sm search" type="button"><span class="ec-icon-search"></span></button>          <button class="ec-btn ec-btn-default ec-btn-sm clear" type="button"><span class="ec-icon-close"></span></button>   </span>           <ul class="ex-maptool-box-search-result">      </ul>      </div> </div>',initialize:function(t,o){ES.setOptions(this,o),this._oMapBase=t,this._oMap=t._oMap,this.oLayer=e.featureGroup(),this.oInputData=null,this.oLayer.addTo(this._oMap),this.$_oPContainer=i("."+this.oOption.acParentDivClass.join(".")),this.initUI(),this.setParentEvent(),this.initToolEvent()},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"touchmove",e.DomEvent.stopPropagation)},initUI:function(){this.$_oContainer=i(this.cHtml),this.$_oPContainer.eq(0).append(this.$_oContainer),this.$_oSearchRtn=this.$_oContainer.find(".ex-maptool-box-search-result"),this.$_oSearchRtn.hide(),this.$_oUL=this.$_oContainer.find("ul.ex-maptool-box-search-result"),this.$_oUL.empty(),this.$_oInput=this.$_oContainer.find("input"),this.$_btnClear=this.$_oContainer.find("button.clear"),this.$_btnSearch=this.$_oContainer.find("button.search")},initToolEvent:function(){var e=this,a=!1;this.$_oInput.keyup(function(o){var i=o||t.event,n=i.keyCode;38!=n&&40!=n&&(e.oInputData&&e.oInputData.name===e.$_oInput.val()||(a&&clearTimeout(a),a=setTimeout(function(){var t=e.$_oInput.val(),o=e._oMap.getCenter(),i={};ES.extend(i,e.oOption.oParam,{keywords:t,location:o.lng+","+o.lat}),ES.getData(i,e.oOption.cUrl,e.searchPoiHandler,e)},250)))}),i(o).keydown(function(o){if("none"!==e.$_oSearchRtn.css("display")){var i=o||t.event,a=i.keyCode;38===a?e.movePrev():40===a&&e.moveNext(),13===a&&e.localPos()}}),this.$_btnClear.bind("click",function(){e.oLayer.clearLayers(),e.$_oInput.val("")}),this.$_btnSearch.bind("click",function(){var t=e.$_oInput.val(),o=e._oMap.getCenter(),i={};ES.extend(i,e.oOption.oParam,{keywords:t,location:o.lng+","+o.lat}),ES.getData(i,e.oOption.cUrl,e.searchPoiHandler,e)})},localPos:function(){this.oLayer.clearLayers()
;var t=this.$_oUL.find("li.ec-active"),o=t.data("oData"),i=e.marker([o.lat,o.lng]);i.oData=o,i.addTo(this.oLayer),this._oMap.flyTo([o.lat,o.lng],16),this.$_oInput.val(o.name),this.oInputData=o,this.$_oUL.empty(),this.$_oSearchRtn.hide()},movePrev:function(){var t=this.$_oUL.find("li.ec-active").prevAll().length;if(0==t)return this.$_oInput.focus(),!1;this.$_oUL.find("li").removeClass("ec-active").eq(t-1).addClass("ec-active");var o=this.$_oUL.find("li").eq(t-1).data("oData");this.$_oInput.val(o.name)},moveNext:function(){var t=this.$_oUL.find("li.ec-active").prevAll().length;if(0===t&&!this.$_oUL.find("li").eq(0).hasClass("ec-active")){this.$_oUL.find("li").eq(0).addClass("ec-active");var o=this.$_oUL.find("li").eq(0).data("oData");return void this.$_oInput.val(o.name)}if(t===this.$_oUL.find("li").length-1)return!1;this.$_oUL.find("li").removeClass("ec-active").eq(t+1).addClass("ec-active");var o=this.$_oUL.find("li").eq(t+1).data("oData");this.$_oInput.val(o.name)},searchPoiHandler:function(t){if(this.$_oUL.empty(),this.$_oSearchRtn.hide(),!(0===t.status||t.count<=0)){for(var o=0;o<t.tips.length;o++)if(0!==t.tips[o].lng){t.tips[o].cDist=t.tips[o].district||"";var e=i(ES.template('<li class="location"><b>{name}</b><span>{cDist}</span></li>',t.tips[o]));e.data("oData",t.tips[o]),this.$_oUL.append(e),e.bind("click",this,function(t){t.data.localPos()}),e.bind("mouseover",function(){i(this).addClass("ec-active")}),e.bind("mouseout",function(){i(this).removeClass("ec-active")})}this.$_oSearchRtn.show()}}}),ES.CloudMap.SiteTreePanel=ES.CloudMap.BaseTreePanel.extend({}),ES.CloudMap.EditSiteTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" ><i class="ec-icon-dot-circle-o"></i></button><p>编 辑</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this._oDrawLayer=t.getDrawLayer(),this.oPen=null,this.initPen()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oParent.addSaveACalToUI()})},initPen:function(){this.oPen={enabled:this.oPenStyle,handler:new e.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1},poly:{allowIntersection:!1}}),title:""}},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this),this._oParent.on("CloudMap:EditTool.calEdit",this.calEdit,this),this._oParent.on("CloudMap:EditTool.edit",this.edit,this),this._oParent.on("CloudMap:EditTool.SaveEdit",this.saveEdit,this);var t=this;this._oMap.on("draw:edited",function(o){if(t._oParent.getActive()){var e=this;o.layers.eachLayer(function(o){var i=o.getLatLngs()[0].map(function(t){return{lat:t.lat,lng:t.lng}}),a={aoLatLng:i,oOption:{}};t._oDrawLayer.addLayer(o);var n=e.latLngToLayerPoint(i[0]);t._oParent.fire("CloudMap:PopWnd.editShow",{oInfo:a,oPos:n,oBusData:o.oBusData})})}})},saveEdit:function(){this.oPen.handler.save(),this.oPen.handler.disable()},calEdit:function(){this.oPen.handler.revertLayers(),this.oPen.handler.disable()},edit:function(t){if(this._oParent.clearLayers(),t&&t.oNode){var o=this.createLayer(t.oNode.data);if(o){o.edited=!0,this.fitBound();var e={oLatLng:t.oNode.data,cId:t.oNode.id,cName:t.oNode.text,cParentId:t.oNode.parent,cParentText:t.oNode.parentText};o.cId=t.oNode.id,o.oBusData=e,o.addTo(this._oDrawLayer),this._oParent.addEditToUI()}}},fitBound:function(){if(this._oDrawLayer){var t=this._oDrawLayer.getBounds();this._oMap.fitBounds(t)}},createLayer:function(t){var o=null;if(!t||!t.Json)return o;var i=null;try{i=JSON.parse(t.Json),i.oOption=this.oPenStyle}catch(t){i=null}return i?o=e.polyline(i.aoLatLng,i.oOption).addTo(this._oDrawLayer):o}}),ES.CloudMap.DrawSiteTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" data-object="0" ><i class="ec-icon-dot-circle-o"></i></button><p>画站场</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this.initPen(),this.initOn(),this.initUI()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oMap.once("draw:created",t.createdCallBack,t)})},initPen:function(){this.oPen={enabled:{},handler:new e.Draw.Polygon(this._oMap,{}),title:""}},calDraw:function(){this.oPen&&this.oPen.handler.disable()},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this)},createdCallBack:function(t){var o=t.layer;this._oParent.addLayer(o);var e=o.getLatLngs(),i=e[0].map(function(t){return{lat:t.lat,lng:t.lng}}),a={aoLatLng:i,oOption:{}},n=this._oMap.latLngToLayerPoint(i[i.length-1]);this._oParent.fire("CloudMap:PopWnd.show",{oInfo:a,oPos:n})}}),ES.CloudMap.SiteWnd=ES.CloudMap.BaseWnd.extend({oOption:{cContainerSel:"#MapView",cFlag:"Grid",oText:{},oOffset:{nW:0,nH:0}},initialize:function(t,o,e){this._oParent=t,this.oTreeOption=e,ES.setOptions(this,o),this.cFlag="PostPos",this.oPopLatLng=null,this.initUI(),this.initOn(),this.setParentEvent()},initUI:function(){this.$_oContainer=i(this.cContent),i(this.oOption.cContainerSel).append(this.$_oContainer),this.$_oContainer.hide(),this.afterOpen()},afterOpen:function(){var t=this;this.$_oContainer.find(".ec-icon-save").parent().bind("click",function(){t.save()}),this.$_oContainer.find('a[type="button"]').bind("click",function(){t.$_oContainer.hide(),t._oParent.clearLayers()}),this.oSelectTree||(this.oSelectTree=new ES.Common.SelectTreeNode(this,{cBandSel:i("#DeptName")},this.oTreeOption)),this.oSelectTree.on("selectVal",this.setVal,this)},setVal:function(t){t.id.indexOf("d_")>=0&&(i("#DeptName").val(t.text),this.cParentId=t.id)},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation)},check:function(){return!!i("#GridName").val()||(ES.aWarn("请录入名称！"),!1)},save:function(){if(this.check()){ES.loadAn(this.$_oContainer);var t={Id:-this.oBusData.Id,CloudName:i("#GridName").val(),DeptId:this.cParentId.replace("d_",""),CloudType:1,Map:this.oBusData.oInfo,Source:1,MapType:1};ES.getData(t,"/Line/Edit",this.saveHandler,this,{nId:t.Id,Map:t.Map,CloudName:t.CloudName})}},saveHandler:function(t){ES.removeAn(this.$_oContainer);var o=t.oData,e=!1;t.nId||(e=!0),o&&o.IsSuccess?(ES.aSucess(e?ES.Common.Lang[10]:ES.Common.Lang[20]),this._oParent.fire("CloudMap:EditTool.clearLayer"),this._oParent.fire("PostPosTreeView.reflesh"),this._oParent.fire("CloudMap:LineLayer.reflesh",{Id:t.nId,Json:JSON.stringify(t.Map),CloudName:t.CloudName}),this.$_oContainer.hide()):(ES.aErr(ES.template(e?"添加数据失败,原因:{Msg}":"修改数据失败,原因:{Msg}",o)),this._oParent.fire("Edit:saveFail"))},initOn:function(){this._oParent.on("CloudMap:PopWnd.show",this.showModal,this),this._oParent.on("CloudMap:PopWnd.editShow",this.editShow,this),this._oParent.on("CloudMap:PopWnd.setPos",this.setPos,this)},setPos:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width();if(t){var i=t.oPos;this.$_oContainer.css({top:i.y-o-this.oOption.oOffset.nH+"px",left:i.x-e/2-this.oOption.oOffset.nW+"px"})}},editShow:function(t){if(t&&t.oInfo){var o=t.oPos,e=this.$_oContainer.height(),a=this.$_oContainer.width();this.$_oContainer.css({top:o.y-e-this.oOption.oOffset.nH+"px",left:o.x-a/2-this.oOption.oOffset.nW+"px"}),i("#GridName").val(t.oBusData.cName),i("#DeptName").val(t.oBusData.cParentText),this.oBusData={},this.oBusData.Id=-parseInt(t.oBusData.cId),this.oBusData.oInfo=t.oInfo,this.cParentId=t.oBusData.cParentId,this.$_oContainer.show()}},showModal:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width(),a=t.oPos;this.$_oContainer.css({top:a.y-o-this.oOption.oOffset.nH+"px",left:a.x-e/2-this.oOption.oOffset.nW+"px"}),i("#GridName").val(""),i("#DeptName").val(""),this.oBusData=t,this.oBusData.Id=t.cId,this.$_oContainer.show()}}),ES.CloudMap.SiteWnd.include({cContent:'<div class="ex-mapgrid-tip-box  GridWnd"  style="top:150px; left:450px;"><ul class="ec-avg-sm-1">    <li class="ec-form-group">        <label for="form-sitename" class="ec-u-sm-4 ec-form-label">站场名称：</label>       <div class="ec-u-sm-8"><input type="text" id="GridName" name="form-sitename" autocomplete="off" placeholder="请输入站场名称" class="ec-form-field ec-radius ec-input-sm"></div>    </li>    <li class="ec-form-group">    <label for="form-selectDate" class="ec-u-sm-4 ec-form-label"> 区域：</label>       <div class="ec-u-sm-8"><input type="text" id="DeptName" name="form-sitename" autocomplete="off" placeholder="请输入区域" class="ec-form-field ec-radius ec-input-sm">    </div>    </li>    <li class="ec-form-group">       <div class="ec-u-sm-12 ex-final-button">           <button type="button" class="ec-btn ec-btn-sm ec-btn-primary"><i class="ec-icon-save"></i> 保存 </button>           <a href="#" type="button" class="ec-btn ec-btn-sm ec-btn-warning" style="color:#fff;">               <i class="ec-icon-link"></i> 关闭            </a>       </div>   </li></ul></div>'}),ES.CloudMap.DelWnd=ES.Common.DialogDel.extend({initOn:function(){this._oParent.on("CloudMap:DelCloudMap.del",this.del,this)},save:function(){if(!this.oBusData)return void ES.aWarn(ES.Lang.BaseDialog[30]);ES.loadAn(i(this.oDialog.node)),ES.getData({id:this.oBusData.oBusData.Id},this.oOption.cUrl,this.saveHandler,this)},saveHandler:function(t){ES.removeAn(i(this.oDialog.node)),t&&t.IsSuccess?(ES.aSucess(ES.Common.Lang[32]),this._oParent.fire("PostPosTreeView.reflesh"),this._oParent.clearLayers(),this._oParent.fire("CloudMap:EditTool.calEdit"),this._oParent.addDrawToUI()):ES.aErr(ES.template(ES.Common.Lang[33],t)),this.oDialog.close()}}),ES.CloudMap.MarkerWnd=ES.CloudMap.PopWnd.extend({oOption:{cContainerSel:"#MapView",cFlag:"Grid",oText:{},oOffset:{nW:0,nH:30}},initialize:function(t,o){this._oParent=t,ES.setOptions(this,o),this.cFlag="PostPos",this.oPopLatLng=null,this.initUI(),this.initOn(),this.setParentEvent()},initUI:function(){this.$_oContainer=i(this.cContent),i(this.oOption.cContainerSel).append(this.$_oContainer),this.$_oContainer.hide(),this.afterOpen()},afterOpen:function(){var t=this;this.$_oContainer.find(".ec-icon-save").parent().bind("click",function(){t.save()}),this.$_oContainer.find('a[type="button"]').bind("click",function(){t.$_oContainer.hide(),t._oParent.clearLayers()}),this.oSelectTree||(this.oSelectTree=new ES.Common.SelectTreeNode(this,{cBandSel:i("#MarkerDeptName")},{core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:"/Department/DistrictTree"}},plugins:["types","search","unique"]})),this.oSelectTree.on("selectVal",this.setVal,this)},setVal:function(t){i("#MarkerDeptName").val(t.text),this.cParentId=t.id,i(".ex-cover-tree-select").hide().siblings("div").hide()},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation)},check:function(){return!!i("#MarkerName").val()||(ES.aWarn("请录入名称！"),!1)},save:function(){if(this.check()){ES.loadAn(this.$_oContainer),this.oBusData.oInfo.nType=4;var t=0;this.oBusData.Id&&(t=-this.oBusData.Id);for(var o=this.oBusData.oInfo.aoLatLng,e=[],a=[],n=0;n<o.length;n++)e.push(o[n].lng.toFixed(6)),a.push(o[n].lat.toFixed(6));for(var s=[],n=0;n<e.length;n++)s.push(e[n]+","+a[n]);var l=this;ES.getData({xy:s},"/Common/ToGpsLngLatGaoDe",function(o){if(i(".ex-layout-loading").remove(),o.mapx){var e={Id:t,CloudName:i("#MarkerName").val(),DeptId:l.cParentId,CloudType:9,Map:l.oBusData.oInfo,Source:1,MapType:5,MapX:o.mapx,MapY:o.mapy,GpsX:o.gpsx,GpsY:o.gpsy,Address:o.poi};ES.getData(e,"/CloudMap/Edit",l.saveHandler,l,{nId:e.Id})}else ES.aErr("位置信息获取失败")})}},saveHandler:function(t){ES.removeAn(this.$_oContainer);var o=t.oData,e=!1;t.nId||(e=!0),o&&o.IsSuccess?(ES.aSucess(e?ES.Common.Lang[10]:ES.Common.Lang[20]),this._oParent.fire("CloudMap:EditTool.clearLayer"),this._oParent.fire("PostPosTreeView.reflesh"),this.$_oContainer.hide()):(ES.aErr(ES.template(e?"添加数据失败,原因:{Msg}":"修改数据失败,原因:{Msg}",o)),this._oParent.fire("Edit:saveFail"))},initOn:function(){this._oParent.on("CloudMap:PopWnd.show",this.showModal,this),this._oParent.on("CloudMap:PopWnd.editShow",this.editShow,this),this._oParent.on("CloudMap:PopWnd.setPos",this.setPos,this)},setPos:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width();if(t){var i=t.oPos;this.$_oContainer.css({top:i.y-o-this.oOption.oOffset.nH+"px",left:i.x-e/2-this.oOption.oOffset.nW+"px"})}},editShow:function(t){if(t&&t.oInfo){var o=t.oPos,e=this.$_oContainer.height(),a=this.$_oContainer.width();this.$_oContainer.css({top:o.y-e-this.oOption.oOffset.nH+"px",left:o.x-a/2-this.oOption.oOffset.nW+"px"}),i("#MarkerName").val(t.oBusData.cName),i("#MarkerDeptName").val(t.oBusData.cParentText),this.oBusData={},this.oBusData.Id=-parseInt(t.oBusData.cId),this.oBusData.oInfo=t.oInfo,this.cParentId=t.oBusData.cParentId,this.$_oContainer.show()}},showModal:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width(),a=t.oPos;this.$_oContainer.css({top:a.y-o-this.oOption.oOffset.nH+"px",left:a.x-e/2-this.oOption.oOffset.nW+"px"}),i("#GridName").val(""),i("#MarkerDeptName").val(""),this.oBusData=t,this.oBusData.Id=0,this.$_oContainer.show()}}),ES.CloudMap.MarkerWnd.include({cContent:'<div class="ex-mapgrid-tip-box  GridWnd"  style="top:150px; left:450px;"><ul class="ec-avg-sm-1">    <li class="ec-form-group">        <label for="form-sitename" class="ec-u-sm-4 ec-form-label">国控点：</label>       <div class="ec-u-sm-8"><input type="text" id="MarkerName" name="form-sitename" autocomplete="off" placeholder="请输入国控点名称" class="ec-form-field ec-radius ec-input-sm"></div>    </li>    <li class="ec-form-group">    <label for="form-selectDate" class="ec-u-sm-4 ec-form-label"> 区域：</label>       <div class="ec-u-sm-8"><input type="text" id="MarkerDeptName" name="form-sitename" autocomplete="off" placeholder="请输入区域" class="ec-form-field ec-radius ec-input-sm">    </div>    </li>    <li class="ec-form-group">       <div class="ec-u-sm-12 ex-final-button">           <button type="button" class="ec-btn ec-btn-sm ec-btn-primary"><i class="ec-icon-save"></i> 保存 </button>           <a href="#" type="button" class="ec-btn ec-btn-sm ec-btn-warning" style="color:#fff;">               <i class="ec-icon-link"></i> 关闭            </a>       </div>   </li></ul></div>'}),ES.CloudMap.RegionMarkerWnd=ES.CloudMap.PopWnd.extend({oOption:{cContainerSel:"#MapView",cFlag:"Grid",oText:{},oOffset:{nW:0,nH:30}},initialize:function(t,o){this._oParent=t,ES.setOptions(this,o),this.cFlag="PostPos",this.oPopLatLng=null,this.initUI(),this.initOn(),this.setParentEvent()},initUI:function(){this.$_oContainer=i(this.cContent),i(this.oOption.cContainerSel).append(this.$_oContainer),this.$_oContainer.hide(),this.afterOpen()},afterOpen:function(){var t=this;this.$_oContainer.find(".ec-icon-save").parent().bind("click",function(){t.save()}),this.$_oContainer.find('a[type="button"]').bind("click",function(){t.$_oContainer.hide(),t._oParent.clearLayers()}),this.oSelectTree||(this.oSelectTree=new ES.Common.SelectTreeNode(this,{cBandSel:i("#RegionMarkerDeptName")},{core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:"/Department/DistrictTree"}},plugins:["types","search","unique"]})),this.oSelectTree.on("selectVal",this.setVal,this)},setVal:function(t){i("#RegionMarkerDeptName").val(t.text),this.cParentId=t.id,i(".ex-cover-tree-select").hide().siblings("div").hide()},setParentEvent:function(){e.DomEvent.addListener(this.$_oContainer.get(0),"click",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"dblclick",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousemove",e.DomEvent.stopPropagation),e.DomEvent.addListener(this.$_oContainer.get(0),"mousewheel",e.DomEvent.stopPropagation)},check:function(){return!!i("#RegionMarkerName").val()||(ES.aWarn("请录入名称！"),!1)},save:function(){if(this.check()){ES.loadAn(this.$_oContainer),this.oBusData.oInfo.nType=10;var t=0;this.oBusData.Id&&(t=-this.oBusData.Id);for(var o=this.oBusData.oInfo.aoLatLng,e=[],a=[],n=0;n<o.length;n++)e.push(o[n].lng.toFixed(6)),a.push(o[n].lat.toFixed(6));for(var s=[],n=0;n<e.length;n++)s.push(e[n]+","+a[n]);var l=this;ES.getData({xy:s},"/Common/ToGpsLngLatGaoDe",function(o){if(i(".ex-layout-loading").remove(),o.mapx){var e={Id:t,CloudName:i("#RegionMarkerName").val(),DeptId:l.cParentId,CloudType:10,Map:l.oBusData.oInfo,Source:1,MapType:5,MapX:o.mapx,MapY:o.mapy,GpsX:o.gpsx,GpsY:o.gpsy,Address:o.poi};ES.getData(e,"/CloudMap/Edit",l.saveHandler,l,{nId:e.Id,Map:e.Map,CloudName:e.CloudName})}else ES.aErr("位置信息获取失败")})}},saveHandler:function(t){ES.removeAn(this.$_oContainer);var o=t.oData,e=!1;t.nId||(e=!0),o&&o.IsSuccess?(ES.aSucess(e?ES.Common.Lang[10]:ES.Common.Lang[20]),this._oParent.fire("CloudMap:EditTool.clearLayer"),this._oParent.fire("PostPosTreeView.reflesh"),this.$_oContainer.hide()):(ES.aErr(ES.template(e?"添加数据失败,原因:{Msg}":"修改数据失败,原因:{Msg}",o)),this._oParent.fire("Edit:saveFail"))},initOn:function(){this._oParent.on("CloudMap:PopWnd.show",this.showModal,this),this._oParent.on("CloudMap:PopWnd.editShow",this.editShow,this),this._oParent.on("CloudMap:PopWnd.setPos",this.setPos,this)},setPos:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width();if(t){var i=t.oPos;this.$_oContainer.css({top:i.y-o-this.oOption.oOffset.nH+"px",left:i.x-e/2-this.oOption.oOffset.nW+"px"})}},editShow:function(t){if(t&&t.oInfo){var o=t.oPos,e=this.$_oContainer.height(),a=this.$_oContainer.width();this.$_oContainer.css({top:o.y-e-this.oOption.oOffset.nH+"px",left:o.x-a/2-this.oOption.oOffset.nW+"px"}),i("#RegionMarkerName").val(t.oBusData.cName),i("#RegionMarkerDeptName").val(t.oBusData.cParentText),this.oBusData={},this.oBusData.Id=-parseInt(t.oBusData.cId),this.oBusData.oInfo=t.oInfo,this.cParentId=t.oBusData.cParentId,this.$_oContainer.show()}},showModal:function(t){var o=this.$_oContainer.height(),e=this.$_oContainer.width(),a=t.oPos;this.$_oContainer.css({top:a.y-o-this.oOption.oOffset.nH+"px",left:a.x-e/2-this.oOption.oOffset.nW+"px"}),i("#RegionMarkerName").val(""),i("#RegionMarkerDeptName").val(""),this.oBusData=t,this.oBusData.Id=0,this.$_oContainer.show()}}),ES.CloudMap.RegionMarkerWnd.include({cContent:'<div class="ex-mapgrid-tip-box  GridWnd"  style="top:150px; left:450px;"><ul class="ec-avg-sm-1">    <li class="ec-form-group">        <label for="form-sitename" class="ec-u-sm-4 ec-form-label">市控点：</label>       <div class="ec-u-sm-8"><input type="text" id="RegionMarkerName" name="form-sitename" autocomplete="off" placeholder="请输入市控点名称" class="ec-form-field ec-radius ec-input-sm"></div>    </li>    <li class="ec-form-group">    <label for="form-selectDate" class="ec-u-sm-4 ec-form-label"> 区域：</label>       <div class="ec-u-sm-8"><input type="text" id="RegionMarkerDeptName" name="form-sitename" autocomplete="off" placeholder="请输入区域" class="ec-form-field ec-radius ec-input-sm">    </div>    </li>    <li class="ec-form-group">       <div class="ec-u-sm-12 ex-final-button">           <button type="button" class="ec-btn ec-btn-sm ec-btn-primary"><i class="ec-icon-save"></i> 保存 </button>           <a href="#" type="button" class="ec-btn ec-btn-sm ec-btn-warning" style="color:#fff;">               <i class="ec-icon-link"></i> 关闭            </a>       </div>   </li></ul></div>'}),ES.CloudMap.LineTreePanel=ES.CloudMap.BaseTreePanel.extend({initUI:function(){ES.CloudMap.BaseTreePanel.prototype.initUI.call(this),i('input[type="checkbox"]').uCheck(),i('input[type="checkbox"].ec-ucheck-checkbox').uCheck();var t=this;i("#Ctrl").bind("change",function(o){i(this).is(":checked")?ES.getData({typeIds:9,districtId:"3"},m_getList,function(o){t._oParent.fire("ES:CloudMap.DrawCtrlLayer",{aoData:o[9]})},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}}):t._oParent.fire("ES:CloudMap.ClearCtrlLayer")}),i("#CityCtrl").bind("change",function(o){i(this).is(":checked")?ES.getData({typeIds:10,districtId:"3"},m_getList,function(o){t._oParent.fire("ES:CloudMap.DrawCityCtrlLayer",{aoData:o[10]})},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}}):t._oParent.fire("ES:CloudMap.ClearCityCtrlLayer")})},selectDeal:function(t){if(t&&t.node){var o=this;if(t.node.id.indexOf("_")>-1)var e=t.node.id.replace("_","");else var e=t.node.id;this._oParent.oDrawTool.calDraw(),ES.getData(JSON.stringify({id:parseInt(e)}),m_getList,function(t){o._oParent.fire("MapView:ShowLayer.DrawLayers",{aoData:t[7]}),o._oParent.fire("CloudMap:EditTool.calEdit"),o._oParent.addDrawToUI()},this,{},{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}})}},cHtml:'<div class="ex-maptool-box ex-maptool-box-white ex-maptool-property ec-padding-0">   <div class="ex-layout-sider ex-theme-tree ec-fl" style = "width:280px">       <h3 class="ex-theme-sider-title">           <i class="ec-icon-sitemap"></i>&nbsp;{cTitle}       </h3>       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field ex-tree-search-ipt" placeholder="请输入关键字"> </input>               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs ex-tree-search-btn" type="button"><span class="ec-icon-search"></span></button>               </span>           </div>       </div>       <div class="ex-layout-struckbox-content" style="height:350px;"></div>   </div></div>'}),ES.CloudMap.NationTreePanel=ES.CloudMap.BaseTreePanel.extend({initUI:function(){ES.CloudMap.BaseTreePanel.prototype.initUI.call(this)},selectDeal:function(t){if(t&&t.node){var o=this,e=t.node.id;e.indexOf("_")>-1&&(e=e.replace("_",""));this._oParent.oDrawTool.calDraw(),this._oParent.oEditWnd,t.node.data.type<=2?ES.getData({typeIds:9,districtId:e},m_getList,function(t){o._oParent.fire("ES:CloudMap.DrawCtrlLayer",{aoData:t[9]}),o._oParent.fire("CloudMap:EditTool.calEdit"),o._oParent.addDrawToUI()},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}}):ES.getData({typeIds:9,districtId:e},m_getList,function(t){for(var i=0;i<t[9].length;i++)if(e==t[9][i].Id){o._oParent.fire("ES:CloudMap.DrawCtrlLayer",{aoData:t[9][i]}),o._oParent.fire("CloudMap:EditTool.edit",{oNode:t[9][i]});break}},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}})}},cHtml:'<div class="ex-maptool-box ex-maptool-box-white ex-maptool-property ec-padding-0">   <div class="ex-layout-sider ex-theme-tree ec-fl" style = "width:280px">      <h3 class="ex-theme-sider-title">          <i class="ec-icon-sitemap"></i>&nbsp;{cTitle}       </h3>       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field ex-tree-search-ipt" placeholder="请输入关键字"> </input>               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs ex-tree-search-btn" type="button"><span class="ec-icon-search"></span></button>               </span>           </div>       </div>       <div class="ex-layout-struckbox-content" style="height:350px;"></div>   </div></div>'}),ES.CloudMap.CityTreePanel=ES.CloudMap.BaseTreePanel.extend({initUI:function(){ES.CloudMap.BaseTreePanel.prototype.initUI.call(this)},selectDeal:function(t){if(t&&t.node){var o=this,e=t.node.id;e.indexOf("_")>-1&&(e=e.replace("_","")),this._oParent.oDrawTool.calDraw(),t.node.data.type<=2?ES.getData({typeIds:10,districtId:e},m_getList,function(t){o._oParent.fire("ES:CloudMap.DrawCtrlLayer",{aoData:t[10]}),o._oParent.fire("CloudMap:EditTool.calEdit"),o._oParent.addDrawToUI()},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}}):ES.getData({typeIds:10,districtId:e},m_getList,function(t){for(var i=0;i<t[10].length;i++)if(e==t[10][i].Id){o._oParent.fire("ES:CloudMap.DrawCtrlLayer",{aoData:t[10][i]}),o._oParent.fire("CloudMap:EditTool.edit",{oNode:t[10][i]});break}},this,null,{headers:{token:m_oParam.token,"Content-Type":"application/json; charset=utf-8"}})}},cHtml:'<div class="ex-maptool-box ex-maptool-box-white ex-maptool-property ec-padding-0">   <div class="ex-layout-sider ex-theme-tree ec-fl" style = "width:280px">      <h3 class="ex-theme-sider-title">          <i class="ec-icon-sitemap"></i>&nbsp;{cTitle}       </h3>       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field ex-tree-search-ipt" placeholder="请输入关键字"> </input>               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs ex-tree-search-btn" type="button"><span class="ec-icon-search"></span></button>               </span>           </div>       </div>       <div class="ex-layout-struckbox-content" style="height:350px;"></div>   </div></div>'}),ES.CloudMap.DrawLineTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" data-object="0" ><i class="ec-icon-dot-circle-o"></i></button><p>画线路</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this.initPen(),this.initOn(),this.initUI()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oMap.once("draw:created",t.createdCallBack,t)})},initPen:function(){this.oPen={enabled:{},handler:new e.Draw.Polyline(this._oMap,{}),title:""}},calDraw:function(){this.oPen&&this.oPen.handler.disable()},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this)},createdCallBack:function(t){var o=t.layer;this._oParent.addLayer(o);var e=o.getLatLngs(),i=e.map(function(t){return{lat:t.lat,lng:t.lng}}),a={aoLatLng:i,oOption:{}},n=this._oMap.latLngToLayerPoint(i[0]);this._oParent.fire("CloudMap:PopWnd.show",{oInfo:a,oPos:n})}}),ES.CloudMap.EditLineTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" ><i class="ec-icon-dot-circle-o"></i></button><p>编 辑</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this._oDrawLayer=t.getDrawLayer(),this.oPen=null,this.initPen()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oParent.addSaveACalToUI()})},initPen:function(){this.oPen={enabled:this.oPenStyle,handler:new e.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1},poly:{allowIntersection:!1}}),title:""}},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this),this._oParent.on("CloudMap:EditTool.calEdit",this.calEdit,this),this._oParent.on("CloudMap:EditTool.edit",this.edit,this),this._oParent.on("CloudMap:EditTool.SaveEdit",this.saveEdit,this);var t=this;this._oMap.on("draw:edited",function(o){if(t._oParent.getActive()){var e=this;o.layers.eachLayer(function(o){var i=o.getLatLngs().map(function(t){return{lat:t.lat,lng:t.lng}}),a={aoLatLng:i,oOption:{}};t._oDrawLayer.addLayer(o);var n=e.latLngToLayerPoint(i[0]);t._oParent.fire("CloudMap:PopWnd.editShow",{oInfo:a,oPos:n,oBusData:o.oBusData})})}})},saveEdit:function(){this.oPen.handler.save(),this.oPen.handler.disable()},calEdit:function(){this.oPen.handler.revertLayers(),this.oPen.handler.disable()},edit:function(t){if(this._oParent.clearLayers(),t&&t.oNode){var o=this.createLayer(t.oNode);if(o){o.edited=!0,this.fitBound();var e={oLatLng:t.oNode.MapJson,cId:t.oNode.Id,cName:t.oNode.CloudName,cParentId:t.oNode.DeptId,cParentText:t.oNode.DeptName};o.cId=t.oNode.Id,o.oBusData=e,o.addTo(this._oDrawLayer),this._oParent.addEditToUI()}}},fitBound:function(){if(this._oDrawLayer){var t=this._oDrawLayer.getBounds();this._oMap.fitBounds(t)}},createLayer:function(t){var o=null;if(!t||!t.MapJson)return o;var i=null;try{i=JSON.parse(t.MapJson),i.oOption=this.oPenStyle}catch(t){i=null}return i?o=e.polyline(i.aoLatLng,i.oOption).addTo(this._oDrawLayer):o}}),ES.CloudMap.DrawMarkerTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" data-object="0" ><i class="ec-icon-dot-circle-o"></i></button><p>画国(市)控点</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this.initPen(),this.initOn(),this.initUI()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oMap.once("draw:created",t.createdCallBack,t)})},initPen:function(){this.oPen={enabled:{},handler:new e.Draw.Marker(this._oMap,{}),title:""}},calDraw:function(){this.oPen&&this.oPen.handler.disable()},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this)},createdCallBack:function(t){var o=t.layer;this._oParent.addLayer(o);var e=o.getLatLng(),i={aoLatLng:[{lat:e.lat,lng:e.lng}],oOption:{}},a=this._oMap.latLngToLayerPoint(e);this._oParent.fire("CloudMap:PopWnd.show",{oInfo:i,oPos:a})}}),ES.CloudMap.EditMarkerTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" ><i class="ec-icon-dot-circle-o"></i></button><p>编 辑</p></li>',initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o),this._oDrawLayer=t.getDrawLayer(),this.oPen=null,this.initPen()},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){t.oPen.handler.enable(),t._oParent.addSaveACalToUI()})},initPen:function(){this.oPen={enabled:this.oPenStyle,handler:new e.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1},poly:{allowIntersection:!1}}),title:""}},initOn:function(){ES.CloudMap.BaseTool.prototype.initOn.call(this),this._oParent.on("CloudMap:EditTool.calEdit",this.calEdit,this),this._oParent.on("CloudMap:EditTool.edit",this.edit,this),this._oParent.on("CloudMap:EditTool.SaveEdit",this.saveEdit,this);var t=this;this._oMap.on("draw:edited",function(o){if(t._oParent.getActive()){var e=this;o.layers.eachLayer(function(o){var i=o.getLatLng(),a={aoLatLng:[{lat:i.lat,lng:i.lng}],oOption:{}};t._oDrawLayer.addLayer(o);var n=e.latLngToLayerPoint(i);t._oParent.fire("CloudMap:PopWnd.editShow",{oInfo:a,oPos:n,oBusData:o.oBusData})})}})},saveEdit:function(){this.oPen.handler.save(),this.oPen.handler.disable()},calEdit:function(){this.oPen.handler.revertLayers(),this.oPen.handler.disable()},edit:function(t){if(this._oParent.clearLayers(),t&&t.oNode){var o=this.createLayer(t.oNode);if(o){o.edited=!0,this.fitBound();var e={oLatLng:t.oNode.MapJson,cId:t.oNode.Id,cName:t.oNode.CloudName,cParentId:t.oNode.DeptId,cParentText:t.oNode.DeptName};o.cId=t.oNode.Id,o.oBusData=e,o.addTo(this._oDrawLayer),this._oParent.addEditToUI()}}},fitBound:function(){if(this._oDrawLayer){var t=this._oDrawLayer.getBounds();this._oMap.fitBounds(t)}},createLayer:function(t){var o=null;if(!t)return o;var i=null;try{i=JSON.parse(t.MapJson),i.oOption=this.oPenStyle}catch(t){i=null}return i?o=e.marker(i.aoLatLng[0],i.oOption).addTo(this._oDrawLayer):o}}),ES.CloudMap.DeleteTool=ES.CloudMap.BaseTool.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-radius" ><i class="ec-icon-dot-circle-o"></i></button><p>删除</p></li>',
initialize:function(t,o){ES.CloudMap.BaseTool.prototype.initialize.call(this,t,o)},bandClick:function(){ES.CloudMap.BaseTool.prototype.bandClick.call(this);var t=this;this.$_oLi.find("button").bind("click",function(){var o=t._oParent.getLayer();if(!o||o.length<=0)return void ES.aWarn("没有可以删除的数据");t._oParent.fire("CloudMap:DelCloudMap.del",{oBusData:{Id:parseInt(o[0].oBusData.cId)}})})}}),ES.CloudMap.NationalCtrlMenu=ES.CloudMap.BaseMenu.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-circle" data-flag="Grid"  data-tab-index="1"><i class="ec-icon-th-large"></i></button><p> 国控点 </p></li>',initialize:function(t,o){ES.CloudMap.BaseMenu.prototype.initialize.call(this,t,o),this.initPenal(),this.initEditTool(),this.initDrawTool(),this.initPopWnd(),this.initSaveACalTool(),this.oCtrlLayer=new ES.CloudMap.MarkerLayer(this,{})},initOn:function(){ES.CloudMap.BaseMenu.prototype.initOn.call(this);var t=this;this._oMap.on("moveend",function(o){if(t.getActive()){var e=t._oDrawLayer.getLayers();if(e&&!(e.length<=0)){var i=this.latLngToLayerPoint(e[0].getLatLng());t.fire("CloudMap:PopWnd.setPos",{oPos:i})}}})},endMenu:function(){this.oEditTool&&this.oEditTool.calEdit(),this.oDrawTool&&this.oDrawTool.calDraw(),this.clearLayers()}}),ES.CloudMap.NationalCtrlMenu.include({initPenal:function(){this.oPenal=new ES.CloudMap.NationTreePanel(this,{},{core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:"/CloudMap/CloudMapTreeByMapType?MapType=5&cloudTypes=[9]"}},plugins:["types","search","unique"]})},hidePenal:function(){this.oPenal.hide()}}),ES.CloudMap.NationalCtrlMenu.include({initEditTool:function(){this.oEditTool=new ES.CloudMap.EditMarkerTool(this,{oDrawLayer:this._oDrawLayer}),this.oDelTool=new ES.CloudMap.DeleteTool(this,{}),this.aoEditTool.push(this.oEditTool),this.aoEditTool.push(this.oDelTool)},addEditToUI:function(){if(this.oPContainer&&!(this.aoEditTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoEditTool.length;t++)this.oPContainer.appendTool(this.aoEditTool[t]),this.aoEditTool[t].bandClick()}}}),ES.CloudMap.NationalCtrlMenu.include({initDrawTool:function(){this.oDrawTool=new ES.CloudMap.DrawMarkerTool(this,{}),this.aoDrawTool.push(this.oDrawTool)},addDrawToUI:function(){if(this.oPContainer&&!(this.aoDrawTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoDrawTool.length;t++)this.oPContainer.appendTool(this.aoDrawTool[t]),this.aoDrawTool[t].bandClick()}}}),ES.CloudMap.NationalCtrlMenu.include({initSaveACalTool:function(){this.oSaveTool=new ES.CloudMap.SaveTool(this,{oDrawLayer:this._oDrawLayer}),this.oCalTool=new ES.CloudMap.CalEditTool(this,{}),this.aoSaveACalTool.push(this.oSaveTool),this.aoSaveACalTool.push(this.oCalTool)},addSaveACalToUI:function(){this.oPContainer.clearTool();for(var t=0;t<this.aoSaveACalTool.length;t++)this.oPContainer.appendTool(this.aoSaveACalTool[t]),this.aoSaveACalTool[t].bandClick()}}),ES.CloudMap.NationalCtrlMenu.include({initPopWnd:function(){this.oEditWnd=new ES.CloudMap.MarkerWnd(this,{oOffset:{nW:10,nH:80},cContainerSel:this._oParent.getMap()._mapPane}),this.oDelWnd=new ES.CloudMap.DelWnd(this,{cUrl:"/CloudMap/Delete"},{title:"删除操作-国控点",cancelValue:"取消",content:"是否要删除数据！"}),this.aoPopWnd.push(this.oEditWnd),this.aoPopWnd.push(this.oDelWnd)}}),ES.CloudMap.RegionCtrlMenu=ES.CloudMap.BaseMenu.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-circle" data-flag="Grid"  data-tab-index="1"><i class="ec-icon-th-large"></i></button><p> 市控点 </p></li>',initialize:function(t,o){ES.CloudMap.BaseMenu.prototype.initialize.call(this,t,o),this.initPenal(),this.initEditTool(),this.initDrawTool(),this.initPopWnd(),this.initSaveACalTool(),this.oRegionLayer=new ES.CloudMap.MarkerLayer(this,{})},initOn:function(){ES.CloudMap.BaseMenu.prototype.initOn.call(this);var t=this;this._oMap.on("moveend",function(o){if(t.getActive()){var e=t._oDrawLayer.getLayers();if(e&&!(e.length<=0)){var i=this.latLngToLayerPoint(e[0].getLatLng());t.fire("CloudMap:PopWnd.setPos",{oPos:i})}}})},endMenu:function(){this.oEditTool&&this.oEditTool.calEdit(),this.oDrawTool&&this.oDrawTool.calDraw(),this.clearLayers()}}),ES.CloudMap.RegionCtrlMenu.include({initPenal:function(){this.oPenal=new ES.CloudMap.CityTreePanel(this,{},{core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:"/CloudMap/CloudMapTreeByMapType?MapType=5&cloudTypes=[10]"}},plugins:["types","search","unique"]})},hidePenal:function(){this.oPenal.hide()}}),ES.CloudMap.RegionCtrlMenu.include({initEditTool:function(){this.oEditTool=new ES.CloudMap.EditMarkerTool(this,{oDrawLayer:this._oDrawLayer}),this.oDelTool=new ES.CloudMap.DeleteTool(this,{}),this.aoEditTool.push(this.oEditTool),this.aoEditTool.push(this.oDelTool)},addEditToUI:function(){if(this.oPContainer&&!(this.aoEditTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoEditTool.length;t++)this.oPContainer.appendTool(this.aoEditTool[t]),this.aoEditTool[t].bandClick()}}}),ES.CloudMap.RegionCtrlMenu.include({initDrawTool:function(){this.oDrawTool=new ES.CloudMap.DrawMarkerTool(this,{}),this.aoDrawTool.push(this.oDrawTool)},addDrawToUI:function(){if(this.oPContainer&&!(this.aoDrawTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoDrawTool.length;t++)this.oPContainer.appendTool(this.aoDrawTool[t]),this.aoDrawTool[t].bandClick()}}}),ES.CloudMap.RegionCtrlMenu.include({initSaveACalTool:function(){this.oSaveTool=new ES.CloudMap.SaveTool(this,{oDrawLayer:this._oDrawLayer}),this.oCalTool=new ES.CloudMap.CalEditTool(this,{}),this.aoSaveACalTool.push(this.oSaveTool),this.aoSaveACalTool.push(this.oCalTool)},addSaveACalToUI:function(){this.oPContainer.clearTool();for(var t=0;t<this.aoSaveACalTool.length;t++)this.oPContainer.appendTool(this.aoSaveACalTool[t]),this.aoSaveACalTool[t].bandClick()}}),ES.CloudMap.RegionCtrlMenu.include({initPopWnd:function(){this.oEditWnd=new ES.CloudMap.RegionMarkerWnd(this,{oOffset:{nW:10,nH:80},cContainerSel:this._oParent.getMap()._mapPane}),this.oDelWnd=new ES.CloudMap.DelWnd(this,{cUrl:"/CloudMap/Delete"},{title:"删除操作-市控点",cancelValue:"取消",content:"是否要删除数据！"}),this.aoPopWnd.push(this.oEditWnd),this.aoPopWnd.push(this.oDelWnd)}}),ES.CloudMap.SiteMenu=ES.CloudMap.BaseMenu.extend({cHtml:'<li><button class="ec-btn ec-btn-secondary ec-circle" data-flag="Grid"  data-tab-index="1"><i class="ec-icon-th-large"></i></button><p> 绘制站场 </p></li>',initialize:function(t,o){ES.CloudMap.BaseMenu.prototype.initialize.call(this,t,o),this.initPenal(),this.initEditTool(),this.initDrawTool(),this.initPopWnd(),this.initSaveACalTool(),this.oLineLayer=new ES.CloudMap.SiteLayer(this,{})},initOn:function(){ES.CloudMap.BaseMenu.prototype.initOn.call(this);var t=this;this._oMap.on("moveend",function(o){if(t.getActive()){var e=t._oDrawLayer.getLayers();if(e&&!(e.length<=0)){var i=e[0].getLatLngs()[0].length,a=this.latLngToLayerPoint(e[0].getLatLngs()[0][i-1]);t.fire("CloudMap:PopWnd.setPos",{oPos:a})}}})},endMenu:function(){this.oEditTool&&this.oEditTool.calEdit(),this.oDrawTool&&this.oDrawTool.calDraw(),this.clearLayers()}}),ES.CloudMap.SiteMenu.include({initPenal:function(){this.oPenal=new ES.CloudMap.SiteTreePanel(this,{nHeight:this.oOption.nTreePanelHeight,nWidth:this.oOption.nTreePanelWidth},this.oOption.oTreePanelUrl)},hidePenal:function(){this.oPenal.hide()}}),ES.CloudMap.SiteMenu.include({initEditTool:function(){this.oEditTool=new ES.CloudMap.EditSiteTool(this,{oDrawLayer:this._oDrawLayer}),this.oDelTool=new ES.CloudMap.DeleteTool(this,{}),this.aoEditTool.push(this.oEditTool),this.aoEditTool.push(this.oDelTool)},addEditToUI:function(){if(this.oPContainer&&!(this.aoEditTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoEditTool.length;t++)this.oPContainer.appendTool(this.aoEditTool[t]),this.aoEditTool[t].bandClick()}}}),ES.CloudMap.SiteMenu.include({initDrawTool:function(){this.oDrawTool=new ES.CloudMap.DrawSiteTool(this,{}),this.aoDrawTool.push(this.oDrawTool)},addDrawToUI:function(){if(this.oPContainer&&!(this.aoDrawTool.length<=0)){this.oPContainer.clearTool();for(var t=0;t<this.aoDrawTool.length;t++)this.oPContainer.appendTool(this.aoDrawTool[t]),this.aoDrawTool[t].bandClick()}}}),ES.CloudMap.SiteMenu.include({initSaveACalTool:function(){this.oSaveTool=new ES.CloudMap.SaveTool(this,{oDrawLayer:this._oDrawLayer}),this.oCalTool=new ES.CloudMap.CalEditTool(this,{}),this.aoSaveACalTool.push(this.oSaveTool),this.aoSaveACalTool.push(this.oCalTool)},addSaveACalToUI:function(){this.oPContainer.clearTool();for(var t=0;t<this.aoSaveACalTool.length;t++)this.oPContainer.appendTool(this.aoSaveACalTool[t]),this.aoSaveACalTool[t].bandClick()}}),ES.CloudMap.SiteMenu.include({initPopWnd:function(){this.oEditWnd=new ES.CloudMap.SiteWnd(this,{oOffset:{nW:10,nH:30},cContainerSel:this._oParent.getMap()._mapPane},this.oOption.oTreePopUrl),this.oDelWnd=new ES.CloudMap.DelWnd(this,{cUrl:"/Line/Delete"},{title:"删除操作-线路",cancelValue:"取消",content:"是否要删除数据！"}),this.aoPopWnd.push(this.oEditWnd),this.aoPopWnd.push(this.oDelWnd)}}),ES.CloudMap.LineLayer=e.MapLib.MapMaster.MapOpr.extend({oOption:{onEventDrawLayers:"MapView:ShowLayer.DrawLayers",onEventClearLayers:"MapView:ShowLayer.clearLayer",onEventRemoveLayers:"MapView:ShowLayer.removeLayers",oStyleConfig:{stroke:!0,color:"green",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:1,fill:!1,fillColor:null,fillOpacity:.2,clickable:!1,smoothFactor:1,noClip:!1},cHtml:'<div class="{cCls}"><div class="{cBCls}"></div><div class="{cTCls}">{Name}</div></div>'},initialize:function(t,o){e.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,t,{}),ES.setOptions(this,o),this._initGroup(),this._loadOn()},_initGroup:function(){this._oPolylineGroup=e.featureGroup(),this._oMap.addLayer(this._oPolylineGroup)},_loadOn:function(){this._oParent.on(this.oOption.onEventDrawLayers,this.drawLayers,this),this._oParent.on(this.oOption.onEventClearLayers,this.clearLayer,this),this._oParent.on(this.oOption.onEventRemoveLayers,this.removeLayers,this),this._oParent.on("CloudMap:LineLayer.reflesh",this.reflesh,this)},removeLayers:function(t){if(this._oPolylineGroup&&t&&!(t.acId.length<=0))for(var o=t.acId,e=0;e<o.length;e++){var i=-parseInt(o[e]),a=this.findLayer(this._oPolylineGroup,i);a&&this._oPolylineGroup.removeLayer(a)}},clearLayer:function(){this._oPolylineGroup.clearLayers()},drawLayers:function(t){if(this.clearLayer(),t&&t.aoData){for(var o=0;o<t.aoData.length;o++){this.findLayer(this._oPolylineGroup,t.aoData[o].Id)||this.drawLayer(t.aoData[o])}this._oMap.fitBounds(this._oPolylineGroup.getBounds())}},reflesh:function(t){var o=this.findLayer(this._oPolylineGroup,t.Id);o&&this._oPolylineGroup.removeLayer(o),this.drawLayer(t)},drawLayer:function(t){if(t){var o=this.createLayer(t);o&&(o.cId=t.Id,o.cName=t.CloudName)}},createLayer:function(t){var o=null;if(!t)return o;if(t.MapJson)var i=JSON.parse(t.MapJson);else if(t.Json)var i=JSON.parse(t.Json);var a=i.aoLatLng;if((!i.aoLatLng||i.aoLatLng.length>1)&&i.aoLatLng[0].lng>i.aoLatLng[i.aoLatLng.length-1].lng){a=[];for(var n=i.aoLatLng.length-1;n>=0;n--)a.push(i.aoLatLng[n])}return o=e.polyline(a,this.oOption.oStyleConfig).addTo(this._oPolylineGroup)}}),ES.CloudMap.MarkerLayer=e.MapLib.MapMaster.MapOpr.extend({oOption:{onEventDrawLayers:"ES:CloudMap.DrawCtrlLayer",onEventClearLayers:"ES:CloudMap.ClearCtrlLayer",onEventRemoveLayers:"ES:CloudMap.RemoveCtrlLayer",cIcon:"/Asset/img/ex_default/i_nationop_big_icon.png",cCityIcon:"/Asset/img/ex_default/i_cityop_big_icon.png",cHtml:'<div class="ex-monitor-mapicon-pin  {icon} ">   <i></i>   <div class="pin-tip">       <div class="pin-dome"></div>       <div class="pin-number">{name}</div>   </div></div>'},initialize:function(t,o){e.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,t,{}),ES.setOptions(this,o),this._initGroup(),this._loadOn()},_initGroup:function(){this._oCtrlGroup=e.featureGroup(),this._oMap.addLayer(this._oCtrlGroup)},_loadOn:function(){this._oParent.on(this.oOption.onEventDrawLayers,this.drawLayers,this),this._oParent.on(this.oOption.onEventClearLayers,this.clearAll,this)},clearAll:function(){this._oCtrlGroup.clearLayers()},drawLayers:function(t){if(this.clearAll(),t&&t.aoData){if(t.aoData.length&&t.aoData.length>0)for(var o=0;o<t.aoData.length;o++){var e=this.findLayer(this._oCtrlGroup,t.aoData[o].Id);e||this.drawLayer(t.aoData[o])}else this.drawLayer(t.aoData);this._oMap.fitBounds(this._oCtrlGroup.getBounds())}},drawLayer:function(t){if(this._oCtrlGroup&&t){var o=JSON.parse(t.MapJson),i=this._getIcon();if(10==t.CloudType)var i=this._getCityIcon();var a=e.marker(o.aoLatLng[0],{icon:i});return e.circle(o.aoLatLng[0],{radius:3e3}).addTo(this._oCtrlGroup),a.cId=t.Id,a.oData=t,a.addTo(this._oCtrlGroup),a.bindTooltip(t.CloudName).openTooltip(),a}},initEventForMarker:function(t){var o=this;t&&t.on("click",function(){ES.Util.reqData({url:this.oPosInfo.MapPopUrl,data:{id:this.oPosInfo.Id},dataType:"html"},function(t){this.bindPopup(t.rtnData,{maxWidth:400});var e=this.getPopup();e.id=this.cId,e.on("contentupdate",function(){i("li[band-id="+this.id+"]").unbind("click"),i("li[band-id="+this.id+"]").bind("click",function(){new ES.MapView.PopAssetInfo(o,{cId:i(this).attr("band-id"),cUrl:i(this).attr("band-url"),cTypeName:i(this).attr("band-type")}).showModal()})}),this.openPopup()},this)},t)},_getIcon:function(){return e.icon({iconUrl:this.oOption.cIcon,iconSize:[40,40],iconAnchor:[20,40]})},_getCityIcon:function(){return e.icon({iconUrl:this.oOption.cCityIcon,iconSize:[40,40],iconAnchor:[20,40]})},_getPopHtml:function(t){return""},clearMarkerSite:function(t){for(var o=t.anId,e=0;e<o.length;e++){var i=this.findLayer(this._oCtrlGroup,o[e]);i&&(i.oMarker&&this._oCtrlGroup.removeLayer(i.oMarker),this._oCtrlGroup.removeLayer(i))}}}),ES.CloudMap.SiteLayer=e.MapLib.MapMaster.MapOpr.extend({oOption:{onEventDrawLayers:"MapView:ShowLayer.DrawLayers",onEventClearLayers:"MapView:ShowLayer.clearLayer",onEventRemoveLayers:"MapView:ShowLayer.removeLayers",oStyleConfig:{stroke:!0,color:"green",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:1,fill:!1,fillColor:null,fillOpacity:.2,clickable:!1,smoothFactor:1,noClip:!1},cHtml:'<div class="{cCls}"><div class="{cBCls}"></div><div class="{cTCls}">{Name}</div></div>'},initialize:function(t,o){e.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,t,{}),ES.setOptions(this,o),this._initGroup(),this._loadOn()},_initGroup:function(){this._oPolylineGroup=e.featureGroup(),this._oMap.addLayer(this._oPolylineGroup)},_loadOn:function(){this._oParent.on(this.oOption.onEventDrawLayers,this.drawLayers,this),this._oParent.on(this.oOption.onEventClearLayers,this.clearLayer,this),this._oParent.on(this.oOption.onEventRemoveLayers,this.removeLayers,this),this._oParent.on("CloudMap:LineLayer.reflesh",this.reflesh,this)},removeLayers:function(t){if(this._oPolylineGroup&&t&&!(t.acId.length<=0))for(var o=t.acId,e=0;e<o.length;e++){var i=-parseInt(o[e]),a=this.findLayer(this._oPolylineGroup,i);a&&this._oPolylineGroup.removeLayer(a)}},clearLayer:function(){this._oPolylineGroup.clearLayers()},drawLayers:function(t){if(this.clearLayer(),t&&t.aoData){for(var o=0;o<t.aoData.length;o++){this.findLayer(this._oPolylineGroup,t.aoData[o].Id)||this.drawLayer(t.aoData[o])}this._oMap.fitBounds(this._oPolylineGroup.getBounds())}},reflesh:function(t){var o=this.findLayer(this._oPolylineGroup,t.Id);o&&this._oPolylineGroup.removeLayer(o),this.drawLayer(t)},drawLayer:function(t){if(t){var o=this.createLayer(t);o&&(o.cId=t.Id,o.cName=t.CloudName)}},createLayer:function(t){var o=null;if(!t)return o;var i=JSON.parse(t.MapJson),a=i.aoLatLng;if((!i.aoLatLng||i.aoLatLng.length>1)&&i.aoLatLng[0].lng>i.aoLatLng[i.aoLatLng.length-1].lng){a=[];for(var n=i.aoLatLng.length-1;n>=0;n--)a.push(i.aoLatLng[n])}return o=e.polyline(a,this.oOption.oStyleConfig).addTo(this._oPolylineGroup),o.setText(t.CloudName+"          ",{repeat:!0,offset:20,attributes:{"font-size":"14",fill:"red"}}),o}})}(window,document,L,jQuery);