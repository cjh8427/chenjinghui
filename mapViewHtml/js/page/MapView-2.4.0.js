

/*
MapView-2.4.0 code for exsun

Copyright©2015-2018 武汉依迅北斗空间技术有限公司 All Rights Reserved.

http://www.exsun.cn
*/

!function(window,document,L,$){ES.MapView={},ES.MapView.version="2.4.0",ES.MapView.Page=ES.Page.extend({initialize:function(e,t){ES.Page.prototype.initialize.call(this,e,t),this.$_oDivVehDetail=$(".ex-layout-cardetail"),this.initEven()},AuthValue:function(e,t){for(var i in e)"false"==e[i].split(" ")[1].split("=")[1]&&t.find("li[menu-flag='"+i+"']").css("display","none")},_getVecMarkerHtml:function(e){var t=ES.TrackHelper.getDire(e.dir),i=ES.TrackHelper.getDateMsg(e.gpsTime),a={};ES.extend(a,e,{cMsg:i,cDir:t,Mileage:e.mile,cGpsDate:ES.Util.dateFormat(e.gpsTime,"yyyy-MM-dd hh:mm:ss"),cVehicleStatus:e.currentState||"通讯中断",cPoiInfo:e.poi||"",map:"通讯中断"===e.currentState||"定位失败"===e.currentState?"off":"on",key:"1"===e.status[0]?"on":"",open:"1"===e.status[1]?"on":"",signal:"通讯中断"!==e.currentState?"on":""});var o='<div class="ex-maptip-wtm">    <div class="ex-maptip-wtm-content">       <div class="ex-content-info-box">            <div class="ex-content-info-car ec-u-sm-6">               <h3>{vehNo}</h3>               <div class="ex-content-img"><img src="../img/mapview/truck_144.png" alt="" /></div>           </div>           <div class="ex-content-info-state ec-u-sm-6">               <ul>                   <li><span>{cGpsDate}{cMsg}</span></li>                   <li><strong>状态：</strong><span>{cVehicleStatus}</span></li>                   <li><strong>速度：</strong><span>{speed} (Km/h)</span></li>                   <li><strong>里程：</strong><span>{Mileage} Km</span></li>                   <li><strong>位置：</strong><span>{cPoiInfo}</span></li>               </ul>           </div>       </div>   </div>   <div class="ex-maptip-wtm-tool">       <ul class="tool-btn ec-avg-sm-3 ec-u-sm-6">           <li><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-truck"> 详情 </a></li>           <li><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 轨迹 </a></li>        </ul>       <ul class="tool-state ec-avg-sm-4 ec-u-sm-6">        </ul>   </div></div>',o=ES.Util.template(o,a);return o},toHeartModle:function(e){var t=[];if(!e||e.length<=0)return t;var i="/Asset/img/ex_default/law_144.png";"truck"===ES.MapView.oConfig.systemFlag&&(i="/Asset/img/ex_default/truck_144.png");for(var a=0;a<e.length;a++){var o=e[a].vehGpsData,n=o.Poi.MapPoint,s={vehNo:e[a].vehNo,devNo:e[a].devNo,latLng:{lat:n.Lat,lng:n.Lon},gpsDate:o.GpsDateTime,dir:o.Direction,poi:o.Poi.Address,speed:o.Speed,status:o.Status,attach:o.Property,sta:o.VehicleStatus,mile:o.Mileage,gpsTime:ES.Util.toDate(o.GpsDateTime).getTime(),img:i,entName:o.CompanyName};t.push(s)}return t},weightStatus:function(e,t){return e||(e=0),parseInt(e)<=1?"空载":$.inArray(15,t)>=0?"超载":"满载"},getVstatus:function(e){if(e&&!(e.length<=0)){for(var t=0;t<e.length;t++){for(var i=e[t],a={acc:0,gps:0},o=0;o<i.Status.length;o++)1==i.Status[o]?a.acc=1:2==i.Status[o]&&(a.gps=1);Date.parse(new Date)-ES.Util.toDate(i.GpsDateTime).getTime()<=6e5?i.Speed>0&&1==a.gps?i.VehicleStatus="行驶":0==i.Speed&&1==a.gps&&0==a.acc?i.VehicleStatus="熄火":0==i.Speed&&1==a.gps&&1==a.acc?i.VehicleStatus="停车":0==a.gps&&(i.VehicleStatus="定位失败"):i.VehicleStatus="通讯中断"}return e}},getDetailStatus:function(){return this.$_oDivVehDetail.data("nFlag")||0},setDetailStatus:function(e){this.$_oDivVehDetail.data("nFlag",e)},initEven:function(){var e=this;$(".ex-layout-cardetail-close.ec-close").eq(0).bind("click",this,function(){e.setBtn0(),e.fire("MapView:VehDetail.hideTrack"),e.fire("MapView:Map.setMapConterH",{nH:0,nTick:150})}),$(".ex-layout-cardetail-close.ec-close").eq(1).bind("click",this,function(){e.setBtn2(),e.fire("MapView:TrackLst.hideTrack"),e.fire("MapView:Map.setMapConterH",{nH:40,nTick:150})}),$(".ex-layout-cardetail-close.ec-close").eq(2).bind("click",this,function(){e.setBtn1(),e.fire("MapView:TrackLst.reShowTrack")})},setBtn0:function(){$("#MapShowDetail>a").eq(0).show(),$("#MapShowDetail>a").eq(1).hide(),$("#MapShowDetail>a").eq(2).hide()},setBtn1:function(){$("#MapShowDetail>a").eq(0).hide(),$("#MapShowDetail>a").eq(1).show(),$("#MapShowDetail>a").eq(2).hide()},setBtn2:function(){$("#MapShowDetail>a").eq(0).hide(),$("#MapShowDetail>a").eq(1).hide(),$("#MapShowDetail>a").eq(2).show()},openRight:function(){var e=220==$(".ex-layout-sider:visible").width()?"ex-hidden-sm":"ex-hidden";$(".ex-layout-menu").removeClass(e),$(".ex-layout-sider").removeClass(e),$(window).resize()},hiddenRight:function(){var e=220==$(".ex-layout-sider:visible").width()?"ex-hidden-sm":"ex-hidden";$(".ex-layout-menu").addClass(e),$(".ex-layout-sider").addClass(e),$(window).resize()},rightEvent:function(){var e=this;this.hiddenOnce=!1,$(".ex-right-switch.hidden").bind("click",function(){e.hiddenRight(),$(this).hide().siblings(".open").show()}),$(".ex-right-switch.open").bind("click",function(){e.openRight(),$(this).hide().siblings(".hidden").show()})}}),ES.TrackHelper={getAlarmTypeName:function(e){var t=this.getAlarmType();if(t)return t[e]},getAlarmType:function(){return{1:"紧急报警",2:"超速报警",3:"疲劳驾驶",4:"预警",5:"GNSS模块发生故障",6:"定位天线被剪断",7:"GNSS天线短路",8:"终端主电源欠压",9:"电源掉电",10:"终端LCD或显示器故障",11:"TTS模块故障",12:"摄像头故障",13:"当天累计驾驶超时",14:"超时停车",15:"进出区域",16:"进出路线",17:"路段行驶时间不足_过长",18:"路线偏离报警",19:"车辆VSS故障",20:"车辆油量异常",21:"车辆被盗",22:"车辆非法点火",23:"车辆非法位移",24:"碰撞侧翻报警",25:"SD卡异常",26:"进区域报警",27:"出区域报警",28:"超线报警",200:"重量传感器可疑故障",201:"顶棚可疑故障",107:"不按线路行驶",106:"平台超速报警",100:"未密闭",101:"超载",206:"无运输许可证",103:"正常出土",105:"可疑出土",104:"可疑消纳",102:"正常消纳",210:"非工作时间运输",211:"工地可疑出土",212:"工地正常出土",213:"消纳场可疑消纳",214:"消纳场正常消纳"}},getObjType:function(e){return e instanceof L.Rectangle?501001:e instanceof L.Polygon?501003:e instanceof L.Polyline?501004:e instanceof L.Circle?501002:1},getPosW:function(e){var t={vPos:10,aPos:20};return t.hasOwnProperty(e)?t[e]:null},getDire:function(e){var t=0;return"object"==typeof e?(t=e.Direction?e.Direction:e.dir,t=e.Direction):t=e,t>=0&&t<=15||t>345&&t<=360?"正北":t>15&&t<=75?"东北":t>75&&t<=105?"正东":t>105&&t<=165?"东南":t>165&&t<=195?"正南":t>195&&t<=255?"西南":t>255&&t<=285?"正西":t>285&&t<=345?"西北":void 0},getDateMsg:function(e){var t=(new Date).getTime(),i=t-e;if(i>864e5){var a=(t-e)/864e5;return"["+parseInt(a)+"天前]"}if(i>36e5&&i<=864e5){var o=i/36e5;return"["+parseInt(o)+"小时前]"}var o=parseInt(i/6e4);return o<=0?"":"["+parseInt(o)+"分钟前]"},getVehStatusClass:function(e){var t={};return"行驶"==e.VehicleStatus||"停车"==e.VehicleStatus||"熄火"==e.VehicleStatus?(t.cStatus="l-bd-on l-mobile-on",t.cLstClass=""):"通讯中断"==e.VehicleStatus?(t.cStatus="l-bd-off l-mobile-off",t.cLstClass="gray"):"定位失败"==e.VehicleStatus&&(t.cStatus="l-bd-off l-mobile-on",t.cLstClass="gray"),t},convertVehStatus:function(e){if(e.nGreenOn=0,e.nRedOn=0,e.nYelloOn=0,e.cLight="白灯",e.cClsLight="gray",e.attach){var t=e.attach;"True"===t.ZtLeightGreenOn&&(e.nGreenOn=1,e.cLight="绿灯",e.cClsLight="green"),"True"===t.ZtLeightRedOn&&(e.nRedOn=1,e.cLight="红灯",e.cClsLight="red"),"True"===t.ZtLeightYelloOn&&(e.nYelloOn=1,e.cLight="黄灯",e.cClsLight="yellow"),e.dWeight=t.ZtWeightValue}},getTrackDateMsg:function(e){var t=e;if(t>864e5){var i=(t/864e5).toFixed(2),a={nTime:i,cMsg:"天"};return a}if(t>36e5&&t<=864e5){var o=(t/36e5).toFixed(2),a={nTime:o,cMsg:"小时"};return a}if(t>6e4&&t<=36e5){var o=(t/6e4).toFixed(0);o<0&&(o=0);var a={nTime:o,cMsg:"分钟"};return a}var o=(t/1e3).toFixed(0);if(o<=0)return{nTime:0,cMsg:""};var a={nTime:o,cMsg:"秒"};return a}},ES.MapView.Menu=ES.Evented.extend({oOption:{bIsCreate:!0,cContainerSel:".ex-layout-main",acContainer:["ex-layout-menu","ex-theme-menu","ec-avg-md-1"],nHideWidth:40,nShowWidth:120,bShowMenu:!1},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,ES.extend(this.oMenuConfig,t.oMenuConfig),this._aoPanel=[],this.oCurPanel=null,this.initUI()},initUI:function(){var e=$('<ul class="ex-layout-menu ec-avg-md-1"></ul>');this.oOption.bIsCreate&&(e=$(this.cHTML),$(this.oOption.cContainerSel).append(e)),e.width(this.oOption.nWidth),this.oOption.bShowMenu&&e.find("span").show(),this.$_oContainer=e,this.initMenuEvent(),this.initAn()},setTitle:function(){},getRight:function(){ES.Util.reqData({data:{nModelId:this.oOption.nModelId},url:"/Active/GetActive"},this.getRightHandler,this)},getRightHandler:function(e){if(e.rtnData&&!(e.rtnData.length<=0)){for(var t=$('<ul class="ex-layout-menu ec-avg-md-1"></ul>'),i=0;i<e.rtnData.length;i++)t.append($(e.rtnData[i].Html));this.oOption.bIsCreate&&$(this.oOption.cContainerSel).append(t),t.children("li").width(this.oOption.nShowWidth),this.$_oContainer=t,this.initMenuEvent(),this.initAn()}},initMenuEvent:function(){var e=this,t=this.$_oContainer;t.find("li.level").bind("click",function(){var t=$(this).index();$(".ex-layout-menu > li").removeClass("ec-active in").eq(t).addClass("ec-active in"),e._oParent.fire("MapView:StruckBox.showBox",{oParam:{cTitle:$(this).text()}}),e._oParent.fire($(this).attr("data-band"),{oSearchParam:{cFlag:$(this).attr("data-param")}}),e.setTitle($(this).attr("lst-title"));var i={cFlag:$(this).attr("menu-flag"),cTreeUrl:$(this).attr("tree-url"),cTreeTitle:$(this).attr("tree-title"),cTreeObject:$(this).attr("tree-object"),cListObject:$(this).attr("list-object"),cListTitle:$(this).attr("list-title"),cListUrl:$(this).attr("list-url"),cCheckEventName:$(this).attr("tree-check-event"),cUncheckEventName:$(this).attr("tree-uncheck-event"),cViewUrl:$(this).attr("view-url"),cViewTitle:$(this).attr("view-title"),cViewObject:$(this).attr("view-object"),closeList:"close"!=$(this).attr("list-show")};e.createPanel(i),e._oParent.fire("MapView:MonitorMgr.initMonitor",i)}),t.find("li").not(".level").bind("click",function(){var t=$(this).index();$(".ex-layout-menu > li").removeClass("ec-active in").eq(t).addClass("ec-active in"),e._oParent.fire("MapView:StruckBox.showBox",{oParam:{cTitle:$(this).text()}});var i={cFlag:$(this).attr("data-param"),cTitle:$(this).attr("tree-title"),cObject:$(this).attr("tree-object"),cListView:$(this).attr("list-view"),cListTitle:$(this).attr("list-title"),cMonitor:$(this).attr("monitor-object"),cCheckEventName:$(this).attr("tree-check-event"),cUrl:$(this).attr("list-url")};e._oParent.fire("MapView:MonitorMgr.initMonitor",i),e.createPanel(i),e._oParent.resize(400)}),t.find("li").eq(0).click()},initAn:function(){var e=this,t=this.$_oContainer;t.bind("mouseover",function(){$(this).stop().animate({width:e.oOption.nShowWidth+"px"},100),$(this).children("li").width(e.oOption.nShowWidth),$(this).find("span").show(),e._oParent.fire("MapView:Menu.resize",{nWidth:e.oOption.nShowWidth})}),t.bind("mouseout",function(){$(this).stop().animate({width:e.oOption.nHideWidth+"px"},100),$(this).children("li").width(e.oOption.nHideWidth),$(this).find("span").hide(),e._oParent.fire("MapView:Menu.resize",{nWidth:e.oOption.nHideWidth})})},createPanel:function(e){var t=!1;if(this._aoPanel.length<=0){var i=new ES.MapView.TabPanel(this._oParent,e);return void this._aoPanel.push(i)}for(var t=!1,a=0;a<this._aoPanel.length;a++)this._aoPanel[a].cFlag===e.cFlag?(this._aoPanel[a].showBox(),t=!0):this._aoPanel[a].hideBox();if(!t){var i=new ES.MapView.TabPanel(this._oParent,e);this._aoPanel.push(i)}},getWidth:function(){return this.oCurPanel?this.oCurPanel.getWidth():340}}),ES.MapView.Menu.include({cHTML:'<ul class="ex-layout-menu ec-avg-md-1">       <li class="ec-active flip in level"            menu-flag ="deptVehView"            tree-url ="deptTree"            tree-title="组织架构"            tree-check-event="deptTree:layer"            tree-uncheck-event="undeptTree:layer"            tree-object="ES.MapView.TabPanel.TreeView"            list-object="ES.MapView.TabPanel.DeptVehLst"           list-title="车辆列表"            data-obj="ES.MapView.VehicleMonitor"           list-url="vehLstUrl"><i class="ec-icon-sitemap"></i> <span>车辆列表</span>       </li>       <li class="ec-active flip in level"            menu-flag ="attend"            list-object="ES.MapView.TabPanel.VehLst"           list-title="关注车辆"            list-url="getFollowVeh" ><i class="ec-icon-star"></i> <span>关注车辆</span>       </li>       <li class="ec-active flip in level"            menu-flag ="AlarmVehView"            list-object="ES.MapView.TabPanel.AlarmVehLst"           list-title="今日违规车辆列表"            list-url="getAlarmType"           tree-check-event ="AlarmType:Vehicle"            view-url ="AlarmType:Vehicle"            view-object="ES.MapView.TabPanel.AlarmTypes"           view-title="车辆告警类型"><i class="ec-icon-warning"></i> <span>告警分类</span>       </li>       <li class="ec-active flip in level"            menu-flag ="fenceMap"            tree-url ="FenceTree"            tree-title="围栏"            tree-check-event="fenceTree:layer"            tree-uncheck-event="unfenceTree:layer"            tree-object="ES.MapView.TabPanel.TreeView"            list-object="ES.MapView.TabPanel.VehLst"           list-title="当日经过车辆"            list-url="FenceVehLstUrl"><i class="ec-icon-map-signs"></i> <span>围栏</span>       </li>       <li class="ec-active flip in level"            menu-flag ="rectVehView"            list-object="ES.MapView.TabPanel.VehLst"           list-title="框内车辆"            list-url="RectVehLstUrl"           tree-check-event ="RectSearch:Vehicle"            view-url ="RectSearch:Vehicle"            view-object="ES.MapView.TabPanel.RectSearch"           view-title="拉框搜索"><i class="ec-icon-object-group"></i> <span>拉框搜索</span>       </li>   </ul>'}),ES.MapView.TabPanel=ES.Evented.extend({oOption:{bIsCreate:!0,cEvenName:"MapView:VehSitePanel.initVehSite",cPContainer:".ex-layout-main",cFlag:"panelFlag",cTitle:"工地搜索车辆",cEventNameTabLoad:"MapView:TabPanel.TabLoad",nListWidth:220,nTreeWidth:220,nViewWidth:280},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._oPage=e._oParent,this.$_oContainer=null,this.oListView=null,this.oStrcukBox=null,this.oViewBox=null,this.cFlag=this.oOption.cFlag,this.initOn(),this.initUI(),this.oListView&&this.oListView.$_oOpenBtn.click()},initUI:function(){this.oOption.bIsCreate&&(this.$_oContainer=$(this.cHTML),this.$_oContainer.addClass(this.oOption.cFlag),$(this.oOption.cPContainer).append(this.$_oContainer),this._oParent.fire(this.oOption.cEventNameTabLoad,{cFlag:this.oOption.cFlag}),this.initListView(),this.initPanel(),this.initView(),this.setWidth(this.oOption.nInitWidth),this.oStrcukBox||this.oViewBox||this.oListView.hideBtn(),this.oListView&&(this.oOption.closeList||this.oListView.hide()))},initView:function(){if(this.oOption.cViewObject){var oTemp=eval(this.oOption.cViewObject);this.oViewBox=new oTemp(this,{cDivContainerSel:this.$_oContainer,cCheckEventName:this.oOption.cViewUrl,cTitle:this.oOption.cViewTitle})}},initPanel:function(){if(this.oOption.cTreeObject){var oTemp=eval(this.oOption.cTreeObject);this.oStrcukBox=new oTemp(this,{cPContainer:this.$_oContainer,cTitle:this.oOption.cTreeTitle,cCheckEventName:this.oOption.cCheckEventName,cUncheckEventName:this.oOption.cUncheckEventName,cSelectEventName:this.oOption.cSelectEventName},ES.MapView.oConfig[this.oOption.cTreeUrl])}},initListView:function(){if(this.oOption.cListObject){var oTemp=eval(this.oOption.cListObject);this.oListView=new oTemp(this,{cDivContainerSel:this.$_oContainer,cTitle:this.oOption.cListTitle,nPageSize:50,cUrl:ES.MapView.oConfig[this.oOption.cListUrl],cCheckEventName:this.oOption.cCheckEventName,cUncheckEventName:this.oOption.cUncheckEventName,cSelectEventName:this.oOption.cSelectEventName});var $_oContainer=this.oListView.getPanel();this.oPager=new ES.MapView.TabPanel.LstPager(this,{nPageSize:ES.MapView.oConfig.nMaxPageSize,$_oContainer:$_oContainer,nBtnCnt:ES.MapView.oConfig.nPagerBtnCnt||8})}},initOn:function(){},getWidth:function(){return this.$_oContainer.width()},setWidth:function(e){this.$_oContainer.css({width:e}),this.nWidth=e},openTree:function(){if(this.$_oContainer){var e=0;this.oListView&&(e=this.oOption.nListWidth),this.oStrcukBox?e+=this.oOption.nTreeWidth:this.oViewBox&&(e+=this.oOption.nViewWidth),this.setWidth(e),e=$(window).width()-e-40,this._oParent.fire("MapView:LayoutContent.resize",{nWidth:e})}},closeTree:function(){if(this.$_oContainer){this.oListView&&this.setWidth(this.oOption.nListWidth);var e=this.getWidth();e=$(window).width()-e-40,this._oParent.fire("MapView:LayoutContent.resize",{nWidth:e})}},showBox:function(){if(this.$_oContainer){this.$_oContainer.show(),this.oStrcukBox&&this.oStrcukBox.onOffCtrl(!1);var e=$(window).width()-this.nWidth-40;this._oParent.fire("MapView:LayoutContent.resize",{nWidth:e})}},hideBox:function(){this.$_oContainer.hide(),this.oStrcukBox&&this.oStrcukBox.onOffCtrl(!0)}}),ES.MapView.TabPanel.include({cHTML:'<div class="ex-layout-sider ec-fr">'}),ES.MapView.TabPanel.LstPager=ES.Evented.extend({oOption:{nPage:0,nPageSize:10,nPageIndex:1,nBtnCnt:8,nTotalCnt:11},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.$_oPanel=t.$_oContainer,this.$_aoLI=this.$_oPanel.find(".ex-layout-carlist-page > ul > li"),this.calPage(),this.initBtn(),this.initUI(),this.initEven(),this.initOn(),this.nPageIndex=2},calPage:function(){this.oOption.nTotalCnt<=0?this.oOption.nPage=0:this.oOption.nTotalCnt%this.oOption.nPageSize==0?this.oOption.nPage=this.oOption.nTotalCnt/this.oOption.nPageSize:this.oOption.nPage=parseInt(this.oOption.nTotalCnt/this.oOption.nPageSize)+1},initUI:function(){var e=this.oOption.nBtnCnt,t=this.oOption.nPage,i=this.$_oPanel.find(".ex-layout-carlist-page > ul>li");if(0==t)return void i.addClass("ec-disabled");i.each(function(i){0==i||1==i?$(this).addClass("ec-disabled"):i!=e-1&&i!=e-2||t<=e-4&&$(this).addClass("ec-disabled"),e>4&&(2==i?$(this).addClass("ec-active"):i-1>t&&$(this).addClass("ec-disabled"))})},initOn:function(){this._oParent.on("MapView:Pager.reflashPager",this.reflashPager,this)},reflashPager:function(e){this.oOption.nTotalCnt=e.nTotalCnt,this.calPage(),this.initBtn(),this.initUI(),this.initEven(),this.nPageIndex=2},initEven:function(){var e=this,t=this.oOption.nBtnCnt-1,i=this.oOption.nBtnCnt-2,a=this.oOption.nBtnCnt-4,o=this.oOption.nTotalCnt,n=this.oOption.nPage,s=this.oOption.nPageSize,l=this.$_oPanel.find(".ex-layout-carlist-page > ul>li");l.eq(0).bind("click",function(){if(!$(this).hasClass("ec-disabled")){$(this).addClass("ec-disabled"),l.eq(1).addClass("ec-disabled"),n>a&&(l.eq(t).removeClass("ec-disabled"),l.eq(i).removeClass("ec-disabled")),l.removeClass("ec-active");for(var o=2;o<i;o++)l.eq(o).find("a").html(o-1),2==o&&(e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:1}}),l.eq(o).addClass("ec-active")),l.eq(o).removeClass("ec-disabled"),o>e.oOption.nPage&&l.eq(o).addClass("ec-disabled");0==a&&e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:1}}),e.nPageIndex=2}}),l.eq(t).bind("click",function(){if(!$(this).hasClass("ec-disabled")){$(this).addClass("ec-disabled"),l.eq(i).addClass("ec-disabled"),e.oOption.nPage>a&&(l.eq(0).removeClass("ec-disabled"),l.eq(1).removeClass("ec-disabled")),0==a?(e.nPageIndex=n,e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:n}})):e.nPageIndex=Math.ceil(n/a);for(var t=a*(e.nPageIndex-1),o=2;o<i;o++)t+=1,l.eq(o).find("a").html(t),2==o&&(e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:t}}),l.eq(o).addClass("ec-active")),l.eq(o).removeClass("ec-disabled"),t>n&&l.eq(o).addClass("ec-disabled");e.nPageIndex=e.nPageIndex+1}}),l.bind("click",function(){if(0!=$(this).index()&&1!=$(this).index()&&$(this).index()!=i&&$(this).index()!=t&&!$(this).hasClass("ec-disabled")){l.removeClass("ec-active"),$(this).addClass("ec-active");var a=parseInt($(this).find("a").text());e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:a}})}}),l.eq(i).bind("click",function(){if(!$(this).hasClass("ec-disabled")){if(a>0)for(var n=a*(e.nPageIndex-1),r=2;r<i;r++)n+=1,l.eq(r).find("a").html(n),l.eq(r).removeClass("ec-active"),2==r&&(e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:n}}),l.eq(r).addClass("ec-active")),l.eq(r).removeClass("ec-disabled"),n*s-o>s&&l.eq(r).addClass("ec-disabled"),n*s>o&&($(this).addClass("ec-disabled"),l.eq(t).addClass("ec-disabled")),l.eq(0).removeClass("ec-disabled"),l.eq(1).removeClass("ec-disabled");else e.nPageIndex*s<o?(l.eq(0).removeClass("ec-disabled"),l.eq(1).removeClass("ec-disabled")):($(this).addClass("ec-disabled"),l.eq(t).addClass("ec-disabled")),e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:e.nPageIndex}});e.nPageIndex=e.nPageIndex+1}}),l.eq(1).bind("click",function(){if(!$(this).hasClass("ec-disabled")){if(a>0){for(var o=a*(e.nPageIndex-3),n=2;n<i;n++)o+=1,l.eq(n).find("a").html(o),2==n&&(e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:o}}),l.eq(n).addClass("ec-active")),l.eq(n).removeClass("ec-disabled");o==a&&($(this).addClass("ec-disabled"),l.eq(0).addClass("ec-disabled")),l.eq(i).removeClass("ec-disabled"),l.eq(t).removeClass("ec-disabled")}else 3==e.nPageIndex&&($(this).addClass("ec-disabled"),l.eq(0).addClass("ec-disabled"),l.eq(i).removeClass("ec-disabled"),l.eq(t).removeClass("ec-disabled")),e._oParent.fire("MapView:VehLst.onPagerSearch",{oSearchParam:{PageIndex:e.nPageIndex-2}});e.nPageIndex=e.nPageIndex-1}})},initBtn:function(){var e=this.$_oPanel.find(".ex-layout-carlist-page > ul");e.empty();for(var t=0;t<this.oOption.nBtnCnt;t++)0!=t?1!=t?t!=this.oOption.nBtnCnt-1?t!=this.oOption.nBtnCnt-2?e.append($('<li><a href="javascript:;">'+(t-1)+"</a></li>")):e.append($('<li><a href="javascript:;"><i class="ec-icon-angle-right"></i></a></li>')):e.append($('<li><a href="javascript:;"><i class="ec-icon-angle-double-right"></a></li>')):e.append($('<li><a href="javascript:;"><i class="ec-icon-angle-left"></i></a></li>')):e.append($('<li><a href="javascript:;"><i class="ec-icon-angle-double-left"></i></a></li>'))}}),ES.MapView.TabPanel.VehLst=ES.Evented.extend({oOption:{cUrl:"",cAttentUrl:"",cDivContainerSel:"#classContainer",cLstContainerSel:".ex-layout-carlist-content",cSearchInputSel:"input.ec-form-field",cSearchBtnSel:"button.ec-btn-secondary",cCheckEventName:"MapView:DeptTreeView.getDeptId",cUncheckEventName:"MapView:UnDeptTreeView.getDeptId",selectSingleVehicleUrl:""},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._oPage=e._oParent,this.$_oLstContainer=null,this.$_oContainer=null,this.oSearchInput=null,this.oSearchBtn=null,this.anDeptId=null,this.initOn(),"object"==typeof this.oOption.cDivContainerSel?this.$_oContainer=this.oOption.cDivContainerSel:this.$_oContainer=$(this.oOption.cDivContainerSel),this.initUI()},initUI:function(){this.$_oStruck=$(this.cHtml),this.$_oContainer.append(this.$_oStruck),this.$_oLstContainer=this.$_oStruck.find(this.oOption.cLstContainerSel),this.oSearchInput=this.$_oStruck.find(this.oOption.cSearchInputSel),this.oSearchBtn=this.$_oStruck.find(this.oOption.cSearchBtnSel),this.$_oOpenBtn=this.$_oStruck.find("a.ex-icon-turn.on"),this.$_oCloseBtn=this.$_oStruck.find("a.ex-icon-turn.off"),this.$_oTitle=this.$_oStruck.find("h4"),this.$_oTitle.html(this.oOption.cTitle+'<span style="margin-left: 2em;"></span>'),this.initSearchEvent();var e=this;"attend"==this._oParent.cFlag&&this.initData(1,function(t){var i=e.toModle(t);e.$_oTitle.find("span").text(t.detail.total+" 辆"),e.vehHandler(i),e.initPager(t)}),this.initEvent()},toModle:function(e){var t=[];if(!e||!e.detail||!e.detail.list||e.detail.list.length<=0)return t;for(var i=0;i<e.detail.list.length;i++){var a=e.detail.list[i],o={id:a.id,vehNo:a.vehNo,devNo:a.devNo,latLng:{lat:a.vehGpsData.Poi.MapPoint.Lat,lng:a.vehGpsData.Poi.MapPoint.Lon},gpsDate:a.vehGpsData.GpsDateTime,dir:a.vehGpsData.Direction,poi:a.vehGpsData.Poi.Address,speed:a.vehGpsData.Speed,status:a.vehGpsData.Status,currentState:a.vehGpsData.VehStatusString,mile:(a.vehGpsData.Mileage/1e3).toFixed(2),gpsTime:1e3*a.vehGpsData.GpsTime,cameraNum:a.cameraNum};t.push(o)}return t},getPanel:function(){return this.$_oStruck},initData:function(e,t){ES.Util.loadAn(this.$_oLstContainer);var i={veh_no:this.oSearchInput.val(),status:[1,2,3,4,5]};this.anDeptId&&ES.extend(i,{deptIds:this.anDeptId});var a={searchModel:i,editModel:{},pageIndex:e,pageSize:ES.MapView.oConfig.nMaxPageSize};ES.getData(JSON.stringify(a),this.oOption.cUrl,t,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},initEvent:function(){var e=this;this.$_oOpenBtn.bind("click",function(){e.$_oStruck.css({opacity:"1"}),e.$_oCloseBtn.show(),$(this).hide(),e._oParent.openTree()}),this.$_oCloseBtn.bind("click",function(){e.$_oStruck.css({opacity:"1"}),e.$_oOpenBtn.show(),$(this).hide(),e._oParent.closeTree(),e._oParent._oParent.fire("MapView:LayoutContent.resize",{nWidth:$(window).width()-260})})},getWidth:function(){return this.$_oStruck.offset().left<=80?0:this.$_oStruck.width()},initSearchEvent:function(){var e=this;this.oSearchBtn.bind("click",function(){e.initData(1,function(t){var i=e.toModle(t);e.$_oTitle.find("span").text(t.detail.total+" 辆"),e.vehHandler(i),e.initPager(t)})});var t=!1;this.oSearchInput.keyup(function(){t&&clearTimeout(t),t=setTimeout(function(){e.initData(1,function(t){var i=e.toModle(t);e.$_oTitle.find("span").text(t.detail.total+" 辆"),e.vehHandler(i),e.initPager(t)})},500)})},show:function(){this.$_oStruck.show()},hide:function(){this.$_oStruck.hide()},initOn:function(){this._oParent.on("MapView:VehLst.onPagerSearch",this.pagerSearch,this),this._oParent.on("MapView:VehLst.initVehLst",this.initVehLst,this),this.oOption.cCheckEventName&&this._oPage.on(this.oOption.cCheckEventName,this.initVehLst,this),this.oOption.cUncheckEventName&&this._oPage.on(this.oOption.cUncheckEventName,this.initVehLst,this),this.oOption.cSelectEventName&&this._oPage.on(this.oOption.cSelectEventName,this.initVehData,this),"attend"==this._oParent.cFlag&&this._oPage.on("MapView:VehLst.refreshConcern",this.initVehLst,this)},initVehData:function(e){},initVehLst:function(e){var t=[];if(e.acId&&e.acId.length>0)for(var i=0;i<e.acId.length;i++)t.push(parseInt(e.acId[i]));this.anDeptId=t;var a=this;this.initData(1,function(e){var t=a.toModle(e);e&&e.detail?(a.$_oTitle.find("span").text(e.detail.total+" 辆"),a.vehHandler(t),a.initPager(e)):ES.Util.removeAn(this.$_oLstContainer)})},pagerSearch:function(e){if(e&&e.oSearchParam&&e.oSearchParam.PageIndex){var t=this;this.initData(e.oSearchParam.PageIndex,function(e){var i=t.toModle(e);t.vehHandler(i)})}}}),ES.MapView.TabPanel.VehLst.include({vehHandler:function(e){if(ES.Util.removeAn(this.$_oLstContainer),e){var t=this.initVehItems(e);t&&(this.vehItemEvent(t),this.initVehByAnimate(t),this.initAttendEvent(),this.initAttend())}},initVehLocal:function(e){var t=e.find("li");if(t&&!(t.length<=0)){for(var i=[],a=0;a<t.length;a++){var o=$(t[a]).data("data");o&&i.push(o.devNo)}ES.getData({devNos:i},ES.MapView.oConfig.curPosUrl,this.curPosHandler,this)}},curPosHandler:function(e){if(e){var t=this._oPage.toHeartModle(e),i=this;this.$_oLstContainer.find("li").each(function(){var e=$(this).data("data");if(!e)return!0;for(var a=0;a<t.length;a++)if(t[a].devNo===e.devNo){$(this).find(".carlist-title > p.time").html(t[a].gpsDate),t[a].id=e.id,$(this).data("data",t[a]);var o=i.getTruckCls(t[a]);$(this).find(".carlist-card>i").removeClass("green").removeClass("yellow").removeClass("gray").addClass(o);break}})}},getTruckCls:function(e){return"truck "+("行驶"==e.currentState||"停车"==e.currentState||"熄火"==e.currentState?"green":"gray")},initVehItems:function(e){var t=$("<ul></ul>");if(!e||e.length<=0)return void this.initVehByAnimate(t);for(var i=0;i<e.length;i++){var a="";e[i].cCls=this.getTruckCls(e[i]),a=e[i].cCls.indexOf("gray")>-1?ES.Util.template(this.cItemNoVideoHtml,e[i]):ES.Util.template(this.cItemHtml,e[i]);var o=$(a);o.data("data",e[i]),t.append(o)}return t},vehItemEvent:function(e){var t=this;e.find("li").each(function(){$(this).find("a").eq(0).bind("click",$(this),function(e){var t=e.data.data("data");window.open("/mapViewHtml/html/trackview.html?token="+ES.MapView.oConfig.token+"&PhoneNum="+t.devNo+"&VehicleNo="+t.vehNo)}),$(this).find("a").eq(1).bind("click",$(this),function(e){e.stopPropagation();var i=e.data.data("data");t._oPage.fire("MapView:VehDetail.showDetail",{oGpsInfo:i}),t._oPage.fire("HubSvr.unsubGps",{aoGpsInfo:[i]}),t._oPage.fire("MapView:LiveMange.removeAll"),t._oPage.fire("HubSvr.subGps",{aoGpsInfo:[i]}),t._oPage.fire("HubSvr.unSubAlarm"),t._oPage.fire("HubSvr.subAlarm",{aoGpsInfo:i})}),$(this).find("a").eq(2).bind("click",$(this),function(e){var i=e.data.data("data");t._oParent.orderVehicleDialog=new ES.Common.AddType(t._oParent,{bRemove:!0},{title:"下发指令",content:'<div class="ex-command-tabs modelType">           <ul class="ex-command-tab ec-avg-sm-3">               <li data-index="1"><i class="ec-icon-btn ec-primary ec-icon-database"></i><span>拍照</span></li>               <li data-index="2"><i class="ec-icon-btn ec-primary ec-icon-life-ring"></i><span>点名</span></li>               <li data-index="3"><i class="ec-icon-btn ec-primary ec-icon-search"></i><span>语音文字</span></li>           </ul>         </div>'}),t._oParent.orderVehicleDialog.del(i)}),$(this).find("a").eq(3).bind("click",$(this),function(e){ES.aSucess("视频页面");var t=e.data.data("data");window.open("/mapViewHtml/html/video.html?token="+ES.MapView.oConfig.token+"&PhoneNum="+t.devNo+"&VehicleNo="+t.vehNo+"&cameraNum="+t.cameraNum)})}),e.find("li").bind("click",function(){var e=$(this).data("data");$(this).siblings().removeClass("ec-active"),$(this).addClass("ec-active"),t._oPage.fire("MapView:LiveMange.addLivePos",{oGpsInfo:e}),"0px"===$("#MapShowDetail").css("bottom")&&(t._oPage.fire("HubSvr.unSubAlarm"),t._oPage.fire("HubSvr.subAlarm",{aoGpsInfo:e}),t._oPage.fire("HubSvr.unsubGps",{aoGpsInfo:[e]}),t._oPage.fire("HubSvr.subGps",{aoGpsInfo:[e]})),t._oPage._oMap.flyTo(e.latLng,16),t._oPage.fire("MapView:VehDetail.switchDetail",{oGpsInfo:e})})},getVehItemConfig:function(e,t){return e.cGpsDate=ES.Util.dateFormat(1e3*(e.GpsTime?e.GpsTime:946684800),"yyyy-MM-dd hh:mm:ss"),{div:[{i:{class:"icon-car-pin green",html:t},div:{class:"carlist-title",h2:{html:e.VehicleNo},p:{html:e.cGpsDate}}},{class:"carlist-bottom",div:{class:"carlist-btn",a:[{class:"ec-btn ec-btn-xs ec-round ec-btn-secondary ex-btn-moredetail",href:"javascript:void(0)",html:"跟踪"},{class:"ec-btn ec-btn-xs ec-round ec-btn-default",href:"javascript:void(0)",html:"轨迹"},{class:"ec-btn ec-btn-xs ec-round ec-btn-default",href:"javascript:void(0)",html:"消息"}]}}]}},initVehByAnimate:function(e){var t=this.$_oLstContainer.find("ul>li");t&&t.length>0&&this._oPage.fire("MapView:LiveMange.removeAll"),this.$_oLstContainer.find("ul").remove(),this.$_oLstContainer.append(e),e.find("li").hide().each(function(){var e=$(this),t=$(this).index();setTimeout(function(){e.show().addClass("in")},100*t)})},initPager:function(e){this._oParent.fire("MapView:Pager.reflashPager",{nTotalCnt:e.detail.total})},hideBtn:function(){this.$_oOpenBtn.hide(),this.$_oCloseBtn.hide()}}),ES.MapView.TabPanel.VehLst.include({initAttend:function(){var e=[];if(this.$_oLstContainer.find("li").each(function(){var t=$(this).data("data");if(!t)return!0;e.push(t.id)}),!(e.length<=0)){var t={searchModel:{vehicleids:e},editModel:{},buttonId:0,pageIndex:1,pageSize:2e3};ES.getData(JSON.stringify(t),ES.MapView.oConfig.getFollowVehIds,function(e){if(e&&1===e.code&&e.detail&&e.detail.list&&!(e.detail.list.length<=0))for(var t=0;t<e.detail.list.length;t++){var i=e.detail.list[t];this.$_oLstContainer.find("li").each(function(){var e=$(this).data("data");return!e||!e.hasOwnProperty("id")||(e.id===i.id?($(this).find("em.ec-icon-star").parent().addClass("carlist-fav"),!1):void 0)})}},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}},initAttendEvent:function(){var e=this;this.$_oLstContainer.find(".ec-icon-star").parent().bind("click",function(){var t=$(this).parent().parent().data("data");t&&($(this).hasClass("carlist-fav")?e.delAttend($(this),t):e.addAttend($(this),t))})},delAttend:function(e,t){if(e){var i=this,a={content:"确认要取消车辆["+t.vehNo+"]关注吗？",okValue:"确定",ok:function(){var a={searchModel:{},editModel:{vehNo:t.vehNo},buttonId:4,pageIndex:1,pageSize:20}
;ES.getData(JSON.stringify(a),ES.MapView.oConfig.getFollowVehIds,function(t){t&&1===t.code&&(e.removeClass("carlist-fav"),i._oPage.fire("MapView:VehLst.refreshConcern"))},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},cancelValue:"取消",cancel:null};this.initConfirmWnd(a).showModal()}},addAttend:function(e,t){if(e){var i=this,a={searchModel:{},editModel:{vehNo:t.vehNo},buttonId:2,pageIndex:1,pageSize:20};ES.getData(JSON.stringify(a),ES.MapView.oConfig.getFollowVehIds,function(t){t&&1===t.code&&(e.addClass("carlist-fav"),i._oPage.fire("MapView:VehLst.refreshConcern"))},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}},initConfirmWnd:function(e){var t={title:"提示",content:"是否删除数据",okValue:"确定",ok:null,cancelValue:"取消",cancel:null};return ES.Util.extend(t,e),dialog(t)}}),ES.MapView.TabPanel.VehLst.include({cHtml:'<div class="ex-layout-carlist">   <div class="ex-layout-carlist-title">       <h4 class="ec-align-left">车辆列表 [共4000辆]</h4>       <a href="javascript:;" class="ex-icon-turn on" ><i class="ec-icon-arrow-circle-left"></i></a>       <a href="javascript:;" class="ex-icon-turn off" style="display:none;"><i class="ec-icon-arrow-circle-right"></i></a>   </div>   <div class="ex-layout-carlist-wrap">       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field" placeholder="请输入车牌号或设备号">               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs" type="button"><span class="ec-icon-search"></span> </button>               </span>           </div>       </div>       <div class="ex-layout-carlist-content"></div>   </div>   <div class="ex-layout-carlist-page">       <ul class="ec-pagination ec-pagination-center">           <li class="ec-disabled"><a href="javascript:;">&laquo;</a></li>           <li class="ec-active"><a href="javascript:;">1</a></li>           <li><a href="javascript:;">2</a></li>           <li><a href="javascript:;">3</a></li>           <li><a href="javascript:;">4</a></li>           <li><a href="javascript:;">5</a></li>           <li><a href="javascript:;">&raquo;</a></li>       </ul>   </div></div>',cItemHtml:'<li class="slideup in" style="display: list-item;">   <div class="carlist-card">       <i class="{cCls}"></i>       <div class="carlist-title">           <h2 class="num">{vehNo}</h2>           <p class="time">{gpsDate}</p>       </div>       <div class="">           <em class="ec-icon-star" style="float: right;"></em>       </div>       <div class="clearfix"></div>   </div>   <div class="carlist-bottom">       <div class="carlist-btn ex-vehicle-list-4">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">轨迹</a>       </div>       <div class="carlist-btn ex-vehicle-list-4">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">详情</a>       </div>       <div class="carlist-btn ex-vehicle-list-4">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">下发指令</a>       </div>       <div class="carlist-btn ex-vehicle-list-4">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">视频</a>       </div>       <div class="clearfix"></div>   </div></li>',cItemNoVideoHtml:'<li class="slideup in" style="display: list-item;">   <div class="carlist-card">       <i class="{cCls}"></i>       <div class="carlist-title">           <h2 class="num">{vehNo}</h2>           <p class="time">{gpsDate}</p>       </div>       <div class="">           <em class="ec-icon-star" style="float: right;"></em>       </div>       <div class="clearfix"></div>   </div>   <div class="carlist-bottom">       <div class="carlist-btn ex-vehicle-list-3">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">轨迹</a>       </div>       <div class="carlist-btn ex-vehicle-list-3">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">详情</a>       </div>       <div class="carlist-btn ex-vehicle-list-3">               <a class="ec-btn ec-btn-xs ec-round ec-btn-default" href="javascript:void(0);">下发指令</a>       </div>       <div class="clearfix"></div>   </div></li>'}),ES.MapView.TabPanel.DeptVehLst=ES.MapView.TabPanel.VehLst.extend({initEvent:function(){var e=this,t=this.$_oStruck.find(".ex-layout-carlist-query");this.$_oOpenBtn.bind("click",function(){e.$_oStruck.css({opacity:"1"}),e.$_oCloseBtn.show(),$(this).hide(),e._oParent.openTree()}),this.$_oCloseBtn.bind("click",function(){e.$_oStruck.css({opacity:"1"}),e.$_oOpenBtn.show(),$(this).hide(),e._oParent.closeTree()}),t.bind("mouseover",function(){$(this).children(".ec-dropdown-content").show()}),t.bind("mouseout",function(){$(this).children(".ec-dropdown-content").hide()}),t.find('input[type="checkbox"]').bind("click",function(){e.initData(1,function(t){var i=e.toModle(t);e.$_oTitle.find("span").text(t.detail.total+" 辆"),e.vehHandler(i),e.initPager(t)})}),this.$_oStruck.find(".ec-dropdown-content").on("click","a",function(){var e=$(this).children("i").attr("class");t.children("i").attr("class",e)}),this.$_oStruck.find('input[type="checkbox"]').uCheck()},initData:function(e,t){ES.Util.loadAn(this.$_oLstContainer);var i=[];this.$_oStruck.find(".ex-layout-carlist-query").find('input[type="checkbox"].speed').is(":checked")&&i.push(1),this.$_oStruck.find(".ex-layout-carlist-query").find('input[type="checkbox"].stop').is(":checked")&&i.push(2),this.$_oStruck.find(".ex-layout-carlist-query").find('input[type="checkbox"].acc').is(":checked")&&i.push(3),this.$_oStruck.find(".ex-layout-carlist-query").find('input[type="checkbox"].local').is(":checked")&&i.push(4),this.$_oStruck.find(".ex-layout-carlist-query").find('input[type="checkbox"].lost').is(":checked")&&i.push(5);var a={veh_no:this.oSearchInput.val(),status:i};this.anDeptId&&ES.extend(a,{deptIds:this.anDeptId});var o={searchModel:a,editModel:{},pageIndex:e,pageSize:ES.MapView.oConfig.nMaxPageSize};ES.getData(JSON.stringify(o),this.oOption.cUrl,t,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}}),ES.MapView.TabPanel.DeptVehLst.include({cHtml:'<div class="ex-layout-carlist">   <div class="ex-layout-carlist-title">       <h4 class="ec-align-left">车辆列表 [共4000辆]</h4>       <a href="javascript:;" class="ex-icon-turn on" ><i class="ec-icon-arrow-circle-right"></i></a>       <a href="javascript:;" class="ex-icon-turn off" style="display:none;"><i class="ec-icon-arrow-circle-left"></i></a>   </div>   <div class="ex-layout-carlist-wrap">       <div class="ex-layout-struckbox-search">           <div class="ec-input-group"  style="width:80%; float:left">               <input type="text" class="ec-form-field" placeholder="请输入车牌号或设备号">               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs" type="button"><span class="ec-icon-search"></span> </button>               </span>           </div>            <div class="ex-layout-carlist-query">                <i class="ex-maptool-icon truck green"></i>               <ul class="ec-avg-sm-1 ec-dropdown-content">                   <li><a href="javascript:void(0);"> <label class="ec-checkbox-inline"><input type="checkbox" checked="checked"  class="ec-ucheck-checkbox speed" />                            <i class="ex-maptool-icon truck green"></i> &nbsp;行驶车辆  </label>                        </a>                    </li>                   <li><a href="javascript:void(0);"><label class="ec-checkbox-inline"><input type="checkbox" checked="checked"  class="ec-ucheck-checkbox stop" />                            <i class="ex-maptool-icon truck green"></i>&nbsp;停车车辆</label>                       </a>                   </li>                   <li><a href="javascript:void(0);"><label class="ec-checkbox-inline"><input type="checkbox" checked="checked"  class="ec-ucheck-checkbox acc" />                            <i class="ex-maptool-icon truck green"></i>&nbsp;熄火车辆</label></a>                   </li>                   <li><a href="javascript:void(0);"><label class="ec-checkbox-inline"><input type="checkbox" checked="checked" class="ec-ucheck-checkbox local" />                        <i class="ex-maptool-icon truck red"></i>&nbsp;定位失败</label></a>                   </li>                   <li><a href="javascript:void(0);"><label class="ec-checkbox-inline"><input type="checkbox" checked="checked" class="ec-ucheck-checkbox lost" />                        <i class="ex-maptool-icon truck gray"></i>&nbsp;通讯中断</label></a>                   </li>               </ul>           </div>           <div class="clearfix"></div>       </div>       <div class="ex-layout-carlist-content"></div>   </div>   <div class="ex-layout-carlist-page">       <ul class="ec-pagination ec-pagination-center">           <li class="ec-disabled"><a href="javascript:;">&laquo;</a></li>           <li class="ec-active"><a href="javascript:;">1</a></li>           <li><a href="javascript:;">2</a></li>           <li><a href="javascript:;">3</a></li>           <li><a href="javascript:;">4</a></li>           <li><a href="javascript:;">5</a></li>           <li><a href="javascript:;">&raquo;</a></li>       </ul>   </div></div>'}),ES.MapView.TabPanel.AlarmVehLst=ES.MapView.TabPanel.VehLst.extend({initData:function(e,t){ES.Util.loadAn(this.$_oLstContainer);var i={menu_id:1882,alermType:this.anDeptId[0]},a={searchModel:i,editModel:{},buttonId:3,pageIndex:e,pageSize:ES.MapView.oConfig.nMaxPageSize};ES.getData(JSON.stringify(a),this.oOption.cUrl,t,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}}),ES.MapView.TabPanel.TreeView=ES.Evented.extend({oOption:{cUrl:"",cPContainer:"#classContainer",cTreeContainerSel:".ex-layout-struckbox-content",cSearchInputSel:".ex-tree-search-ipt",cSearchBtnSel:".ex-tree-search-btn",cDragBox:"ex-layout-drag-box",reqVehDataUrl:"http://api.bdlbs.comlbs.com/bb/map/mapview"},initialize:function(e,t,i){this.oTreeOption=i,ES.setOptions(this,t),this._oParent=e,this._oPage=e._oParent,this.oTree=null,this.$_oTreeContainer=null,this.$_oSearchInput=null,this.$_oSearchBtn=null,this.bCheck=!0,this.initOn(),"object"==typeof this.oOption.cPContainer?this.$_oPContainer=this.oOption.cPContainer:this.$_oPContainer=$(this.oOption.cPContainer),this.initUI()},initUI:function(){this.$_oStruck=$(this.cHtml),this.$_oPContainer.append(this.$_oStruck),this.show(),this.$_oTreeContainer=this.$_oStruck.find(this.oOption.cTreeContainerSel),this.$_oSearchInput=this.$_oStruck.find(this.oOption.cSearchInputSel),this.$_oSearchBtn=this.$_oStruck.find(this.oOption.cSearchBtnSel),this.$_oDragBox=this.$_oStruck.find(this.oOption.cDragBox),this.$_OpenBtn=this.$_oStruck.find("a.ex-icon-turn.off"),this.$_CloseBtn=this.$_oStruck.find("a.ex-icon-turn.on"),this.$_oStruck.find("h4").html(this.oOption.cTitle),this.initSearchEvent(),this.initTree(),this.$_OpenBtn.hide(),this.$_CloseBtn.show();var e=this;this.$_OpenBtn.bind("click",function(){e._oParent.showBox(),e.$_CloseBtn.show(),$(this).hide()}),this.$_CloseBtn.bind("click",function(){e._oParent.hideBox(),e.$_OpenBtn.show(),$(this).hide()})},onOffCtrl:function(e){e?(this.$_CloseBtn.hide(),this.$_OpenBtn.show()):(this.$_CloseBtn.show(),this.$_OpenBtn.hide())},initSearchEvent:function(){var e=this;this.$_oSearchBtn.bind("click",function(){if(e.oPopTree){var t=e.$_oSearchInput.val();e.$_oTree.search(t,!1,!1)}});var t=!1;this.$_oSearchInput.keyup(function(){t&&clearTimeout(t),t=setTimeout(function(){var t=e.$_oSearchInput.val();e.$_oTree.search(t,!1,!1)},250)})},removeDrawSite:function(e){var t=this.oPopTree.getSelfChildNode(e);this._oPage.fire("MV:Site.clearSites",{anId:t})},drawCheckSite:function(){var e=this.oPopTree.getTreeCheckNode();!e||e.length<=0||ES.getData({anSiteId:e},ES.MapView.oConfig.cSiteInfoUrl,this.drawSite,this)},drawOneSite:function(e){ES.getData({anSiteId:[e]},ES.MapView.oConfig.cSiteInfoUrl,this.drawSite,this)},initCheckHandler:function(){var e=this;this.oPopTree.checkCallBack=function(t,i){if(e.bCheck)if(i.node.children&&i.node.children.length>0)e.drawCheckSite();else{var a=i.node.id;e.drawOneSite(parseInt(a.replace("s","")))}}},clearTree:function(){this.oPopTree.uncheckAll(),this.initCheckHandler()},show:function(){this.$_oStruck.show()},hide:function(){this.$_oStruck.hide()},drawSite:function(e){this._oPage.fire("MV:Site.setSiteData",{aoSiteInfo:e})},drawSingleMarker:function(e){this._oPage.fire("MV:Marker.setSingleMarker",e)},initOn:function(){this._oParent.on("MapView:Struct.show",this.show,this),this._oParent.on("MapView:Struct.hide",this.hide,this),this._oPage.on("MapView:SiteStatic.Select",this.selectNode,this)},selectNode:function(e){if(this.oPopTree&&e&&e.anLst&&(this.oPopTree.uncheckAll(),!(e.anLst<=0))){var t=e.anLst.map(function(e){return"s"+e});this.bCheck=!1,this.oPopTree.setCheckNode(t),this.bCheck=!0,this.drawCheckSite()}},initTreeTitle:function(){this.$_oStruck.find("a").each(function(){$(this).attr("title",$(this).text())})}}),ES.MapView.TabPanel.TreeView.include({cHtml:'<div class="ex-layout-struckbox">   <div class="ex-layout-struckbox-title">       <h4 class="ec-align-left">车辆区域</h4>       <a href="javascript:;" class="ex-icon-turn"><i class="ec-icon-times-circle" style="display: none"></i></a>   </div>   <div class="ex-layout-struckbox-wrap">       <div class="ex-layout-struckbox-search">           <div class="ec-input-group">               <input type="text" class="ec-form-field ex-tree-search-ipt" placeholder="请输入关键字">               <span class="ec-input-group-btn">                   <button class="ec-btn ec-btn-secondary ec-btn-xs ex-tree-search-btn" type="button"><span class="ec-icon-search"></span></button>               </span>           </div>       </div>       <div class="ex-layout-struckbox-content"></div>       <div class="ex-layout-advance-search" style="display:none;">       </div>   </div></div>'}),ES.MapView.TabPanel.TreeView.include({initTree:function(){this.oTree=this.$_oTreeContainer.jstree(this.oTreeOption),this.$_oTree=this.$_oTreeContainer.jstree(!0),this.initTreeEvent(),this.initCheckEven()},initTreeEvent:function(){var e=this;this.oTree.on("ready.jstree",function(t,i){e.readyCallBack&&e.readyCallBack(t,i)}),this.oTree.on("after_open.jstree",function(t,i){e.afterOpen&&e.afterOpen(t,i)}),this.oTree.on("refresh.jstree",function(t,i){e.refreshCallBack&&e.refreshCallBack(t,i)}),this.oTree.on("select_node.jstree",function(t,i){e.selectCallBack&&e.selectCallBack(t,i)}),this.oTree.on("changed.jstree",function(t,i){e.changedCallBack&&e.changedCallBack(t,i)}),this.oTree.on("dblclick.jstree",function(t,i){e.dblclickCallBack&&e.dblclickCallBack(t,i)})},initCheckEven:function(){var e=this;this.oTree.on("check_node.jstree",function(t,i){e.checkCallBack&&e.checkCallBack(t,i)}),this.oTree.on("uncheck_node.jstree",function(t,i){e.uncheckCallBack&&e.uncheckCallBack(t,i)}),this.oTree.on("check_all.jstree",function(t,i){e.checkAllCallBack&&e.checkAllCallBack(t,i)}),this.oTree.on("uncheck_all.jstree",function(t,i){e.uncheckAllCallBack&&e.uncheckAllCallBack(t,i)})},getCheckId:function(){var e=this.oOption.cPrefix,t=this.$_oTree.get_checked();if(!t||t.length<=0)return[];return e?t.map(function(t){if(0===t.indexOf(e))return t}):t},getSelfChildId:function(e){var t=[];if(e){if(t.push(e.id),!e.children||e.children.length<=0)return i?0===t[0].indexOf(i)?t[0]:[]:t;$.merge(t,e.children_d);var i=this.oOption.cPrefix;return i?$.grep(t,function(e,t){if(0===e.indexOf(i))return!0}):t}},getSelfChildNode:function(e){var t=[];if(e){var i=[];if(t.push(e.id),!e.children||e.children.length<=0)return a?0===t[0].indexOf(a)&&i.push(this.$_oTree.get_node(t[0])):i.push(this.$_oTree.get_node(t[0])),i;$.merge(t,e.children_d);for(var a=this.oOption.cPrefix,o=0;o<t.length;o++)a?0===t[o].indexOf(a)&&i.push(this.$_oTree.get_node(t[o])):i.push(this.$_oTree.get_node(t[o]));return i}},checkCallBack:function(e,t){this._oPage.fire(this.oOption.cCheckEventName,{acId:this.getCheckId()})},uncheckCallBack:function(e,t){this._oPage.fire(this.oOption.cUncheckEventName,{acId:this.getCheckId(),acUncheckId:this.getSelfChildId(t.node)})},checkAllCallBack:function(){this._oPage.fire(this.oOption.cCheckEventName,{acId:this.getCheckId()})},uncheckAllCallBack:function(){this._oPage.fire(this.oOption.cUncheckEventName,{acId:this.getCheckId(),acUncheckId:this.getSelfChildId(oNode.node)})},uncheckAll:function(){this.$_oTree&&this.$_oTree.uncheck_all&&this.$_oTree.uncheck_all()},checkAll:function(){this.$_oTree&&this.$_oTree.check_all&&this.$_oTree.check_all()},setCheckNode:function(e){if(e&&!(e.length<=0))for(var t=0;t<e.length;t++)this.$_oTree.check_node(this.$_oTree.get_node(e[t]))},selectCallBack:function(e,t){this.getVehicleData(t.node)},getVehicleData:function(e){var t=this;if(e.id.indexOf("-")>-1){var i={searchModel:{veh_no:e.text,deptIds:[parseInt(e.parent)],status:[1,2,3,4,5]},editModel:{},pageIndex:1,pageSize:10};ES.getData(JSON.stringify(i),this.oOption.reqVehDataUrl,function(e){if(1!=e.code)return void ES.aWarn("未查询到车辆信息！");for(var i=0;i<e.detail.list.length;i++){var a={lat:e.detail.list[i].vehGpsData.Lat,lng:e.detail.list[i].vehGpsData.Lon};e.detail.list[i].latLng=a,t.drawSingleMarker(e.detail.list[i])}},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}}}),ES.MapView.TabPanel.RectSearch=ES.Evented.extend({initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._oPage=e._oParent,this.$_oContainer=null,this.initOn(),"object"==typeof this.oOption.cDivContainerSel?this.$_oContainer=this.oOption.cDivContainerSel:this.$_oContainer=$(this.oOption.cDivContainerSel),this.initUI()},initOn:function(){},initEvent:function(){var e=this;this.$_SearchBtn.on("click",function(){0==e.$_oStruck.siblings().width()&&e.$_oStruck.siblings().find("a.ex-icon-turn.on").click(),0==e.restTimeType?(e.oParam.StartTs=$("#RectBeginTime").val(),e.oParam.EndTs=$("#RectEndTime").val()):(e.oParam.StartTs=e.desendMinutes(new Date,5).Format("yyyy-MM-dd HH:mm:ss"),e.oParam.EndTs=(new Date).Format("yyyy-MM-dd HH:mm:ss")),e.saveSearch()}),this.$_restType.on("click","button.edit",function(){$(this).hide().siblings().show(),e.DrawRect()}),this.$_restType.on("click","button.clear",function(){$(this).hide().siblings().show(),e.reSetSearch()}),this.$_restTimeType.on("click","button",function(){$(this).removeClass("white").siblings().addClass("white");var t=$(this).parent().siblings("div.ex-rect-time-history");0==$(this).index()?(e.restTimeType=0,t.find(".ex-rect-time").show().siblings(".ex-rect-time-now").hide()):(e.restTimeType=1,t.find(".ex-rect-time-now").show().siblings(".ex-rect-time").hide())}),$("#RectBeginTime").click(function(){WdatePicker({dateFmt:"yyyy-MM-dd HH:mm:ss",isShowClear:!1,maxDate:"#F{$dp.$D('RectEndTime')}"})}),$("#RectEndTime").click(function(){WdatePicker({dateFmt:"yyyy-MM-dd HH:mm:ss",isShowClear:!1,minDate:"#F{$dp.$D('RectBeginTime')}"})}),this._oPage.on("RectSearch:setLayerGps",this.setLayerGps,this)},DrawRect:function(){this._oPage.fire("RectView:layer")},setLayerGps:function(e){this.oParam=e.oParam,this.$_SearchBtn.removeClass("ec-disabled")},saveSearch:function(){this._oPage.fire(this.oOption.cCheckEventName,{Data:this.oParam})},reSetSearch:function(){this._oPage.fire("unRectView:layer"),this._oPage.fire("unVehicleLine:layer"),this._oPage.fire(this.oOption.cCheckEventName,{Data:{}}),this.$_SearchBtn.addClass("ec-disabled")},initUI:function(){this.$_oStruck=$(this.cHtml),this.$_oContainer.append(this.$_oStruck),this.$_oTitle=this.$_oStruck.find("h4"),this.$_oTitle.html(this.oOption.cTitle),this.$_SearchBtn=this.$_oStruck.find("#rectSearch"),this.$_restType=this.$_oStruck.find(".ex-btn-restType"),this.$_restTimeType=this.$_oStruck.find(".ex-rect-time-select"),this.initEvent(),this.restTimeType=0,this.oParam={}},desendMinutes:function(e,t){t=parseInt(t);var i=60*t*1e3;return i=parseInt(i),new Date(Date.parse(e)-i)}}),ES.MapView.TabPanel.RectSearch.include({cHtml:'<div class="ex-layout-carlist" style="width:280px">   <div class="ex-layout-carlist-title">       <h4 class="ec-align-left"></h4>   </div>   <div class="ex-layout-carlist-wrap">      <div class="ex-rect-box">           <ul>               <li>                   <div class="ec-btn-group ex-btn-restType">                       <button type="button" class="ec-btn ec-btn-primary ec-btn-block ec-radius white edit"> 绘制矩形拉框 </button>                       <button type="button" class="ec-btn ec-btn-primary ec-btn-block ec-radius clear" style="display:none;margin: 0;"> 清除拉框 </button>                   </div>               </li>               <li>                   <h2>查询时间：</h2>                   <div class="ec-btn-group ex-rect-time-select">                       <button type="button" class="ec-btn ec-btn-primary ec-round">查询历史</button>                       <button type="button" class="ec-btn ec-btn-primary ec-round white">查询实时</button>                   </div>                   <div class="ex-rect-time-history">                       <div class="ex-rect-time">                           <label for="">开始时间</label>                           <div class="ec-input-group ec-input-group-sm date ec-form-datetime">                               <input size="16" type="text" value="" id="RectBeginTime" class="ec-form-field" ">                               <span class="ec-input-group-label add-on"><i class="icon-th ec-icon-calendar"></i></span>                           </div>                       </div>                       <div class="ex-rect-time">                           <label for="">结束时间</label>                           <div class="ec-input-group ec-input-group-sm date ec-form-datetime">                               <input size="16" type="text" value="" id="RectEndTime" class="ec-form-field" ">                               <span class="ec-input-group-label add-on"><i class="icon-th ec-icon-calendar"></i></span>                           </div>                       </div>                       <div class="ex-rect-time-now">                           <h3>查询当前时间五分钟内的车辆列表</h3>                       </div>                   </div>               </li>               <li>                   <a type="button"  class="ec-btn ec-btn-success ec-radius ec-btn-block ec-disabled" id="rectSearch"><i class="ec-icon-search"></i>&nbsp;&nbsp;查&nbsp;&nbsp;&nbsp;&nbsp;询</a>               </li>           </ul>      </div>   </div></div>'}),ES.MapView.TabPanel.AlarmTypes=ES.Evented.extend({oOption:{cUrl:"",cAttentUrl:"",cDivContainerSel:"#classContainer",cLstContainerSel:".ex-layout-carlist-content",cSearchInputSel:"input.ec-form-field",cSearchBtnSel:"button.ec-btn-secondary",cCheckEventName:"MapView:DeptTreeView.getDeptId",cUncheckEventName:"MapView:UnDeptTreeView.getDeptId"},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._oPage=e._oParent,this.initOn(),"object"==typeof this.oOption.cDivContainerSel?this.$_oContainer=this.oOption.cDivContainerSel:this.$_oContainer=$(this.oOption.cDivContainerSel),this.initUI()},initOn:function(){},initEvent:function(){var e=this;this.$_oitmeUl.on("click","li>a",function(){$(this).parent().addClass("ec-active").siblings().removeClass("ec-active"),e._oPage.fire(e.oOption.cCheckEventName,{acId:[parseInt($(this).attr("data-id"))]}),0==e.$_oStruck.siblings().width()&&e.$_oStruck.siblings().find("a.ex-icon-turn.on").click()})},initUI:function(){this.$_oStruck=$(this.cHtml),this.$_oContainer.append(this.$_oStruck),this.$_oTitle=this.$_oStruck.find("h4"),this.$_oTitle.html(this.oOption.cTitle),this.$_oitmeUl=this.$_oStruck.find(".ex-mapview-struct-ul"),this.getAlarmLst()},getAlarmLst:function(){var e={searchModel:{menu_id:1882},editModel:{},buttonId:1,pageIndex:1,pageSize:20};ES.getData(JSON.stringify(e),ES.MapView.oConfig.getAlarmType,function(e){if(e&&1===e.code&&e.detail&&!(e.detail.length<=0)){for(var t=0;t<e.detail.length;t++){var i=e.detail[t],a=$(ES.template('<li cflag="{dicValue}" class="ms-hover"><a href="#" data-id="{dicKey}"><i class="ec-icon-medium" title="{remark}"></i>{remark}</a></li>',i));this.$_oitmeUl.append(a)}this.initEvent()}},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}}),ES.MapView.TabPanel.AlarmTypes.include({cHtml:'<div class="ex-layout-carlist" style="width:280px">   <div class="ex-layout-carlist-title">       <h4 class="ec-align-left">车辆列表 [共4000辆]</h4>   </div>   <div class="ex-layout-carlist-wrap">      <div>          <ul class="ex-mapview-struct-ul">          </ul>      </div>   </div></div>'}),ES.MapView.LayoutContent=ES.Evented.extend({cHTML:'<div class="ex-layout-content" style="float:left"></div>',oOption:{cPContainer:".ex-layout-main",nWidth:1e3,nHeight:500},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.initUI(),this.initOn()},initOn:function(){this._oParent.on("MapView:LayoutContent.resize",this.resize,this)},resize:function(e){e.nWidth&&this.$_oContainer.css({width:e.nWidth}),e.nHeight&&this.$_oContainer.css({height:e.nHeight})},setWidth:function(e){this.$_oContainer.stop().animate({width:e+"px"},100)},reflesh:function(e,t){},initUI:function(){this.$_oContainer=$(this.cHTML),$(this.oOption.cPContainer).append(this.$_oContainer),this.$_oContainer.css({width:this.oOption.nWidth,height:this.oOption.nHeight})}}),ES.MapView.LiveMange=ES.Class.extend({initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.initOn()},aoLivePos:null,initOn:function(){this._oParent.on("MapView:LiveMange.addLivePos",this.addLivePos,this),this._oParent.on("MapView:LiveMange.addLive",this.addLive,this),this._oParent.on("MapView:LiveMange.removeLive",this.removeLive,this),this._oParent.on("MapView:LiveMange.removePos",this.removePos,this),this._oParent.on("MapView:LiveMange.removeAll",this.removeAll,this),this._oParent.on("HubSvr:setGpsInfo",this.setGpsInfo,this)},addLive:function(e){for(var t=e.oData,i=0;i<t.length;i++)this.addLivePos({oGpsInfo:t[i]})},removeLive:function(e){for(var t=e.acId,i=0;i<t.length;i++)this.removePos({oGpsInfo:{PhoneNum:t[i]}})},setGpsInfo:function(e){var t=e.oData;if(t&&!(t.length<=0)){t=this._oParent.toHeartModle(this._oParent.getVstatus(t));var i=this;$.each(t,function(e,t){var e=ES.Util.arrayIndex(i.aoLivePos,t,"devNo");if(e<0)return void console.log("不存在跟踪设备："+t.devNo+";车牌号"+t.vehNo);void 0===t.vehNo&&(t.vehNo=i.aoLivePos[0].options.vehNo,t.entName=i.aoLivePos[0].options.entName),t.weight=void 0===t.weight?0:t.weight,t.bOpenBubble=!0,i.aoLivePos[e].drawLiveTrack({oGpsInfo:t})})}},addLivePos:function(e){if(e&&e.oGpsInfo){this.aoLivePos||(this.aoLivePos=new Array);var t=e.oGpsInfo;if(ES.Util.isInArray(this.aoLivePos,e.oGpsInfo,"devNo"))return void console.log("地图实时跟踪中存在已经跟踪的设备号"+t.devNo+";车牌号"+(t.devNo||"")+"！");if(this.aoLivePos.length>=ES.MapView.oConfig.nMonitorCnt){var i=this.aoLivePos.pop();this.removeMonitor(i)}var a=new ES.MapView.MapLive(this._oParent,e.oGpsInfo);this.aoLivePos.push(a),e.oGpsInfo.bOpenBubble=!0,a.drawLiveTrack(e)}},removeMonitor:function(e){e&&(e.offEven(),e.clearLiveTrack())},removePos:function(e){if(e&&e.oGpsInfo&&e.oGpsInfo.hasOwnProperty("devNo")){var t=ES.Util.arrayIndex(this.aoLivePos,e.oGpsInfo,"devNo");if(-1!==t){var i=this.aoLivePos[t];i&&(this.removeMonitor(i),this.aoLivePos.splice(t,1))}}},removeAll:function(){if(this.aoLivePos&&!(this.aoLivePos.length<=0)){for(var e=[],t=0;t<this.aoLivePos.length;t++)this.aoLivePos[t].offEven(),this.aoLivePos[t].clearLiveTrack(),e.push(this.aoLivePos[t].options);this._oParent.fire("HubSvr:batchUnsubGps",{aoGpsInfo:e}),this.aoLivePos.splice(0,this.aoLivePos.length)}},convertVehStatus:function(e){var t=e.attach;e.nGreenOn=0,e.nRedOn=0,e.nYelloOn=0,e.cLight="白灯",e.cClsLight="gray","True"===t.ZtLeightGreenOn&&(e.nGreenOn=1,e.cLight="绿灯",e.cClsLight="green"),"True"===t.ZtLeightRedOn&&(e.nRedOn=1,e.cLight="红灯",e.cClsLight="red"),"True"===t.ZtLeightYelloOn&&(e.nYelloOn=1,e.cLight="黄灯",e.cClsLight="yellow"),e.dWeight=t.ZtWeightValue}}),ES.MapView.MapLive=L.MapLib.MapMaster.MapOpr.extend({initialize:function(e,t,i){L.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,e,t,i),this._loadLayerGroup(),this.devNo=t.devNo||"-1",this.cId=null},setOption:function(e){return e.hasOwnProperty("vehNo")&&delete e.vehNo,e.hasOwnProperty("CompanyName")&&delete e.CompanyName,e.hasOwnProperty("currentState")&&delete e.currentState,ES.extend(this.options,e)},setFristGps:function(e){this.oFristGps=e},_initOn:function(){this._oMap.on("moveend",this._mapMoveHandler,this),this._oParent.on("MV:Real.drawLiveTrack",this.drawLiveTrack,this),this._oParent.on("MV:Real.showVecMarkerPop",this._showVecMarkerPop,this),this._oParent.on("MV:Real.setLiveZoomIn",this.setLiveZoomIn,this),this._oParent.on("MV:Real.clearLiveTrack",this.clearLiveTrack,this),this._oParent.on("MapView:MapLive.setZoomIn",this.setZoomIn,this)},setZoomIn:function(e){if(e&&e.oGpsInfo){var t=e.oGpsInfo,i=this.findLayer(this._oLivePosGroup,t.devNo);if(i){var a=i.getLatLng();this.flyTo(a,{zoom:16}),i.openPopup()}}},offEven:function(){this._oMap.off("moveend",this._mapMoveHandler,this),this._oParent.off("MV:Real.drawLiveTrack",this.drawLiveTrack,this),this._oParent.off("MV:Real.unVisibleMarker"),this._oParent.off("MV:Real.showVecMarkerPop",this._showVecMarkerPop,this),this._oParent.off("MV:Real.setLiveZoomIn",this.setLiveZoomIn,this),this._oParent.off("MV:Real.clearLiveTrack",this.clearLiveTrack,this)},_loadLayerGroup:function(){this._oLineGroup=L.featureGroup(),this._oMap.addLayer(this._oLineGroup),this._oTrackGroup=L.featureGroup(),this._oMap.addLayer(this._oTrackGroup),this._oLivePosGroup=L.featureGroup(),this._oMap.addLayer(this._oLivePosGroup)},_showVecMarkerPop:function(e){if(this._oLivePosGroup){var t=$("#Map").hasClass("active"),i=e.oGpsInfo;this._oLivePosGroup.eachLayer(function(e){if(i.cDevId!=e.cId)return void e.closePopup();t?(this._oMap.setView(e.getLatLng(),17),i.bOpenBubble?e.openPopup():e.closePopup()):e.closePopup()},this)}},_updateVecMarkerPop:function(e,t){e&&e.setPopupContent(t)},_drawLiveHis:function(){var e=this.oGpsInfo,t=null,i=this.findLayer(this._oLineGroup,e.devNo);if(i)t=i.oPrePosInfo,i.oPrePosInfo=e,i.addLatLng(e.latLng);else{var a=L.polyline([e.latLng],ES.MapView.oConfig.oLiveLineConfig);a.cId=e.devNo,a.oPrePosInfo=e,a.addTo(this._oLineGroup)}if(t){var o=L.circleMarker(t.latLng,ES.MapView.oConfig.oLiveCircleMarkerConfig);o.addTo(this._oTrackGroup),o.oGpsInfo=e,this.initPopup(o),this.initPopupEvent(o),e.bOpenBubble?o.openPopup():o.closePopup()}},_createLive:function(e){var t=e.latLng,i=L.Marker.movingMarker([t],[],{icon:this._getPosIconInfo(e,{nWidth:30,nHeight:40,nInitDir:180})});return i.cId=e.devNo,i.oData=e,i},_drawLive:function(){if(this._oLivePosGroup){var e=this.oGpsInfo,t=this.findLayer(this._oLivePosGroup,e.devNo);return t?(t.moveTo(e.latLng,5e3),t.oCircle&&t.oCircle.setLatLng(e.latLng),t.oGpsInfo=e,this.initPopup(t)):(this.clearLiveTrackFrom(e),t=this._createLive(e),t.addTo(this._oLivePosGroup),t.oGpsInfo=e,this.initPopup(t),this.initPopupEvent(t),e.bOpenBubble?t.openPopup():t.closePopup(),this.oLayer=t,this.flyTo(t.getLatLng(),{zoom:13})),this._setHeading(e,180),this.selectLi(e),t._bringToFront(),t}},selectLi:function(e){for(var t=e.devNo,i=$(".ex-layout-carlist-content").find("li"),a=0;a<i.length;a++){$(i[a]).data("data").devNo==t&&($(i[a]).removeData("data"),$(i[a]).data("data",e))}},_mapMoveHandler:function(){this._oLivePosGroup&&this._oLivePosGroup.eachLayer(function(e){e._bringToFront&&e._bringToFront()},this)},clearLiveTrack:function(){this._oLivePosGroup.clearLayers(),this._oLineGroup.clearLayers(),this._oTrackGroup.clearLayers(),this._oParent.fire("MapView:MapLive.addMarker",{oGpsInfo:this.options})},clearLiveTrackFrom:function(e){this._oLivePosGroup.clearLayers(),
this._oLineGroup.clearLayers(),this._oTrackGroup.clearLayers(),this._oParent.fire("MapView:ClusterLayer.removeLayer",{oGpsInfo:e})},drawLiveTrack:function(e){e.oGpsInfo.latLng&&(this.oGpsInfo=e.oGpsInfo,this._drawLiveHis(),this._drawLive())},setLiveZoomIn:function(){var e=this._oLivePosGroup.getLayers();if(e&&!(e.length<=0)&&e[0].getLatLng){var t=e[0].getLatLng(),i=this._oMap.getMaxZoom();this._oMap.setView(t,i-1)}}}),ES.MapView.MapLive.include({oPopOption:{maxWidth:500,autoPan:!1},_getPosIconInfo:function(e,t){return e.nDir=e.dir+t.nInitDir,new L.DivIcon({html:ES.template(this._getIconHtml(),e),className:this.getLeightOnCls(e),iconSize:L.point(30,40),iconAnchor:[10,20],popupAnchor:L.point(-1,-20)})},_getIconHtml:function(){return'<div cid="{devNo}" class="car-body" style="transform:rotateZ({nDir}deg);-webkit-transform: rotate({nDir}deg);"></div>    <div class="pin-tip " style="display: block;">        <div class="pin-dome"><b></b><c></c><d></d></div>        <div class="pin-number">{vehNo}</div>        <div class="pin-state">        </div></div>'},_setHeading:function(e,t){e&&(t||(t=0),e.nDir=e.dir+t,$('div[cId="'+e.devNo+'"]').attr("style",ES.template("transform: rotate({nDir}deg);-webkit-transform: rotate({nDir}deg);",e)))},alarmToCls:function(e){var t={cAlarm:""};return e.cClsLight="green",e?(e.Speed>60&&(t.cAlarm="car-state speed"),t):t}}),ES.MapView.MapLive.include({initPopupEvent:function(e){var t=this,i=e.getPopup();i&&i.on("contentupdate",function(){var e=$(".leaflet-popup").find("a.ec-icon-truck").parent(),i=$(".leaflet-popup").find("a.ec-icon-exchange").parent(),a=$(".leaflet-popup").find("a.ec-icon-commenting").parent(),o=this.oGpsInfo;e.bind("click",function(){t._oParent.fire("MapView:VehDetail.showDetail",{oGpsInfo:o}),t._oParent.fire("HubSvr.unsubGps",{aoGpsInfo:[o]}),t._oParent.fire("MapView:LiveMange.removeAll"),t._oParent.fire("HubSvr.subGps",{aoGpsInfo:[o]})}),i.bind("click",function(){window.open("/mapViewHtml/html/trackview.html?token="+ES.MapView.oConfig.token+"&PhoneNum="+o.devNo+"&VehicleNo="+o.vehNo)}),a.bind("click",function(){ES.aWarn("系统正在开发过程！")})},i)},initPopup:function(e){if(!this._oParent||!this._oParent._getVecMarkerHtml);var t=this._oParent._getVecMarkerHtml(e.oGpsInfo),i=e.getPopup();return i||(i=e.bindPopup(t,this.oPopOption).getPopup()),i.oGpsInfo=e.oGpsInfo,i.setContent(t),i},setMobileInfo:function(e){var t=$(".ex-icon-mobile"),i=$(".ex-icon-bd");t.removeClass("on").removeClass("off"),i.removeClass("on").removeClass("off"),"行驶"==e.currentState||"停车"==e.currentState||"熄火"==e.currentState?(t.addClass("on"),i.addClass("on")):"通讯中断"==e.currentState?(t.addClass("l-mobile-off"),i.addClass("l-bd-off")):"定位失败"==e.currentState?(t.addClass("on"),i.addClass("off")):(t.addClass("off"),i.addClass("off"))},getLeightOnCls:function(e){var t="ex-monitor-mapicon-truck",i="gray";return 0==e.carType&&(t="ex-monitor-mapicon-tram"),"行驶"==e.currentState||"停车"==e.currentState?i="green":"熄火"==e.scurrentStateta?i="green":"定位失败"==e.currentState?i="yellow":"通讯中断"==e.currentState&&(i="gray"),t+" "+i}}),ES.MapView.LineLayer=L.MapLib.MapMaster.MapOpr.extend({oOption:{onEventDrawLayers:"MapView:ShowLayer.DrawLayers",onEventClearLayers:"MapView:ShowLayer.clearLayer",onEventRemoveLayers:"MapView:ShowLayer.removeLayers",oStyleConfig:{stroke:!0,color:"green",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:1,fill:!1,fillColor:null,fillOpacity:.2,clickable:!1,smoothFactor:1,noClip:!1},cHtml:'<div class="{cCls}"><div class="{cBCls}"></div><div class="{cTCls}">{Name}</div></div>'},initialize:function(e,t){L.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,e,{}),ES.setOptions(this,t),this._initGroup(),this._loadOn()},_initGroup:function(){this._oPolylineGroup=L.featureGroup(),this._oMap.addLayer(this._oPolylineGroup)},_loadOn:function(){this._oParent.on(this.oOption.onEventDrawLayers,this.drawLayers,this),this._oParent.on(this.oOption.onEventClearLayers,this.clearLayer,this),this._oParent.on(this.oOption.onEventRemoveLayers,this.removeLayers,this)},removeLayers:function(e){if(this._oPolylineGroup&&e&&!(e.acId.length<=0))for(var t=e.acId,i=0;i<t.length;i++){var a=-parseInt(t[i]),o=this.findLayer(this._oPolylineGroup,a);o&&this._oPolylineGroup.removeLayer(o)}},clearLayer:function(){this._oPolylineGroup.clearLayers()},drawLayers:function(e){if(e&&e.aoData){for(var t=[],i=0;i<e.aoData.length;i++){this.findLayer(this._oPolylineGroup,e.aoData[i].id)||(this.drawLayer(e.aoData[i]),$.merge(t,e.aoData[i].lstLatLnt))}t&&t.length>0&&this._oMap.fitBounds(t)}},drawLayer:function(e){if(e){var t=this.createLayer(e);t&&(t.cId=e.id,t.cName=e.name)}},createLayer:function(e){var t=null;if(!e)return t;for(var i=[],a=e.lstLatLnt.length-1;a>=0;a--)i.push(e.lstLatLnt[a]);return t=L.polyline(i,this.oOption.oStyleConfig).addTo(this._oPolylineGroup),t.setText(e.MaintainName+":"+e.name+"        ",{repeat:!0,offset:20,attributes:{"font-size":"16",fill:"red"}}),t}}),ES.MapView.SiteLayer=L.MapLib.MapMaster.MapOpr.extend({oOption:{onEvenSetData:"MV:Site.setSiteData",onEvenSetStatusData:"MV:Site.setStatusData",onEvenClearSites:"MV:Site.clearSites",cHtml:'<div class="{cCls}"><div class="{cBCls}"></div><div class="{cTCls}">{Name}</div></div>'},initialize:function(e,t){L.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,e,{}),ES.setOptions(this,t),this._initGroup(),this._loadOn()},_initGroup:function(){this._oSiteGroup=L.layerGroup(),this._oMap.addLayer(this._oSiteGroup),this._oPolygonSiteGroup=L.layerGroup(),this._oMap.addLayer(this._oPolygonSiteGroup),this.aoSiteInfo=null},_loadOn:function(){this._oParent.on(this.oOption.onEvenSetData,this.setSiteData,this),this._oParent.on("siteTree:layer",this.getSiteId,this),this._oParent.on("unsiteTree:layer",this.getUncheckSiteId,this),this._oParent.on(this.oOption.onEvenSetStatusData,this.setStatusData,this),this._oMap.on("zoomend",this.drawSites,this),this._oParent.on(this.oOption.onEvenClearSites,this.clearSites,this),this._oParent.on("SiteLayer:clearAll",this.clearAll,this)},getUncheckSiteId:function(e){for(var t=[],i=0;i<e.acUncheckId.length;i++)0===e.acUncheckId[i].indexOf("-")&&t.push(parseInt(e.acUncheckId[i].replace("-","")));this.clearSites({anId:t})},getSiteId:function(e){for(var t=e.acData,i=0;i<t.length;i++){t[i].Points=[];for(var a=t[i].MapY.split(","),o=t[i].MapX.split(","),n=0;n<a.length;n++)t[i].Points.push({lat:a[n],lng:o[n]})}this.setSiteData({aoSiteInfo:t})},clearAll:function(){this.aoSiteInfo&&this.aoSiteInfo.length>0&&this.aoSiteInfo.splice(0,this.aoSiteInfo.length),this._oSiteGroup.clearLayers(),this._oPolygonSiteGroup.clearLayers()},setStatusData:function(e){this.aoStatusData=e.aoStatusData},setSiteData:function(e){this.addSiteData(e),this.drawSites(e)},drawSites:function(e){var t=this.aoSiteInfo;if(t){for(var i=this._oMap.getZoom(),a=0;a<t.length;a++)!t[a].Points||t[a].Points.length<=0||(i<=4?(this._oSiteGroup.clearLayers(),this._oPolygonSiteGroup.clearLayers()):i>4&&i<=16?(this._oPolygonSiteGroup.clearLayers(),this._drawSiteMarker(t[a])):(this._oSiteGroup.clearLayers(),this._drawPolygonSite(t[a])));if(e.aoSiteInfo&&1===e.aoSiteInfo.length){var o=this.findLayer(this._oPolygonSiteGroup,e.aoSiteInfo[0].Id);if(o&&this._oMap.fitBounds(o.getLatLngs()),o=this.findLayer(this._oSiteGroup,e.aoSiteInfo[0].Id)){var n=o.getLatLng();this.flyTo({oGpsInfo:{Lat:n.lat,Lon:n.lng}},{zoom:16})}}}},_drawSiteMarker:function(e){if(this._oSiteGroup&&e){var t=this.findLayer(this._oSiteGroup,e.Id);if(t)return t;var i=new L.LatLngBounds(e.Points),a=i.getCenter();2==e.FenceType&&(a=e.Points[0]);var o=this._getIcon(this._getIconHtml(e)),n=L.marker(a,{icon:o});return n.cId=e.Id,n.oPosInfo=e,n.addTo(this._oSiteGroup),this.initEventForMarker(n),n}},initEventForMarker:function(e){e&&e.on("click",function(){new ES.MapView.PopSiteInfo(this,e.oPosInfo).showModal()},this)},_drawPolygonSite:function(e){if(this._oPolygonSiteGroup&&e){if(!this.findLayer(this._oPolygonSiteGroup,e.Id)){var t=null;if(2===e.FenceType){var i=this.oMap.getZoom(),a=this.oMap.options.crs.latLngToPoint(L.latLng(e.Points[0]),i),o=this.oMap.options.crs.latLngToPoint(L.latLng(e.Points[1]),i);t=L.circle(e.Points[0],a.distanceTo(o),oInfo.oOption).addTo(this._oPolygonSiteGroup),e.Points[0]}else{t=L.polygon(e.Points,ES.MapView.oConfig.oSiteConfig).addTo(this._oPolygonSiteGroup);new L.LatLngBounds(e.Points).getCenter(),t.cId=e.Id}return t.bindTooltip(e.Name).openTooltip(),t.oPosInfo=e,this.initEventForMarker(t),t}}},_getIconHtml:function(e){return e.cCls="ex-monitor-mapicon-site now",e.cBCls="site-body",e.cTCls="site-title","SiteNow"===e.icon?e.cCls="ex-monitor-mapicon-site now":"SiteAdvance"===e.icon?e.cCls="ex-monitor-mapicon-site temp-site":"SiteNull"===e.icon?e.cCls="ex-monitor-mapicon-site no-report":"UnSiteNow"===e.icon&&(e.cCls="ex-monitor-mapicon-site alert"),ES.Util.template(this.cHtml,e)},_getIcon:function(e){return L.divIcon({iconSize:[20,20],iconAnchor:[10,20],popupAnchor:[-1,-20],className:"",html:e})},_getPopHtml:function(e){return""},clearSites:function(e){this.clearPolygonSite(e),this.clearMarkerSite(e),this.deleteSite(e)},deleteSite:function(e){if(this.aoSiteInfo&&e&&e.anId&&!(e.anId.length<=0))for(var t=this.aoSiteInfo,i=e.anId,a=t.length-1;a>=0;a--){var o=$.grep(i,function(e,i){if(t[a].Id===parseInt(e))return!0});!o||o.length<=0||t.splice(a,1)}},addSiteData:function(e){if(!this.aoSiteInfo)return void(this.aoSiteInfo=e.aoSiteInfo);$.merge(this.aoSiteInfo,e.aoSiteInfo)},clearPolygonSite:function(e){for(var t=e.anId,i=0;i<t.length;i++){var a=this.findLayer(this._oPolygonSiteGroup,t[i]);a&&(a.oMarker&&this._oPolygonSiteGroup.removeLayer(a.oMarker),this._oPolygonSiteGroup.removeLayer(a))}},clearMarkerSite:function(e){for(var t=e.anId,i=0;i<t.length;i++){var a=this.findLayer(this._oSiteGroup,t[i]);a&&(a.oMarker&&this._oSiteGroup.removeLayer(a.oMarker),this._oSiteGroup.removeLayer(a))}},clearAllPolygonSite:function(e){for(var t=e.anId,i=0;i<t.length;i++){var a=this.findLayer(this._oPolygonSiteGroup,t[i]);a&&(a.oMarker&&this._oPolygonSiteGroup.removeLayer(a.oMarker),this._oPolygonSiteGroup.removeLayer(a))}}}),ES.MapView.SiteLayer.include({cHtml:'<div class="{cCls}">   <div class="pin-tip" style="display: none;">       <div class="pin-dome"><b></b><c></c><d></d></div>       <div class="pin-number">{Name}</div>   </div>   <div class="site-body">   </div></div>'}),ES.MapView.RectLayer=L.MapLib.MapMaster.MapOpr.extend({oOption:{onEvenSetData:"MV:Rect.setSiteData",onEvenSetStatusData:"MV:Rect.setStatusData",onEvenClearSites:"MV:Rect.clearSites",cHtml:'<div class="{cCls}"><div class="{cBCls}"></div><div class="{cTCls}">{Name}</div></div>',oRectConfig:{stroke:!0,color:"#6a7ac3",dashArray:null,lineCap:null,lineJoin:null,weight:3,opacity:1,fill:!0,fillColor:"#6a7ac3",fillOpacity:.2,clickable:!1,smoothFactor:1,noClip:!1},oVehLineConfig:{stroke:!0,color:"#00bd01",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:1}},initialize:function(e,t){L.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,e,{}),ES.setOptions(this,t),this._initGroup(),this._loadOn(),this.initPen(),this.initOn(),this._oParam=null},initPen:function(){this.oDrawPen={enabled:{shapeOptions:this.oOption.oRectConfig},handler:new L.Draw.Rectangle(this._oMap,{shapeOptions:this.oOption.oRectConfig}),title:L.drawLocal.draw.toolbar.buttons.rectangle}},initOn:function(){this._oMap.on("draw:created",this.createdCallBack,this)},createdCallBack:function(e){var t=e.layer;this._oRectGroup.addLayer(t);var i=t.getBounds();this._oParam={LeftPoint:{Lon:i.getWest(),Lat:i.getNorth()},RightPoint:{Lon:i.getEast(),Lat:i.getSouth()}},this._oParent.fire("RectSearch:setLayerGps",{oParam:this._oParam})},_initGroup:function(){this._oRectGroup=L.layerGroup(),this._oMap.addLayer(this._oRectGroup),this._oVehicleLine=L.layerGroup(),this._oMap.addLayer(this._oVehicleLine),this.aoSiteInfo=null},_loadOn:function(){this._oParent.on("RectView:layer",this.drawRectLayer,this),this._oParent.on("unRectView:layer",this.clearRectLayer,this),this._oParent.on("VehicleLine:layer",this.drawVehicleLineLayer,this),this._oParent.on("unVehicleLine:layer",this.clearVehicleLineLayer,this)},drawRectLayer:function(e){this.oDrawPen.handler.enable()},clearRectLayer:function(){this._oRectGroup.clearLayers()},drawVehicleLineLayer:function(e){this.clearVehicleLineLayer();var t=e.oGpsInfo,i=[];if($.each(t,function(e,t){i.push({lat:t.Lat,lng:t.Lon})}),1===i.length){var a=this._getIcon(0);oRectTrack=L.marker(i[0],{icon:a}).addTo(this._oVehicleLine)}else{var o=this._getIcon(1),n=this._getIcon(2);oRectTrack=L.polyline(i,this.oOption.oVehLineConfig).addTo(this._oVehicleLine),oRectTrack.startMarker=L.marker(i[i.length-1],{icon:o}).addTo(this._oVehicleLine),oRectTrack.EndMarker=L.marker(i[0],{icon:n}).addTo(this._oVehicleLine)}},clearVehicleLineLayer:function(){this._oVehicleLine.clearLayers()},_getIcon:function(e){switch(e){case 0:var t=L.divIcon({iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[-1,-32],className:"parkMarker"});break;case 1:var t=L.divIcon({iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[-1,-32],className:"beginMarker"});break;case 2:var t=L.divIcon({iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[-1,-32],className:"endMarker"})}return t}}),ES.MapView.RectLayer.include({cHtml:'<div class="{cCls}">   <div class="pin-tip" style="display: none;">       <div class="pin-dome"><b></b><c></c><d></d></div>       <div class="pin-number">{Name}</div>   </div>   <div class="site-body">   </div></div>'}),ES.MapView.VehClusterLayer=L.MapLib.MapMaster.MapOpr.extend({oOption:{onDrawLayers:"MapView:ClusterLayer.DrawLayers",onClearLayers:"MapView:ClusterLayer.clearLayer",onRemoveLayers:"MapView:ClusterLayer.removeLayers",cHtml:'<div cid="{devNo}" class="car-body" style="transform:rotate({dir}deg);-webkit-transform: rotate({dir}deg);"></div>    <div class="pin-tip " style="display: block;">        <div class="pin-dome"><b></b><c></c><d></d></div>        <div class="pin-number">{vehNo}</div>        <div class="pin-state">        </div></div>'},oPopOption:{maxWidth:500,autoPan:!1},initialize:function(e,t){L.MapLib.MapMaster.MapOpr.prototype.initialize.call(this,e,{}),ES.setOptions(this,t),this._initGroup(),this._loadOn()},_initGroup:function(){this._oPosGroup=L.markerClusterGroup({}),this._oMap.addLayer(this._oPosGroup)},_loadOn:function(){this._oParent.on(this.oOption.onDrawLayers,this.drawLayers,this),this._oParent.on(this.oOption.onClearLayers,this.clearLayer,this),this._oParent.on(this.oOption.onRemoveLayers,this.removeLayers,this),this._oParent.on("MapView:ClusterLayer.removeLayer",this.removeLayer,this),this._oParent.on("MapView:MapLive.addMarker",function(e){this.drawLayer(e.oGpsInfo)},this)},removeLayer:function(e){this._oPosGroup&&e&&e.oGpsInfo&&this._removeLayer(e.oGpsInfo)},removeLayers:function(e){if(this._oPosGroup&&e&&!(e.acId.length<=0))for(var t=e.acId,i=0;i<t.length;i++){var a=-parseInt(t[i]);this._removeLayer(a)}},_removeLayer:function(e){var t=$.grep(this._oPosGroup.getLayers(),function(t){if(t.cId===e.devNo)return!0});if(t&&!(t.length<=0))for(var i=0;i<t.length;i++)this._oPosGroup.removeLayer(t[i])},clearLayer:function(){this._oPosGroup.clearLayers()},drawLayers:function(e){if(e&&e.aoData&&1===e.aoData.code&&!(e.aoData.detail.length<=0))for(var t=[],i=0;i<e.aoData.detail.length;i++){var a={lat:e.aoData.detail[i].lat,lng:e.aoData.detail[i].lon};e.aoData.detail[i].latLng=a,this.drawLayer(e.aoData.detail[i]),t.push(a)}},drawLayer:function(e){if(e&&e.latLng){var t=this.findLayer(this._oPosGroup,e.devNo);if(t)return this._oMap.hasLayer(t)||this._oMap.addLayer(t),void t.setLatLng(e.latLng);var i=this.getTruckCls(e),a=this._getIcon(i,ES.Util.template(this.oOption.cHtml,e)),o=L.marker(e.latLng,{icon:a}).addTo(this._oPosGroup);o.oGpsInfo=e,o.cId=e.devNo,this.initEventForMarker(o)}},initEventForMarker:function(e){var t=this;if(e){var i={devnos:[e.oGpsInfo.devNo]};e.on("click",function(){var e=this;$.ajax({url:ES.MapView.oConfig.curPosUrl,data:JSON.stringify(i),type:"post",dataType:"text",headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"},success:function(i){var a=JSON.parse(i);if(1==a.code){var o=a.detail.list,n=t._oParent.toHeartModle(o);if(n&&!(n.length<=0)){var s=t._oParent._getVecMarkerHtml(n[0]);e.bindPopup(s,t.oPopOption);var l=e.getPopup();l.oGpsInfo=n[0],t.initPopEven(l),e.openPopup()}}},error:function(e){console.log(e)}})})}},initPopEven:function(e){var t=this;e&&(e.self=this,e.on("contentupdate",function(){var e=$(".leaflet-popup").find("a.ec-icon-truck").parent(),i=$(".leaflet-popup").find("a.ec-icon-exchange").parent(),a=$(".leaflet-popup").find("a.ec-icon-commenting").parent(),o=this.oGpsInfo;e.bind("click",function(){t._oParent.fire("MapView:VehDetail.showDetail",{oGpsInfo:o}),t._oParent.fire("HubSvr.unsubGps",{aoGpsInfo:[o]}),t._oParent.fire("MapView:LiveMange.removeAll"),t._oParent.fire("HubSvr.subGps",{aoGpsInfo:[o]})}),i.bind("click",function(){window.open("/mapViewHtml/html/trackview.html?token="+ES.MapView.oConfig.token+"&PhoneNum="+o.devNo+"&VehicleNo="+o.vehNo)}),a.bind("click",function(){ES.aWarn("系统正在开发过程！")})},e))},_getIcon:function(e,t){return L.divIcon({iconSize:[30,40],iconAnchor:[10,20],popupAnchor:[-1,-20],className:e,html:t})},getTruckCls:function(e){return"ex-monitor-mapicon-truck "+("1"==e.status||"2"==e.status?"green":"3"==e.status?"green":"4"==e.status?"yellow":"gray")},getData:function(){ES.getData({},ES.MapView.oConfig.getVehsLoc,function(e){this.drawLayers({aoData:e})},this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})}});var cH_Url="http://api.bdlbs.comlbs.com";ES.Common.AddType=ES.Common.DialogDel.extend({initialize:function(e,t,i){ES.Common.BaseDialog.prototype.initialize.call(this,e,t,i),this.oBusData=null},initButton:function(){},initOn:function(){},afterOpen:function(){var e=this;$(".ex-command-tabs.modelType").on("click","li",function(){var t=parseInt($(this).attr("data-index"));e.getDialogTypeV2(t)})},getDialogTypeV2:function(e){var t=this,i=t.oBusData;switch(e){case 1:t._oParent.oEditD=new ES.Common.TakePhoto(t._oParent,{bRemove:!0,cUrl:cH_Url+"/instructionRelease/photo",title:"下发指令 - 拍照"}),t._oParent.oEditD.showModal(i);break;case 2:t._oParent.oEditD=new ES.Common.DelEntity(t._oParent,{bRemove:!0,cUrl:cH_Url+"/instructionRelease/rollcall",title:"下发指令 - 点名"}),t._oParent.oEditD.showModal(i);break;case 3:t._oParent.oEditD=new ES.Common.TextAreaDialog(t._oParent,{bRemove:!0,cUrl:cH_Url+"/instructionRelease/broadcast",nIndex:e,title:"下发指令 - 文字"}),t._oParent.oEditD.showModal(i)}},getDialogType:function(e){var t=this;switch(e){case 1:t._oParent.oEditD=new ES.Common.Threshold(t._oParent,{bRemove:!0,cUrl:"/DeviceCommand/SetLoadThreshold",nIndex:e}),t._oParent.oEditD.showModal();break;case 2:t._oParent.oEditD=new ES.Common.SetLight(t._oParent,{bRemove:!0,cUrl:"/DeviceCommand/SetLight",nIndex:e}),t._oParent.oEditD.showModal();break;case 3:t._oParent.oEditD=new ES.Common.SetCloseCheckMode(t._oParent,{bRemove:!0,cUrl:"/DeviceCommand/SetCloseCheckMode",nIndex:e}),t._oParent.oEditD.showModal();break;case 4:t._oParent.oEditD=new ES.Common.SetTtsSwitch(t._oParent,{bRemove:!0,cUrl:"/DeviceCommand/SetTtsSwitch",nIndex:e}),t._oParent.oEditD.showModal();break;case 5:t._oParent.oEditD=new ES.Common.SetMuckParam(t._oParent,{bRemove:!0,cUrl:"/DeviceCommand/SetMuckParam",nIndex:e}),t._oParent.oEditD.showModal();break;case 6:this._oParent.oConfigD=new ES.SelectTruck.Dialog(this._oParent,{bRemove:!0,cUrl:"/DeviceCommand/GetSensorParam",nIndex:e},{title:"查询传感器参数"}),this._oParent.oConfigD.showModal();break;case 7:this._oParent.oConfigD=new ES.SelectTruck.Dialog(this._oParent,{bRemove:!0,cUrl:"/DeviceCommand/GetSensorVersion",nIndex:e},{title:"查询传感器版本"}),this._oParent.oConfigD.showModal()}}}),ES.Common.SetTtsSwitch=ES.Evented.extend({cHtml:'<form class="ex-layout-site-reports" style="width:700px" id="setTtsSwitchModel">        <div class="ec-g ex-layout-site-reports-top">            <ul class="ec-avg-sm-2">                <li class="ec-form-group">                    <label for="NoclosedTts" class="ec-u-sm-5 ec-form-label">未密闭语音播报开关：</label>                    <div class="ec-u-sm-7">                        <select id="NoclosedTts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="true">开</option>                            <option value="false">关</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="OverloadTts" class="ec-u-sm-5 ec-form-label">超载语音播报开关：</label>                    <div class="ec-u-sm-7">                        <select id="OverloadTts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="true">开</option>                            <option value="false">关</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="OilRecoveryTts" class="ec-u-sm-5 ec-form-label">油路恢复语音播报：</label>                    <div class="ec-u-sm-7">                        <select id="OilRecoveryTts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="true">开</option>                            <option value="false">关</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="OilCutoffTts" class="ec-u-sm-5 ec-form-label">油路断开语音播报：</label>                    <div class="ec-u-sm-7">                        <select id="OilCutoffTts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="true">开</option>                            <option value="false">关</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="GnssfaultTts" class="ec-u-sm-5 ec-form-label">gnss故障语音播报：</label>                    <div class="ec-u-sm-7">                        <select id="GnssfaultTts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="false">关</option>                            <option value="true">开</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="GnssfaultFlash" class="ec-u-sm-5 ec-form-label">gnss故障闪烁：</label>                    <div class="ec-u-sm-7">                        <select id="GnssfaultFlash" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="false">关</option>                            <option value="true">开</option>                        </select>                    </div>                </li>            </ul>        </div>    </form>',initialize:function(e,t,i){this._oParent=e,ES.setOptions(this,t),this.oDOption={},this.initButton(),this.initDialog(),this.initEvent(),this.initUI()},initDialog:function(){var e={fixed:!0,align:"right bottom",title:this.oOption.title,content:this.cHtml};ES.extend(e,this.oDOption);var t=dialog(e);return this.oDialog=t,t},showModal:function(e){this.oBusData=e,this.oDialog.showModal()},initUI:function(){},initEvent:function(){if(this.oDialog){var e=this;this.oDialog.addEventListener("show",function(){e.afterOpen&&e.afterOpen()}),this.oDialog.addEventListener("close",function(){e.afterClose&&e.afterClose()})}},initButton:function(){var e=this,t=[{value:"确定",callback:function(){return e.save(),!1},autofocus:!0},{value:"取消",callback:function(){return e.oOption.bRemove?this.remove():this.close(),!1}}];this.oDOption.button=t},afterOpen:function(){},save:function(){var e=$("#NoclosedTts option:selected").val(),t=$("#OverloadTts option:selected").val(),i=$("#OilRecoveryTts option:selected").val(),a=$("#OilCutoffTts option:selected").val(),o=$("#GnssfaultTts option:selected").val(),n=$("#GnssfaultFlash option:selected").val(),s=JSON.parse(localStorage.getItem("$userstatus")),l={phoneNum:this.oBusData.devNo,userId:s.id,userName:s.account,NoclosedTts:e,OverloadTts:t,OilRecoveryTts:i,OilCutoffTts:a,GnssfaultTts:o,GnssfaultFlash:n};ES.loadAn($(this.oDialog.node)),ES.getData(JSON.stringify(l),this.oOption.cUrl,this.saveHandler,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},saveHandler:function(e){"Success"==e.msg&&(this.oDialog.remove(),this._oParent.orderVehicleDialog.oDialog.remove())}}),ES.Common.SetMuckParam=ES.Evented.extend({cHtml:'<form class="ex-layout-site-reports" style="width:550px" id="setMuckParamModel">        <div class="ec-g ex-layout-site-reports-top">            <ul class="ec-avg-sm-1">                <li class="ec-form-group">                    <label for="AuthPwd" class="ec-u-sm-5 ec-form-label"><span class="ec-text-danger ec-text-truncate">(*)</span>授权密码：</label>                    <div class="ec-u-sm-7">                        <input type="password" name="name" id="AuthPwd" class="ec-form-field"/>                    </div>                </li>                <li class="ec-form-group">                    <label for="FilteringTime" class="ec-u-sm-5 ec-form-label">滤波时间参数(5s)：</label>                    <div class="ec-u-sm-7">                        <input id="FilteringTime" class="ec-text-truncate ec-form-field ec-radius ec-input-sm ec-fl ec-margin-right-sm" type="number" value="1" name="">                    </div>                </li>                <li class="ec-form-group">                    <label for="BackpassMode" class="ec-u-sm-5 ec-form-label">回传模式：</label>                    <div class="ec-u-sm-7">                        <select id="BackpassMode" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="0">查询模式</option>                            <option value="1">主动回传</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="QryInterval" class="ec-u-sm-5 ec-form-label">查询指令间隔(500ms)：</label>                    <div class="ec-u-sm-7">                        <input id="QryInterval" class="ec-text-truncate ec-form-field ec-radius ec-input-sm ec-fl ec-margin-right-sm" type="number" value="1" name="">                    </div>                </li>                <li class="ec-form-group">                    <label for="Mode" class="ec-u-sm-5 ec-form-label">模式：</label>                    <div class="ec-u-sm-7">                        <select id="Mode" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="">请选择</option>                            <option value="0">debug</option>                            <option value="1">正常模式</option>                        </select>                    </div>                </li>            </ul>        </div>    </form>',initialize:function(e,t,i){this._oParent=e,ES.setOptions(this,t),this.oDOption={},this.initButton(),this.initDialog(),this.initEvent(),this.initUI()},initDialog:function(){var e={fixed:!0,align:"right bottom",title:this.oOption.title,content:this.cHtml};ES.extend(e,this.oDOption);var t=dialog(e);return this.oDialog=t,t},showModal:function(e){this.oBusData=e,this.oDialog.showModal()},initUI:function(){},initEvent:function(){if(this.oDialog){var e=this;this.oDialog.addEventListener("show",function(){e.afterOpen&&e.afterOpen()}),this.oDialog.addEventListener("close",function(){e.afterClose&&e.afterClose()}),$("input[type='number']").on("input propertychange",function(){$(this).val()<=0&&$(this).val(0)})}},initButton:function(){var e=this,t=[{value:"确定",callback:function(){return e.save(),!1},autofocus:!0},{value:"取消",callback:function(){return e.oOption.bRemove?this.remove():this.close(),!1}}];this.oDOption.button=t},afterOpen:function(){},save:function(){var e=$("#Mode option:selected").val(),t=$("#BackpassMode option:selected").val(),i=$("#QryInterval").val(),a=$("#FilteringTime").val(),o=$("#AuthPwd").val();if(!o)return void ES.aErr("请设置密码！");var n=JSON.parse(localStorage.getItem("$userstatus")),s={phoneNum:this.oBusData.devNo,userId:n.id,userName:n.account,Mode:e,BackpassMode:t,QryInterval:i,FilteringTime:a,AuthPwd:o};ES.loadAn($(this.oDialog.node)),ES.getData(JSON.stringify(s),this.oOption.cUrl,this.saveHandler,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},saveHandler:function(e){"Success"==e.msg&&(this.oDialog.remove(),this._oParent.orderVehicleDialog.oDialog.remove())}}),ES.Common.DelEntity=ES.Evented.extend({cHtml:'<form style="width:550px"><h3>确定下发指令？</h3></form>',initialize:function(e,t,i){this._oParent=e,ES.setOptions(this,t),this.oDOption={},this.initButton(),this.initDialog(),this.initEvent(),this.initUI()},initDialog:function(){var e={fixed:!0,align:"right bottom",title:this.oOption.title,content:this.cHtml};ES.extend(e,this.oDOption);var t=dialog(e);return this.oDialog=t,t},showModal:function(e){this.oBusData=e,this.oDialog.showModal()},initUI:function(){},initEvent:function(){if(this.oDialog){var e=this;this.oDialog.addEventListener("show",function(){e.afterOpen&&e.afterOpen()}),this.oDialog.addEventListener("close",function(){e.afterClose&&e.afterClose()})}},initButton:function(){var e=this,t=[{value:"确定",callback:function(){return e.save(),!1},autofocus:!0},{value:"取消",callback:function(){return e.oOption.bRemove?this.remove():this.close(),!1}}];this.oDOption.button=t},afterOpen:function(){},save:function(){var e=JSON.parse(localStorage.getItem("$userstatus")),t={phoneNum:this.oBusData.devNo,userId:e.id,userName:e.account};ES.loadAn($(this.oDialog.node)),ES.getData(JSON.stringify(t),this.oOption.cUrl,this.saveHandler,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},saveHandler:function(e){"Success"==e.msg&&(ES.aSucess("下发成功！"),this.oDialog.remove(),this._oParent.orderVehicleDialog.oDialog.remove())}}),ES.Common.TextAreaDialog=ES.Evented.extend({
cHtml:'<form class="ex-layout-site-reports" style="width:550px" id="setTextModel">        <div class="ec-g ex-layout-site-reports-top">            <ul class="ec-avg-sm-2">                <li class="ec-form-group">                    <label for="urgency" class="ec-u-sm-5 ec-form-label">紧急：</label>                    <div class="ec-u-sm-7">                        <select id="urgency" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="true">是</option>                            <option value="false">否</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="tts" class="ec-u-sm-5 ec-form-label">终端TTS播读：</label>                    <div class="ec-u-sm-7">                        <select id="tts" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="false">否</option>                            <option value="true">是</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="screen" class="ec-u-sm-5 ec-form-label">终端显示器显示：</label>                    <div class="ec-u-sm-7">                        <select id="screen" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="false">否</option>                            <option value="true">是</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="advertising" class="ec-u-sm-5 ec-form-label">广告屏显示：</label>                    <div class="ec-u-sm-7">                        <select id="advertising" class="ec-form-field chosen-select ec-radius ec-input-sm">                            <option value="false">否</option>                            <option value="true">是</option>                        </select>                    </div>                </li>            </ul>        </div>        <div class="ec-form">            <textarea placeholder="请输入需要下发的文字内容" id="textAreaDialog" style="min-height: 70px;font-size: 1.3rem"></textarea>        </div>    </form>',initialize:function(e,t,i){this._oParent=e,ES.setOptions(this,t),this.oDOption={},this.initButton(),this.initDialog(),this.initEvent(),this.initUI()},initDialog:function(){var e={fixed:!0,align:"right bottom",title:this.oOption.title,content:this.cHtml};ES.extend(e,this.oDOption);var t=dialog(e);return this.oDialog=t,t},showModal:function(e){this.oBusData=e,this.oDialog.showModal()},initUI:function(){},initEvent:function(){if(this.oDialog){var e=this;this.oDialog.addEventListener("show",function(){e.afterOpen&&e.afterOpen()}),this.oDialog.addEventListener("close",function(){e.afterClose&&e.afterClose()})}},initButton:function(){var e=this,t=[{value:"确定",callback:function(){return e.save(),!1},autofocus:!0},{value:"取消",callback:function(){return e.oOption.bRemove?this.remove():this.close(),!1}}];this.oDOption.button=t},afterOpen:function(){},save:function(){var e=$("#textAreaDialog").val(),t=$("#urgency").val(),i=$("#screen").val(),a=$("#tts").val(),o=$("#advertising").val();if(!e)return void ES.aWarn("请输入文字内容");var n=JSON.parse(localStorage.getItem("$userstatus")),s={phoneNum:this.oBusData.devNo,userId:n.id,userName:n.account,text:e,urgency:t,screen:i,tts:a,advertising:o};ES.loadAn($(this.oDialog.node)),ES.getData(JSON.stringify(s),this.oOption.cUrl,this.saveHandler,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},saveHandler:function(e){"Success"==e.msg&&(ES.aSucess("下发成功！"),this.oDialog.remove(),this._oParent.orderVehicleDialog.oDialog.remove())}}),ES.Common.TakePhoto=ES.Evented.extend({cHtml:'<form class="ex-layout-site-reports" style="width:550px" id="setTextModel">        <div class="ec-g ex-layout-site-reports-top">            <ul class="ec-avg-sm-2">                <li class="ec-form-group">                    <label for="ChannelId" class="ec-u-sm-5 ec-form-label">通道：</label>                    <div class="ec-u-sm-7">                        <select id="ChannelId" class="ec-form-field chosen-select ec-radius ec-input-sm" name="ChannelId">                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="SaveFlag" class="ec-u-sm-5 ec-form-label">保存方式：</label>                    <div class="ec-u-sm-7">                        <select id="SaveFlag" class="ec-form-field chosen-select ec-radius ec-input-sm" name="SaveFlag">                            <option value="0">实时上传</option>                            <option value="1">保存</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="Resolution" class="ec-u-sm-5 ec-form-label">分辨率：</label>                    <div class="ec-u-sm-7">                        <select id="Resolution" class="ec-form-field chosen-select ec-radius ec-input-sm" name="Resolution">                            <option value="1">320 * 240</option>                            <option value="2">640 * 480</option>                            <option value="3">800 * 600</option>                            <option value="4">1024 * 768</option>                            <option value="5">176 * 144</option>                            <option value="6">352 * 288</option>                            <option value="7">704 * 288</option>                            <option value="8">704 * 576</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="PhotoInterval" class="ec-u-sm-5 ec-form-label">拍照间隔(秒)：</label>                    <div class="ec-u-sm-7">                        <input id="PhotoInterval" class="ec-form-field ec-input-sm" name="PhotoInterval" value="1"/>                    </div>                </li>                <li class="ec-form-group">                    <label for="ImageQuality" class="ec-u-sm-5 ec-form-label">照片质量：</label>                    <div class="ec-u-sm-7">                        <select id="ImageQuality" class="ec-form-field chosen-select ec-radius ec-input-sm" name="ImageQuality">                            <option value="1">1</option>                            <option value="2">2</option>                            <option value="3">3</option>                            <option value="4">4</option>                            <option value="5">5</option>                            <option value="6">6</option>                            <option value="7">7</option>                            <option value="8">8</option>                            <option value="9">9</option>                            <option value="10">10</option>                        </select>                    </div>                </li>                <li class="ec-form-group">                    <label for="ImageQuality" class="ec-u-sm-12 ec-form-label">1代表质量损失最小,10表示压缩比最大</label>                </li>                <li class="ec-form-group">                    <label for="ShootCommand" class="ec-u-sm-5 ec-form-label">拍摄指令：</label>                    <div class="ec-u-sm-7">                        <input id="ShootCommand" class="ec-form-field ec-input-sm" name="ShootCommand" value="1" />                    </div>                </li>                <li class="ec-form-group">                    <label for="ShootCommand" class="ec-u-sm-12 ec-form-label">0表示停止拍照,其他表示拍照张数</label>                </li>            </ul>        </div>    </form>',initialize:function(e,t,i){this._oParent=e,ES.setOptions(this,t),this.oDOption={},this.initButton(),this.initDialog(),this.initEvent(),this.initUI()},initDialog:function(){var e={fixed:!0,align:"right bottom",title:this.oOption.title,content:this.cHtml};ES.extend(e,this.oDOption);var t=dialog(e);return this.oDialog=t,t},showModal:function(e){this.oBusData=e,this.oDialog.showModal()},initUI:function(){},initEvent:function(){if(this.oDialog){var e=this;this.oDialog.addEventListener("show",function(){e.afterOpen&&e.afterOpen()}),this.oDialog.addEventListener("close",function(){e.afterClose&&e.afterClose()})}},initButton:function(){var e=this,t=[{value:"确定",callback:function(){return e.save(),!1},autofocus:!0},{value:"取消",callback:function(){return e.oOption.bRemove?this.remove():this.close(),!1}}];this.oDOption.button=t},afterOpen:function(){var e=this.oBusData.cameraNum;if(e){for(var t="",i=1;i<=parseInt(e);i++)t+='<option value="'+i+'">通道'+i+"</option>";$("#ChannelId").html(t)}},save:function(){var e=JSON.parse(localStorage.getItem("$userstatus")),t={phoneNum:this.oBusData.devNo,userId:e.id,userName:e.account,ChannelId:$("#ChannelId").val(),SaveFlag:$("#SaveFlag").val(),Resolution:$("#Resolution").val(),PhotoInterval:$("#PhotoInterval").val(),ImageQuality:$("#ImageQuality").val(),ShootCommand:$("#ShootCommand").val()};ES.loadAn($(this.oDialog.node)),ES.getData(JSON.stringify(t),this.oOption.cUrl,this.saveHandler,this,null,{headers:{token:ES.MapView.oConfig.token,"Content-Type":"application/json; charset=utf-8"}})},saveHandler:function(e){"Success"==e.msg&&(ES.aSucess("下发成功！"),this.oDialog.remove(),this._oParent.orderVehicleDialog.oDialog.remove())}}),ES.MapView.FrameTab=ES.Evented.extend({oOption:{bIsIframe:!0,nTick:600,nHideTick:150},oParam:null,nFlag:0,initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.initUI(),this.$_oDivVehContent=$(".ex-layout-cardetail-content.veh-other-info"),this.$_oDivVehDetailTitle=$(".ex-theme-cardetail-title"),this.$_oDivVehDetail=$(".ex-layout-cardetail"),this.initOn(),this.initObj(),this.initEvent()},initEvent:function(){var e=this;$(".ex-layout-cardetail-close.ec-close").eq(0).bind("click",this,function(){e._oParent.setBtn0(),e._oParent.fire("MapView:VehDetail.hideTrack"),e._oParent.fire("MapView:Map.setMapConterH",{nH:0,nTick:150})}),$(".ex-layout-cardetail-close.ec-close").eq(1).bind("click",this,function(){e._oParent.setBtn2(),e._oParent.fire("MapView:TrackLst.hideTrack"),e._oParent.fire("MapView:Map.setMapConterH",{nH:40,nTick:150})}),$(".ex-layout-cardetail-close.ec-close").eq(2).bind("click",this,function(){e._oParent.setBtn1(),e._oParent.fire("MapView:TrackLst.reShowTrack")})},initObj:function(){this.oVehDetail=new ES.MapView.VehDetail(this,{})},initOn:function(){this._oParent.on("MapView:VehDetail.showDetail",this.showDetail,this),this._oParent.on("MapView:VehDetail.switchDetail",this.switchDetail,this),this._oParent.on("MapView:VehDetail.showTrack",this.showTrack,this),this._oParent.on("MapView:VehDetail.reShowTrack",this.reShowTrack,this),this._oParent.on("MapView:VehDetail.hideTrack",this.hideTrack,this)},initUI:function(){var e=$(this.cHtml);$(".ex-layout-content").append(e),this.$_oContainer=e,this.$_oContainer.show()},hideTrack:function(){var e=this;this.$_oDivVehDetail.animate({height:"100%",bottom:"-100%"},e.oOption.nHideTick),this.nFlag=0},reShowTrack:function(){var e=this;this.$_oDivVehDetail.animate({height:"100%",bottom:"0"},e.oOption.nTick)},switchDetail:function(e){this.oParam=e.oGpsInfo,$(".ex-theme-cardetail-title>span").html('<i class="ec-icon-truck"></i>  '+e.oGpsInfo.vehNo),this.oVehDetail.loadPage(e)},showDetail:function(e){if(this.oParam=e.oGpsInfo,$(".ex-theme-cardetail-title>span").html('<i class="ec-icon-truck"></i>  '+e.oGpsInfo.vehNo),1==this._oParent.getDetailStatus())return this.oVehDetail.loadPage(e),void this.$_oDivVehDetail.animate({height:"100%",bottom:"0"},this.oOption.nTick);this.$_oDivVehDetail.animate({height:"100%",bottom:"0"},this.oOption.nTick),this.oVehDetail.loadPage(e),this._oParent.setBtn0()},showTrack:function(e){$("ul.ec-avg-sm-12").hide();var t=this;this.$_oDivVehDetail.animate({height:"100%",bottom:"0"},t.oOption.nTick),setTimeout(function(){t.$_oDivVehContent.show(),t.$_oDivVehContent.css({width:"100%",overflow:"hidden",height:$(".ex-layout-cardetail").height()-40}).html(t.getContent(e))},t.oOption.nTick),$(".ex-theme-cardetail-title>span").html('<i class="ec-icon-truck"></i>  '+e.oGpsInfo.vehNo),this._oParent.setBtn0()},getContent:function(e){if(this.oOption.bIsIframe){return'<iframe src="/MapMonitor/TrackView?PhoneNum='+e.oGpsInfo.devNo+"&VehicleNo="+e.oGpsInfo.vehNo+'" name="MainFrame" id="MainFrame"  frameborder="0" style="width:100%; height:100%; margin:0; padding:0; overflow:hidden;" allowfullscreen mozallowfullscreen webkitallowfullscreen></iframe>'}return $("#TempTrackView").html()}}),ES.MapView.FrameTab.include({cHtml:'<div id="MapShowDetail" class="ex-layout-cardetail ex-theme-cardetail">   <a href="javascript:void(0);" class="ex-layout-cardetail-close ec-close">&times;</a>   <a href="javascript:void(0);" class="ex-layout-cardetail-close  ec-close ec-btn-sm ex-btn-close-down" style="color:#fff;display:none">       <i class="ec-icon-arrow-down"></i>   </a>   <a href="javascript:void(0);" class="ex-layout-cardetail-close  ec-close ec-btn-sm ex-btn-close-up" style="color:#fff;display:none">       <i class="ec-icon-arrow-up"></i>   </a>   <h4 class="ex-theme-cardetail-title">       <span>车辆实时状况</span>       <ul class="ec-avg-sm-6">           <li class="ec-active" >实时状态</li>           <li>车辆详情</li>           <li>企业信息</li>           <li>审批路线</li>            <li>运输过程</li>            <li>设备控制</li>            <li>变更信息</li>            <li>违法记录</li>            <li>设备信息</li>            <li>安装信息</li>            <li>统计分析</li>        </ul>   </h4>       <div class="ex-layout-cardetail-content veh-other-info"></div>       <div class="ex-layout-cardetail-content veh-real-status">       <div class="ec-g ex-car-state">           <div class="ec-u-md-4">               <div class="stats-card">                   <h4><i class="ec-icon-map-marker"></i>&nbsp;当前位置</h4>                   <ul class="ec-avg-md-2">                       <li>经度：35.09453242° </li>                       <li>纬度：115.09453242°</li>                       <li>高度：350m</li>                       <li>方向：东南</li>                       <li>横向偏差：3m</li>                       <li>航向角偏差：35°</li>                   </ul>                   <p>湖北省;武汉市;江夏区,距离武汉大学科技园停车场83米</p>                   <p> 最后记录时间：2016-04-07 10:25:08[10小时前]</p>               </div>               <div class="stats-card">                   <h4><i class="ec-icon-dashboard"></i>&nbsp;实时状态</h4>                   <ul class="ec-avg-md-5 ex-acc">                       <li><a href="javascript:void(0);" class="icon-acc icc-01 warning" cId ="1" title="ACC"></a><p>ACC</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-02" cId ="11"  title="左转"></a><p>左转</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-03" cId ="12"  title="右转"></a><p>右转</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-04" cId ="14"   title="近光"></a><p>近光</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-05" cId ="13" title="远光"></a><p>远光</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-06" cId ="10"   title="刹车"></a><p>刹车</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-07" cId ="cz" title="超载"></a><p>超载</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-08 s_60" cId ="cs" title="超速"></a><p>超速</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-09"  cId ="7"  title="断油路"></a><p>断油路</p></li>                       <li><a href="javascript:void(0);" class="icon-acc icc-10"  cId ="OilLinetemp"  title="车身密闭"></a><p>车身密闭</p></li>                   </ul>               </div>           </div>           <div class="ec-u-md-8">               <div class="truck_box">                   <div id="echartsSpeed" class="echarts_box speed"></div>                   <div class="ex-layout-mobile">                       <i class="ex-icon-16 ex-icon-mobile on"></i>                       <i class="ex-icon-16 ex-icon-bd"></i>                   </div>               </div>               <a href="javascript:void(0);" class="ec-btn ec-btn-primary ec-btn-sm ec-radius ex-btn-track"><i class="ec-icon-street-view"></i>&nbsp;&nbsp;历史轨迹</a>           </div>       </div>       <div class="ec-g echart_grid" >           <ul class="ec-avg-sm-2">               <li>                   <div class="stats-card">                       <h4>                           <i class="ec-icon-tachometer"></i>&nbsp;超速分析                           <a href="javascript:void(0);" class="ec-btn ec-btn-link ex-expand "><i class="ec-icon-expand"></i></a>                           <a href="javascript:void(0);" class="ec-btn ec-btn-link ex-compress "><i class="ec-icon-compress"></i></a>                       </h4>                       <div id="speedGridEchart" class="ex-map-car-live"></div>                   </div>               </li>               <li>                   <div class="stats-card">                       <h4>                           <i class="ec-icon-video-camera"></i>&nbsp;实时监控                           <a href="javascript:void(0);" class="ec-btn ec-btn-link ex-expand "><i class="ec-icon-expand"></i></a>                           <a href="javascript:void(0);" class="ec-btn ec-btn-link ex-compress "><i class="ec-icon-compress"></i></a>                       </h4>                       <div id="mCarLiveView" class="ex-map-car-live">                           <div class="ex-layout-maptool ex-theme-maptool ex-map-top ex-map-left"> </div>                           <div class="ex-layout-maptool ex-theme-maptool ex-map-top ex-map-right"> </div>                       </div>                   </div>               </li>           </ul>       </div>       <div class="ec-g ex-theme-cardetail-warning">           <div class="stats-card">               <h4><i class="ec-icon-warning"></i>&nbsp;实时报警</h4>               <div id="dtAlarmGridContainer" class="dt-grid-container" style="width:100%;"></div>               <div id="dtAlarmGridToolBarContainer" class="dt-grid-toolbar-container"></div>               <div style="clear:both;"></div>           </div>       </div>   </div>    </div>'}),ES.MapView.VehDetail=ES.Class.extend({oMenuConfig:{li:[{class:"ec-active","data-band":"VehInfo:RealStatus.loadDetailView","menu-flag":"VehicleState",span:{html:"实时状态"}}]},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._oPage=this._oParent._oParent,this.$_oDivVehContent=$(".ex-layout-cardetail-content"),this.$_oDivVehDetailTitle=$(".ex-theme-cardetail-title"),this.$_oDivVehDetail=$(".ex-layout-cardetail"),this.$_oTab=$("ul.ec-avg-sm-6"),this.initUI(),this.initTabObj(),this.initOn(),this.hideContent()},hideContent:function(){$(".ex-layout-cardetail-content").hide()},initUI:function(){this.$_oTab.empty(),ES.initTag(this.$_oTab,this.oMenuConfig);var e=this;this._oParent._oParent.AuthValue(this._oParent.oOption.MapViewAuthDetail,this.$_oTab),this.$_oTab.find("li").bind("click",this,function(){$(this).siblings().removeClass("ec-active"),$(this).addClass("ec-active"),e.oParam&&e._loadPage($(this))})},initTabObj:function(){this.aoTabObj=[new ES.VehInfo.RealStatus(this,{}),new ES.VehInfo.VehInfoView(this,{cPageUrl:"/MapView/VehicleInfo",cOnLoadEven:"VehInfo:RealStatus.loadVehInfoView"}),new ES.VehInfo.VehInfoView(this,{cPageUrl:"/MapView/CompanyInfo",cOnLoadEven:"VehInfo:RealStatus.loadCompanyView"}),new ES.VehInfo.ExamineLine(this,{cPageUrl:"/MapView/LineInfo",cOnLoadEven:"VehInfo:RealStatus.loadCheckLine"}),new ES.VehInfo.VehInfoView(this,{cPageUrl:"/MapView/Command",cOnLoadEven:"VehInfo:RealStatus.loadSetControl"}),new ES.VehInfo.TripLine(this,{cPageUrl:"/MapMonitor/TripLineView",cOnLoadEven:"VehInfo:RealStatus.loadLineInfoView"}),new ES.VehInfo.VehChangeHis(this,{cPageUrl:"/MapMonitor/_VehChangeHis",cOnLoadEven:"VehInfo:RealStatus.VehChangeHis"}),new ES.VehInfo.DevInfo(this,{cPageUrl:"/MapMonitor/_PartialMapDevice",cOnLoadEven:"VehInfo:RealStatus.DevInfo"}),new ES.VehInfo.IllegalInfo(this,{cPageUrl:"/Illegal/_IllegalLstForVehNo",cOnLoadEven:"VehInfo:RealStatus.IllegalInfo"})]},initOn:function(){this._oPage.on("HubSvr:setGpsInfo",this.setHubGpsInfo,this),this._oPage.on("HubSvr:setSingleAlarmInfo",this.setAlarmInfo,this)},setHubGpsInfo:function(e){var t=this.aoTabObj[0];t&&t.setHubGpsInfo(e)},setAlarmInfo:function(e){var t=this.aoTabObj[0];t&&t.setHubGpsInfo(e)},loadPage:function(e){this.oParam?(this.oParam=e,this.oParam.oGpsInfo.devNo!==e.oGpsInfo.devNo&&this._oParent.fire("HubSvr:HubMange.addAlarmHub",{oGpsInfo:e.oGpsInfo})):this.oParam=e,this.$_oTab.show(),this.hideContent();var t=this.$_oDivVehDetailTitle.find("ul>li.ec-active"),i=t.index();if(!(i<0)){var a=this.aoTabObj[i];"1"==t.attr("bIsLoad")?a.switchDetailView(e):(a.loadDetailView(e),t.attr("bIsLoad",1))}},_loadPage:function(e){this.hideContent();var t=e.index();if(!(t<0)){var i=this.aoTabObj[t];"1"==e.attr("bIsLoad")?i.switchDetailView(this.oParam):(i.loadDetailView(this.oParam),e.attr("bIsLoad",1))}}}),ES.VehInfo=ES.Class.extend({version:"0.1",loadDetailView:function(){},switchDetailView:function(){}}),ES.VehInfo.RealStatus=ES.VehInfo.extend({includes:ES.Mixin.Events,oOption:{cTagGpsInfo:".ec-g > .ec-u-md-4 > .stats-card > ul.ec-avg-md-2",cTagVehStatusInfo:".ec-g > .ec-u-md-4 > .stats-card > ul.ex-acc",cTagMobileInfo:".ex-layout-mobile",cSpeedChartId:"echartsSpeed",cSpeed:""},loadDetailView:function(e){this.$_oContent.show(),this.oSpeedChart=new ES.VehInfo.SpeedChart(this,{}),this.oAlarmGrid=new ES.VehInfo.AlarmGridLst(this,{}),this.oMapMonitor=new ES.VehInfo.MapMonitor(this,{oMapOption:{zoomControl:!1,layers:[],center:new L.LatLng(30.697875,111.293275),zoom:13,attributionControl:!1},cDidId:"mCarLiveView"});var t=this.$_oContent.find("ul.ex-acc>li[cId="+ES.MapView.oConfig.carMask+"]");!t||t.length<=0?this.oSpeedLineChart=new ES.VehInfo.SpeedLineChart(this,{}):this.oSpeedLineChart=new ES.VehInfo.SpeedDoorLineChart(this,{}),this.bIsLoad=!0,this.switchDetailView(e),this.initEven(),this.oSpeedLineChart.reflesh(),this.oMapMonitor.reflesh()},setGpsInfo:function(e){e||(e=this.oGpsInfo);var t=ES.TrackHelper.getDateMsg(e.gpsTime);$(this.oOption.cTagGpsInfo).empty();var i="<li>状态： "+(e.sta||"通讯中断")+" </li><li>速度： "+e.speed+" Km/h</li>";$(this.oOption.cTagGpsInfo).html(i),$(this.oOption.cTagGpsInfo).parent().find("p").eq(0).html("最后记录位置："+e.poi),$(this.oOption.cTagGpsInfo).parent().find("p").eq(1).html("最后记录时间："+e.gpsDate.substr(0,19).replace("T"," ")+t),$(this.oOption.cTagGpsInfo).parent().find("p").eq(2).html("最后记录状态："+e.sta)},setVehStatusInfo:function(e){if(e.status){$(this.oOption.cTagVehStatusInfo).parent().show(),$(this.oOption.cTagVehStatusInfo).find("a").removeClass("on"),$(this.oOption.cTagVehStatusInfo).find("a>span").text("关");var t=e.status;for(var i in t){var a=$('a[cId="'+t[i]+'"]');(a||a.length>0)&&(a.addClass("on"),a.find("span").text("开"))}$.inArray(15,t)<0?$(".car-cover").animate({left:"0px"},500):$(".car-cover").animate({left:"-360px"},500)}},setVehLight:function(e){if(e&&e.attach){$(".car-light").removeClass("l-green").removeClass("l-red").removeClass("l-yellow").removeClass("l-gray"),$('a[cId="cz"]').removeClass("green").removeClass("warning").removeClass("yellow"),ES.TrackHelper.convertVehStatus(e);var t="";e.nGreenOn+e.nRedOn+e.nYelloOn!=1?t="l-gray":1==e.nGreenOn?(t="l-green",$('a[cId="cz"]').addClass("green")):1==e.nRedOn?(t="l-red",$('a[cId="cz"]').addClass("warning")):(t="l-yellow",$('a[cId="cz"]').addClass("yellow")),$(".car-light").addClass(t)}},setMobileInfo:function(e){var t=$(".ex-icon-mobile"),i=$(".ex-icon-bd");t.removeClass("on").removeClass("off"),i.removeClass("on").removeClass("off"),"行驶"==e.currentState||"停车"==e.currentState||"熄火"==e.currentState?(t.addClass("on"),i.addClass("on")):"通讯中断"==e.currentState?(t.addClass("l-mobile-off"),i.addClass("l-bd-off")):"定位失败"==e.currentState?(t.addClass("on"),i.addClass("off")):(t.addClass("off"),i.addClass("off"))},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.$_oContent=$(".ex-layout-cardetail-content.veh-real-status"),this.bIsLoad=!1,this.initUI(),this.initOn()},initEven:function(){var e=this;$(".ex-expand").bind("click",function(){var t=$(this).closest(".stats-card");t.addClass("expand").find(".ex-map-car-live").css({width:t.width()+"px",height:t.height()-33+"px"}),$(this).hide(),t.find(".ex-compress").show(),$(".ex-layout-content").css("z-index","3"),e.oMapMonitor.reflesh(),e.oSpeedLineChart.reflesh()}),$(".ex-compress").bind("click",function(){var t=$(this).closest(".stats-card");t.removeClass("expand").find(".ex-map-car-live").css({width:t.width()+"px",height:"100%"}),$(this).hide(),t.find(".ex-expand").show(),$(".ex-layout-content").css("z-index","1"),e.oMapMonitor.reflesh(),e.oSpeedLineChart.reflesh()}),$(window).resize(function(){e.oMapMonitor.reflesh(),e.oSpeedLineChart.reflesh()})},initOn:function(){},setAlarmInfo:function(e){!e||!e.aoAlarmInfo||e.aoAlarmInfo.length<=0||this.oAlarmGrid&&this.oAlarmGrid.addAlarm(e.aoAlarmInfo)},setHubGpsInfo:function(e){if(e&&e.oData&&!(e.oData.length<=0)){var t=this;if(t.oGpsInfo){var i=this._oParent._oPage.toHeartModle(this._oParent._oPage.getVstatus(e.oData));$.each(i,function(e,i){i.devNo==t.oGpsInfo.devNo&&(void 0===i.vehNo&&(i.vehNo=t.oGpsInfo.vehNo,i.entName=t.oGpsInfo.entName),ES.TrackHelper.convertVehStatus(i),t.setVehGpsStatus({oGpsInfo:i}))})}}},switchDetailView:function(e){if(this.bIsLoad){this.$_oContent.show();var t={};t=e&&e.oGpsInfo?e.oGpsInfo:this.clearVehInfo(),this.oGpsInfo=t,this.setVehGpsStatus(e),this.oAlarmGrid.swithAlarmData(e.oGpsInfo),this.oMapMonitor.setGpsInfo(e.oGpsInfo),this.setBtnTrackEven(e)}},setVehGpsStatus:function(e){this.setGpsInfo(e.oGpsInfo),this.setVehStatusInfo(e.oGpsInfo),this.setVehLight(e.oGpsInfo),this.setMobileInfo(e.oGpsInfo),this.oSpeedChart.changeSpeed(e.oGpsInfo),this.oSpeedLineChart.changeSpeedLine(e.oGpsInfo),this.oMapMonitor.setHubGpsInfo(e.oGpsInfo)},clearVehInfo:function(){return{vehNo:"",devNo:"",latLng:null,gpsDate:"2017-01-01",dir:0,poi:"",speed:0,status:{Acc:1,Located:2,LatInfo:3,LonInfo:4,BusinessStatus:5,LonLatEncrypt:6,OilLine:7,ElectricCircuit:8,DoorLock:9,Breaking:10,LeftTurn:11,RightTurn:12,DistanceLight:13,LowLight:14,FrontDoor:15,BackDoor:16,Engine:17,AirCondition:18,Vibration:19,Horn:20},attach:{ZtLeightYelloOn:0,ZtLeightGreenOn:0,ZtLeightRedOn:0},currentState:"",mile:0,gpsTime:0,img:"/Asset/img/ex_default/law_144.png",CompanyName:"",sWeightValue:0}},setBtnTrackEven:function(e){$(".ex-btn-track").unbind("click"),$(".ex-btn-track").bind("click",function(){window.open("/mapViewHtml/html/trackview.html?token="+ES.MapView.oConfig.token+"&PhoneNum="+e.devNo+"&VehicleNo="+e.vehNo)})},initUI:function(){this.$_oContent.css({width:"100%",height:$(".ex-layout-cardetail").height()-40,overflow:"auto","background-color":"#fff"})}}),ES.VehInfo.SpeedChart=ES.Class.extend({oOption:{cDivContain:"echartsSpeed",nAvgSpeed:60,nMaxSpeed:100},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.oChart=null,this.oChartOption=null,this.initChart()},initChart:function(){this.oChart=echarts.init(document.getElementById(this.oOption.cDivContain)),this._setChartConfig()},_setChartConfig:function(e){var t=this.oOption.nAvgSpeed/this.oOption.nMaxSpeed;this.oChartOption={backgroundColor:"#b68500",tooltip:{formatter:"{a} <br/>{c}km/h"},grid:{top:0,left:0,right:0,bottom:0},series:[{name:"速度",type:"gauge",radius:"100%",min:0,max:this.oOption.nMaxSpeed,splitNumber:11,axisLine:{lineStyle:{width:10,color:[[t,"#e2f4e0"],[1,"#ffc09d"]]}},axisTick:{length:15,lineStyle:{color:"auto"}},splitLine:{length:20,lineStyle:{color:"auto"}},axisLabel:{show:!1},title:{show:!1},detail:{formatter:"速度\n{value}km/h",offsetCenter:[0,"45%"],textStyle:{color:"#fff",fontSize:16,fontWeight:"bold"}},data:[{value:80,name:"速度"}]}]},this.oChartOption={backgroundColor:"#136635",tooltip:{formatter:"{a} <br/>{c}km/h"},grid:{top:0,left:0,right:0,bottom:0},series:[{name:"速度",type:"gauge",radius:"90%",min:0,max:this.oOption.nMaxSpeed,splitNumber:5,axisLine:{lineStyle:{width:3,color:[[t,"#72d572"],[1,"#f4511e"]]}},axisTick:{length:6,lineStyle:{color:"auto"}},splitLine:{length:9,lineStyle:{color:"auto"}},axisLabel:{show:!1},title:{show:!1},detail:{formatter:"速度\n{value}km/h",offsetCenter:[0,"45%"],textStyle:{color:"#fff",fontSize:12,fontWeight:"bold"}},data:[{value:80,name:"速度"}]}]},this.oChart.setOption(this.oChartOption,!0)},changeSpeed:function(e){this.oChartOption.series[0].data[0].value=e.speed,this.oChart.setOption(this.oChartOption,!0)},clearChart:function(){this.oChart&&this.oChart.clear()}}),ES.VehInfo.VehInfoView=ES.VehInfo.extend({oOption:{cPageUrl:"/MapMonitor/VehInfoView",cOnLoadEven:"VehInfo:RealStatus.loadVehInfoView",cOnSwitchVehInfoView:"VehInfo:RealStatus.switchVehInfoView"},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.$_oContent=$(".ex-layout-cardetail-content.veh-other-info"),this.initUI(),this.initOn()},initOn:function(){},loadDetailView:function(e){this.$_oContent.show(),this.$_oContent.load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo})},switchDetailView:function(e){this.loadDetailView(e)},initUI:function(){this.$_oContent.css({width:"100%",height:$(".ex-layout-cardetail").height()-40,overflow:"auto"})}}),ES.VehInfo.ExamineLine=ES.VehInfo.VehInfoView.extend({loadDetailView:function(e){$(".ex-layout-cardetail-content.veh-other-info").load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo},function(e){}).show()}}),ES.VehInfo.TripLine=ES.VehInfo.VehInfoView.extend({loadDetailView:function(e){$(".ex-layout-cardetail-content.veh-other-info").load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo},function(e){}).show()}}),ES.VehInfo.VehChangeHis=ES.VehInfo.VehInfoView.extend({loadDetailView:function(e){$(".ex-layout-cardetail-content.veh-other-info").load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo},function(e){}).show()}}),ES.VehInfo.DevInfo=ES.VehInfo.VehInfoView.extend({loadDetailView:function(e){$(".ex-layout-cardetail-content.veh-other-info").load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo},function(e){}).show()}}),ES.VehInfo.IllegalInfo=ES.VehInfo.VehInfoView.extend({loadDetailView:function(e){$(".ex-layout-cardetail-content.veh-other-info").load(this.oOption.cPageUrl,{devNo:e.oGpsInfo.devNo,vehNo:e.oGpsInfo.vehNo},function(e){}).show()}}),ES.VehInfo.WeightChart=ES.Class.extend({oOption:{cDivContain:"echartsWeight",nAvgSpeed:60,nMaxSpeed:100},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.initUI()},initUI:function(){this.oChart=echarts.init(document.getElementById(this.oOption.cDivContain)),this._setChartConfig()},_setChartConfig:function(e){this.oOption.nAvgSpeed,this.oOption.nMaxSpeed;this.oChartOption={backgroundColor:"#136635",tooltip:{formatter:"{a} <br/>{c}"},grid:{top:0,left:0,right:0,bottom:0},series:[{name:"载重",type:"gauge",radius:"90%",min:0,max:30,splitNumber:5,axisLine:{lineStyle:{width:3,color:[[.1,"#fff"],[.6,"#00ff00"],[.8,"#f5c01b"],[1,"#b62d22"]]}},axisTick:{length:6,lineStyle:{color:"auto"}},splitLine:{length:9,lineStyle:{color:"auto"}},axisLabel:{show:!1},title:{show:!1},detail:{formatter:"载重\n{value}",offsetCenter:[0,"45%"],textStyle:{color:"#fff",fontSize:12,fontWeight:"bold"}},data:[{value:80,name:"速度"}]}]},this.oChart.setOption(this.oChartOption,!0)},changeWeight:function(e){if(e){ES.TrackHelper.convertVehStatus(e);var t=100,i=parseInt(e.dWeight)||0;e.attach&&(e.nGreenOn+e.nRedOn+e.nYelloOn!=1?(t=100*i/5,"空载"):1==e.nGreenOn?(t=100*i/50,"装载"):1==e.nYelloOn?(t=100*i/70,"满载"):(t=100*i/90,"超载")),this.oChartOption.series[0].max=t||100,e.attach?this.oChartOption.series[0].data[0].value=e.dWeight||0:this.oChartOption.series[0].data[0].value=0,this.oChart.setOption(this.oChartOption,!0)}}}),
ES.VehInfo.AlarmGridLst=ES.Class.extend({oOption:{cDivContain:"dtAlarmGridContainer",cPager:"dtAlarmGridToolBarContainer",nTop:600,cTagAlarm:".ex-theme-cardetail-warning >.stats-card"},initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this._aoData=[],this.oAlarmData={},this.initGrid()},initGrid:function(){var e={lang:"zh-cn",ajaxLoad:!1,check:!1,exportFileName:"告警列表",datas:this._aoData,columns:this.getColumns(),gridContainer:this.oOption.cDivContain,toolbarContainer:this.oOption.cPager,tools:"",pageSize:30,pageSizeLimit:[10,20,30,50]},t=$.fn.DtGrid.init(e);this.dtGrid=t,$("#"+this.oOption.cDivContain).height(200),t.reload(!1)},getColumns:function(){return[{id:"VehicleNo",title:"车牌号",type:"string",columnClass:"text-center"},{id:"CompanyName",title:"所属企业",type:"string",columnClass:"text-center",width:100},{id:"AlarmTypeStr",title:"报警描述",type:"string",columnClass:"text-center"},{id:"StartAlarmTime",title:"报警开始时间",type:"string",columnClass:"text-center"},{id:"EndAlarmTime",title:"报警结束时间",type:"string",columnClass:"text-center"},{id:"Address",title:"最后报警位置",type:"string",columnClass:"text-center"}]},swithAlarmData:function(e){this.clearGrid(),this.oGpsInfo=e;e.devNo,parseInt(((new Date).getTime()-18e6)/1e3),parseInt((new Date).getTime()/1e3)},vehAlarmHandler:function(e){if(e&&e.dataList&&!(e.dataList.length<=0)&&this.oGpsInfo.devNo===e.dataList[0].PhoneNum){for(var t=0;t<e.dataList.length;t++)e.dataList[t].Address=e.dataList[t].EndPoi.Address;$.merge(this._aoData,e.dataList),this.dtGrid.reload(!0)}},addAlarm:function(e){if(e){for(var t in e)this._aoData.unshift(e[t]),this._aoData.length>=this.oOption.nTop&&this._aoData.splice(this.oOption.nTop,1);this.dtGrid.reload(!0)}},clearGrid:function(){!this._aoData||this._aoData.length<=0||(this._aoData.splice(0,this._aoData.length),this.dtGrid&&this.dtGrid.reload(!0))}}),ES.VehInfo.MapLive=ES.MapView.MapLive.extend({oPopOption:{maxWidth:500},_getVecMarkerHtml:function(e){var t=ES.TrackHelper.getDire(e.dir),i=ES.TrackHelper.getDateMsg(e.gpsTime),a={};ES.extend(a,e,{cMsg:i,cDir:t,Mileage:e.mile,cGpsDate:ES.Util.dateFormat(e.gpsTime,"yyyy-MM-dd hh:mm:ss"),cVehicleStatus:e.currentState||"通讯中断",cPoiInfo:e.poi||"",map:"通讯中断"===e.currentState||"定位失败"===e.currentState?"off":"on",key:"1"===e.status[0]?"on":"",open:"1"===e.status[1]?"on":"",signal:"通讯中断"!==e.currentState?"on":""});var o='<div class="ex-maptip-wtm">    <div class="ex-maptip-wtm-content">       <div class="ex-content-info-box">            <div class="ex-content-info-car ec-u-sm-6">               <h3>{vehNo}</h3>               <div class="ex-content-img"><img src="../img/login_bg_06.jpg" alt="" /></div>               <ul>                   <li><i class="ec-icon-car"></i><span>企业名称</span></li>               </ul>           </div>           <div class="ex-content-info-state ec-u-sm-6">               <ul>                   <li><span>{cGpsDate}{cMsg}</span></li>                   <li><strong>状态：</strong><span>{cVehicleStatus}</span></li>                   <li><strong>速度：</strong><span>{speed} (Km/h)</span></li>                   <li><strong>里程：</strong><span>{Mileage} Km</span></li>                   <li><strong>位置：</strong><span>{cPoiInfo}</span></li>               </ul>           </div>       </div>   </div>   <div class="ex-maptip-wtm-tool">       <ul class="tool-btn ec-avg-sm-3 ec-u-sm-6">        </ul>       <ul class="tool-state ec-avg-sm-4 ec-u-sm-6">           <li><i class="GPS {map}"></i></li>           <li><i class="signal {signal}"></i></li>        </ul>   </div></div>',o=ES.Util.template(o,a);return o},weightStatus:function(e,t){return e||(e=0),parseInt(e)<=1?"空载":$.inArray(15,t)>=0?"超载":"满载"},_initOn:function(){},_drawLive:function(){if(this._oLivePosGroup){var e=this.oGpsInfo,t=this.findLayer(this._oLivePosGroup,e.devNo),i=e.latLng,a=this._getVecMarkerHtml(e);return t?(t.setLatLng(i),this._updateVecMarkerPop(t,a)):(this.clearLiveTrack(),t=this._createLive(e),t.addTo(this._oLivePosGroup),t.bindPopup(a,this.oPopOption),this.oLayer=t),this._oMap.panTo(i),t._bringToFront(),this._setHeading(e,180),t}},_drawLiveHis:function(){var e=this.oGpsInfo,t=null,i=this.findLayer(this._oLineGroup,e.devNo);if(i)t=i.oPrePosInfo,i.oPrePosInfo=e,i.addLatLng(e.latLng);else{var a=L.polyline([e.latLng],ES.MapView.oConfig.oLiveLineConfig);a.cId=e.devNo,a.oPrePosInfo=e,a.addTo(this._oLineGroup)}if(t){var o=L.circleMarker(t.latLng,ES.MapView.oConfig.oLiveCircleMarkerConfig),n=this._getVecMarkerHtml(t);o.bindPopup(n,this.oPopOption),o.oGpsInfo=t;o.getPopup().oGpsInfo=t,this.initPopup(o),o.addTo(this._oTrackGroup)}},initPopup:function(e){var t=this._getVecMarkerHtml(e.oGpsInfo),i=e.getPopup();return i||(i=e.bindPopup(t,this.oPopOption).getPopup()),i.oGpsInfo=e.oGpsInfo,i.setContent(t),e.oGpsInfo.bOpenBubble?e.openPopup():e.closePopup(),i}}),ES.VehInfo.MapMonitor=L.MapLib.MapMaster.Map.extend({oGpsInfo:null,initialize:function(e,t){ES.extend(t,{nMapHeight:300}),L.MapLib.MapMaster.Map.prototype.initialize.call(this,e,t),this.loadCtrl()},loadCtrl:function(){this.loadMapMaster(),new L.MapLib.MapControl.ESMapTile(this,{acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-right"]})},setGpsInfo:function(e){e&&e.hasOwnProperty("devNo")&&(this.oGpsInfo&&this.oGpsInfo.devNo==e.devNo||(this.oGpsInfo=e,this.oMapLive&&(this.oMapLive.offEven(),this.oMapLive.clearLiveTrack(),delete this.oMapLive),this.oMapLive=new ES.VehInfo.MapLive(this._oParent,{},this._oMap),e.bOpenBubble=!1,this.oMapLive.drawLiveTrack({oGpsInfo:e})))},setHubGpsInfo:function(e){if(e&&this.oMapLive){this.oMapLive.drawLiveTrack({oGpsInfo:e});this._oMap.getBounds()}},_loadMap:function(){var e=L.DomUtil.get(this.options.cDidId),t=(this.options.nMapWidth,this.options.nMapHeight);if(!e){var i=L.DomUtil.get(this.options.cDivContainerId);if(!i)throw new Error(L.MapLib.MapMaster.Err[2]);e=L.DomUtil.create(this.cDiv,"",i)}e.style.height=t+"px",e.id=this.options.cDidId,L.Util.extend(this.options.oMapOption,{layers:[this._oDefaultTile]});var a=this._oMap=new L.Map(this.options.cDidId,this.options.oMapOption);return this._oParent&&(this._oParent.setMap&&this._oParent.setMap(a),this._oParent.fire("Map:loadFinish",{oMap:a}),this.fire("Map:loadFinish",{oMap:a})),a}}),ES.VehInfo.SpeedLineChart=ES.Class.extend({oOption:{cDivContain:"speedGridEchart",nMaxCnt:30},_aoSpeed:[],_aoDoor:[],_aoDate:[],initialize:function(e,t){ES.setOptions(this,t),this._oParent=e,this.oChart=null,this.oChartOption=null,this.initChart()},initChart:function(){this.oChart=echarts.init(document.getElementById(this.oOption.cDivContain)),this._setChartConfig()},_setChartConfig:function(e){this.oChartOption={color:["#72d572","#29b6f6"],tooltip:{trigger:"axis",formatter:function(e){return e[0].name+"<br/>"+e[0].seriesName+" : "+e[0].value+" (km/h)<br/>"},axisPointer:{animation:!1}},legend:{data:["速度"]},grid:{bottom:"10%"},xAxis:{type:"category",boundaryGap:!1,data:[]},yAxis:[{name:"速度(km/h)",type:"value",max:100}],series:[{name:"速度",type:"line",data:[],hoverAnimation:!1,smooth:!0,areaStyle:{normal:{}},lineStyle:{normal:{width:1}}}]},this.oChart.setOption(this.oChartOption,!0)},setData:function(e){e&&(this.oGpsInfo&&this.oGpsInfo.devNo!==e.devNo&&(this._aoSpeed.splice(0,this._aoSpeed.length),this._aoDoor.splice(0,this._aoDoor.length),this._aoDate.splice(0,this._aoDate.length)),this.oGpsInfo=e)},setSeriesData:function(e){if(e){this._aoSpeed.push(e.speed||0);var t=0;t=e.Status&&!0===e.Status.FrontDoor?1:0,this._aoDoor.push(t),this._aoDate.push(ES.Util.dateFormat(e.gpsTime||0,"hh:mm:ss")),this._aoSpeed.length>this.oOption.nMaxCnt&&(this._aoSpeed.splice(0,1),this._aoDoor.splice(0,1),this._aoDate.splice(0,1))}},changeSpeedLine:function(e){this.setData(e),this.setSeriesData(e),this.oChartOption.series[0].data=this._aoSpeed,this.oChartOption.xAxis.data=this._aoDate,this.oChart.setOption(this.oChartOption,!0)},reflesh:function(){this.oChart.resize()},clearChart:function(){this.oChart&&this.oChart.clear()}}),$(function(){function e(e,t){if(r._oMap){var i=r._oMap.getContainer();e&&(i.style.width=e+"px"),t&&(i.style.height=t+"px"),r._oMap.invalidateSize({animate:!0,pan:!1,debounceMoveend:!1})}}var t=$(window).height(),i=$(window).width()-260,a=ES.Util.getArgs(),o="http://api.bdlbs.comlbs.com";ES.MapView.oConfig={mainCenter:{lat:30.2323,lng:115.868897},deptTree:{plugins:["types","search","unique","checkbox"],core:{animation:0,check_callback:!0,state:{opened:!0,checked:!0},data:function(e,t){var i=this,n={type:"POST",url:o+"/base/tree",headers:{token:a.token,"Content-Type":"application/json; charset=utf-8"},dataType:"json",data:'{"tree":"dept"}',success:function(e){e.detail[0].state={opened:!0,selected:!0},t.call(i,e.detail)},error:function(){t.call(i,null)}};$.ajax(n)}},checkbox:{tie_selection:!1}},token:a.token,FenceTree:{plugins:["types","search","unique","checkbox"],core:{animation:0,check_callback:!0,state:{opened:!0},data:{url:o+"/Enterprise/Tree"}},checkbox:{tie_selection:!1}},lineVehLstUrl:o+"/bb/map/mapview",vehLstUrl:o+"/bb/map/mapview",getFollowVeh:o+"/bb/map/UserVehicle",getFollowVehIds:o+"/bb/map/UserVehicle",getAlarmType:o+"/bb/map/UserAlarm",getVehsLoc:o+"/bb/base/vehicle/getVehicleData",curPosUrl:o+"/bb/map/GetLocByDeviceNo",followVehUrl:o+"/MapView/FollowVeh",unfollowVehUrl:o+"/MapView/UnfollowVeh",getVehsDetailLoc:o+"/MapView/GetVehsDetailLoc",getAlarmDetailPaing:o+"/MapView/AlarmTop5",getLineByIds:o+"/Line/GetLineByIds",mapAreaLocal:o+"/MapView/mapAreaLocal",AlarmVehLstUrl:o+"/MapView/QueryAlarmlVeh",nPagerBtnCnt:7,nMaxPageSize:10,oSiteConfig:{stroke:!0,color:"#0FFF05",dashArray:null,lineCap:null,lineJoin:null,weight:2,opacity:1,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0,smoothFactor:1,noClip:!1},oSuspicSiteConfig:{stroke:!0,color:"orange",dashArray:null,lineCap:null,lineJoin:null,weight:2,opacity:1,fill:!0,fillColor:"orange",fillOpacity:.2,clickable:!0,smoothFactor:1,noClip:!1},nMonitorCnt:1,carMask:15,carLight:1,echartsWeight:12,systemFlag:"truck"};var n=new ES.MapView.Page("MapView",{});new ES.MapView.Menu(n,{});var s=new ES.MapView.LayoutContent(n,{nWidth:i-220,nHeight:t});s.setWidth($(window).width()-440-40-80);var l=new L.MapLib.MapControl.Layout(n,{cDidId:"MapView"});l.addToolItem({cHTML:'<div class="ex-right-switch hidden"></div><div class="ex-right-switch open" style="display: none;"></div>'}),n.rightEvent();var r=new L.MapLib.MapMaster.Map(n,{cDidId:"MapView",oMapOption:{zoomControl:!1,layers:[],center:ES.MapView.oConfig.mainCenter,zoom:5,attributionControl:!1},oTileOption:{maxZoom:18,minZoom:3,attribution:'Map &copy;GB-20263—2018 <a href="http://www.exsun.cn">武汉依迅Exsun</a>'},nMapWidth:i,nMapHeight:t});r.loadMapMaster(),L.control.attribution({prefix:""}).addTo(r.getMap()),n.on("MapView:LayoutContent.resize",function(t){s.reflesh($(window).width()-440-40,$(window).height()),e(t.nWidth)}),n.on("MapView:Menu.resize",function(e){var t=$(window).width()-$(".ex-layout-sider:visible").width()-e.nWidth;s.setWidth(t),l.setWidth(t)}),new L.MapLib.MapControl.ESMapToolBox(r,{acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-right"]}),new L.MapLib.MapControl.ESMapTile(r,{acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-right"]}),new L.MapLib.MapControl.ESMapFull(r,{}),new ES.MapView.LiveMange(n,{}),new ES.MapView.VehClusterLayer(n,{}).getData(),new ES.MapView.SiteLayer(n,{}),new ES.MapView.FrameTab(n,{}),$(window).resize(function(){var t=$(window).height(),i=$(window).width()-440-40-80;if($(".ex-layout-menu").hasClass("ex-hidden")||$(".ex-layout-menu").hasClass("ex-hidden-sm"))var a=$(window).width();else var a=$(window).width()-$(".ex-layout-sider:visible").width()-40;e(a,t),s.reflesh(i,t),n.fire("window:resize")})})}(window,document,L,jQuery);